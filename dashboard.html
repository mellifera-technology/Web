<!DOCTYPE html>
<html lang="es">
<head> 
  <meta charset="utf-8" />
  <title>Panel — MIELLIFERA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="assets/logo.svg" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#0e0f12;--bg-soft:#13151a;--card:#171a21;--card-2:#1b1f27;
      --text:#eef0f3;--muted:#b8bec7;--border:#262b35;--zebra:#141820;
      --accent:#ffd54f;--accent-600:#f0c12c;--focus:#7fb3ff;
      --blue-ln:rgba(77,163,255,.45);--blue-pt:#4da3ff;
      --amber-ln:rgba(255,183,77,.55);--amber-pt:#ff7043;
      --ok:#49d17d;--warn:#ffb74d;--bad:#ff6b6b;--idle:#9aa3ad;
      --chip-bg:#10141a;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Arial;font-size:16.5px;line-height:1.6}
    .site{padding:24px;max-width:1200px;margin:0 auto}
    .header{position:sticky;top:0;background:rgba(14,15,18,.9);backdrop-filter:blur(6px);z-index:10;border-bottom:1px solid var(--border)}
    .nav-grid{display:grid;grid-template-columns:1fr auto auto;gap:16px;align-items:center;padding:12px 16px}
    .brand{color:var(--accent);text-decoration:none;font-weight:800}
    .nav-center a{color:#d6dae0;text-decoration:none;margin:0 10px}
    .cta{background:var(--accent);color:#111;border:0;padding:9px 14px;border-radius:10px;font-weight:700;cursor:pointer}

    .section{margin:28px auto}
    .section.alt{background:var(--bg-soft);border:1px solid var(--border);border-radius:14px;padding:16px}
    .section-head{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
    .split{display:grid;grid-template-columns:420px 1fr;gap:18px}
    @media(max-width:980px){.split{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
    .side-cards{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media(max-width:860px){.side-cards{grid-template-columns:1fr}}

    .pill{background:var(--accent);color:#111;border:2px solid var(--accent);border-radius:999px;font-weight:800;padding:8px 14px;white-space:nowrap}
    .btn{background:var(--card-2);color:var(--text);border:1px solid var(--border);padding:10px 16px;border-radius:10px;font-weight:600;cursor:pointer}
    .btn.yellow{background:var(--accent);border-color:var(--accent);color:#111}
    .btn.small{padding:6px 10px;font-size:.9rem}
    .center{display:flex;justify-content:center;align-items:center}
    .muted{color:var(--muted)}

    .cards-head{display:flex;justify-content:flex-end;align-items:center;margin:12px 0 6px}
    .cards-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
    @media(max-width:860px){.cards-grid{grid-template-columns:1fr}}

    table{border-collapse:separate;border-spacing:0;width:100%;background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    thead th{position:sticky;top:0;background:var(--accent);color:#111;font-weight:800;padding:10px;border-bottom:2px solid #caa332}
    tbody td{padding:10px;border-bottom:1px solid var(--border)}
    tbody tr:nth-child(odd){background:var(--zebra)}
    #tableWrap{box-shadow:0 1px 0 rgba(0,0,0,.2) inset}

    .reveal-wrap{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .eye-btn{background:#1d212a;border:1px solid var(--border);color:#cfd6df;border-radius:8px;cursor:pointer;padding:4px 8px;display:inline-flex;align-items:center;gap:6px}
    .eye-btn svg{width:18px;height:18px}

    /* Overlay */
    #deviceOverlay{position:fixed;inset:0;display:none;z-index:1000;background:rgba(8,10,14,.95);backdrop-filter:blur(4px)}
    #devicePanel{position:absolute;inset:0;display:grid;grid-template-rows:auto 1fr;max-width:1200px;margin:0 auto}
    .overlay-header{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid var(--border);background:#0f1218}
    .overlay-content{padding:16px;overflow:auto}
    .overlay-grid{display:grid;grid-template-columns:1fr 1fr 320px;gap:16px;margin-bottom:12px}
    @media(max-width:1100px){.overlay-grid{grid-template-columns:1fr 1fr}}
    @media(max-width:760px){.overlay-grid{grid-template-columns:1fr}}

    .editing .device-card{cursor:grab;animation:shake .9s ease-in-out infinite}
    @keyframes shake{0%{transform:translate(0,0)}25%{transform:translate(1px,-1px)}50%{transform:translate(-1px,1px)}75%{transform:translate(1px,0)}100%{transform:translate(0,0)}}

    .metric{display:flex;align-items:baseline;gap:10px;margin-top:6px}
    .metric .val{font-size:2.4rem;font-weight:800;letter-spacing:.3px}
    .metric .unit{font-size:1.05rem;font-weight:800;color:#111;background:var(--accent);border-radius:8px;padding:2px 8px;border:2px solid var(--accent)}

    #chartsWrap{display:none;margin-top:14px}
    .chart-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
    .charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media(max-width:860px){.charts-grid{grid-template-columns:1fr}}
    .chart-box{position:relative;height:240px}
    .chart-box canvas{position:absolute;inset:0;width:100% !important;height:100% !important}
    .hist-controls{display:none;gap:10px;align-items:end;margin-top:10px;flex-wrap:wrap}
    .hist-actions{display:flex;gap:8px}

    /* Date-chip */
.date-chip{display:inline-flex;align-items:center;gap:0;background:var(--chip-bg);border:1px solid var(--border);border-radius:10px;overflow:hidden}
.date-chip input[type="date"]{appearance:none;-webkit-appearance:none;border:0;background:transparent;color:#fff;font-weight:600;padding:8px 10px;cursor:pointer;min-width:140px;line-height:1.2}
.date-chip input[type="date"]::-webkit-calendar-picker-indicator{display:none}
.cal-btn{background:var(--accent);border:2px solid var(--accent);color:#111;border-radius:0 10px 10px 0;padding:8px 10px;display:inline-flex;align-items:center;cursor:pointer}
.cal-btn svg{width:18px;height:18px;color:#111}
.cal-btn:focus{outline:2px solid var(--focus)}

/* Input-chip: para Kilos */
.input-chip{display:flex;align-items:center;background:#10141a;border:1px solid var(--border);border-radius:10px;overflow:hidden}
.input-chip input{width:100%;background:transparent;border:0;color:#fff;padding:8px 10px;line-height:1.2}

/* Grids overlay: mantener Producción al costado */
.overlay-grid{display:grid;grid-template-columns:1fr 1fr 320px;gap:16px;margin-bottom:12px}
@media(max-width:900px){.overlay-grid{grid-template-columns:1fr 1fr}}
@media(max-width:760px){.overlay-grid{grid-template-columns:1fr}}


    /* Producción “nice” */
    .nice-table{border:1px solid var(--border);border-radius:12px;overflow:hidden;background:var(--card)}
    .nice-table thead th{background:var(--accent);color:#111;border-bottom:1px solid #caa332}
    .nice-table tbody tr:nth-child(odd){background:var(--zebra)}
    .nice-table td,.nice-table th{padding:10px}
    .nice-table td.num{text-align:right;font-variant-numeric:tabular-nums}
    .badge{display:inline-block;background:#222;border:1px solid var(--border);padding:2px 8px;border-radius:999px;font-weight:700}

    /* Status dot */
    .status-row{display:flex;align-items:center;gap:8px;color:var(--muted);margin:.25rem 0 0}
    .status-dot{width:10px;height:10px;border-radius:50%;background:var(--idle);box-shadow:0 0 0 2px rgba(0,0,0,.2) inset}

    /* Clima */
    .wx-card{background:linear-gradient(140deg,#0b0d12,#141926);border:1px solid var(--border);border-radius:12px;padding:14px;margin-top:12px;position:relative;overflow:hidden}
    .wx-blur{filter:blur(3px);opacity:.6;pointer-events:none}
    .wx-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:8px;flex-wrap:wrap}
    .wx-title{font-weight:800}
    .wx-tiles{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .wx-tile{background:#10141a;border:1px solid var(--border);border-radius:10px;padding:8px;text-align:center}
    .wx-big{font-size:1.6rem;font-weight:800}
    .wx-small{color:var(--muted);font-size:.9rem}
    .wx-loc{color:var(--muted);font-size:.9rem}
    .wx-today{display:flex;justify-content:space-between;align-items:center;background:#10141a;border:1px solid var(--border);border-radius:10px;padding:10px;margin-bottom:8px}
    .loc-chip{display:flex;gap:8px;align-items:center;background:var(--chip-bg);border:1px solid var(--border);border-radius:10px;padding:6px 6px}
    .loc-chip input{background:transparent;border:0;color:#fff;padding:6px;font-weight:600;min-width:220px}
    .loc-chip input::placeholder{color:#8fa1b3}

    /* Overlay Producción global */
    #prodOverlay{position:fixed;inset:0;display:none;z-index:1000;background:rgba(8,10,14,.95);backdrop-filter:blur(4px)}
    #prodPanel{position:absolute;inset:0;display:grid;grid-template-rows:auto 1fr;max-width:1200px;margin:0 auto}

  /* ======= Configuración de tarjeta modelo (modo Editar orden) ======= */

/* Capa oscura y centrado */
#editModelWrap{
  position:fixed; inset:0; display:none;
  align-items:center; justify-content:center;
  background:rgba(8,10,14,.6); backdrop-filter:blur(3px);
  z-index:950;
}

/* Carta modelo centrada */
.edit-model-card{
  width:min(92vw,420px);
  background:var(--card-2);
  border:1px solid var(--border);
  border-radius:14px;
  padding:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.35);
}

/* Encabezado de la carta */
.edit-model-head{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  margin-bottom:10px;
}
.edit-model-title{
  margin:0; font-size:1.15rem; font-weight:800; letter-spacing:.2px;
}
.edit-model-sub{
  color:var(--muted); font-size:.92rem;
}

/* Vista previa “parecida” a las device-card */
.model-preview{
  background:var(--card);
  border:1px dashed var(--border);
  border-radius:12px;
  padding:12px; margin-top:8px;
}
.model-title{
  margin:0 0 8px; font-weight:800;
}
.model-rows{ display:grid; gap:6px }
.model-row{
  display:flex; align-items:center; gap:8px; color:var(--muted);
}
.model-dot{
  width:10px; height:10px; border-radius:50%;
  background:var(--idle); box-shadow:0 0 0 2px rgba(0,0,0,.2) inset;
}
.model-chip{
  display:inline-block; background:#10141a; color:#e6e9ee;
  border:1px solid var(--border); padding:2px 8px; border-radius:999px;
  font-weight:700; font-variant-numeric:tabular-nums;
}

/* Controles */
.edit-controls{ margin-top:12px; display:grid; gap:10px }
.ctrl-row{ display:grid; grid-template-columns:1fr; gap:8px }
.ctrl-label{ font-weight:700 }
.ctrl-help{ color:var(--muted); font-size:.9rem }

/* Selector segmentado */
.seg{
  display:inline-flex; background:#10141a; border:1px solid var(--border);
  border-radius:10px; overflow:hidden;
}
.seg button{
  background:transparent; color:#dfe5ec; border:0; padding:8px 10px; cursor:pointer;
  font-weight:700; min-width:90px;
}
.seg button + button{ border-left:1px solid var(--border) }
.seg button[aria-pressed="true"]{
  background:var(--accent); color:#111; border-left-color:var(--accent);
}

/* Select estándar (fallback) */
.select{
  width:100%; background:#10141a; color:#fff;
  border:1px solid var(--border); border-radius:10px; padding:8px 10px;
}

/* Pie de acciones */
.edit-actions{
  display:flex; gap:8px; justify-content:flex-end; margin-top:12px; flex-wrap:wrap;
}
.btn.outline{
  background:transparent; color:#e2e7ee; border-color:var(--border);
}
.btn.confirm{
  background:var(--accent); color:#111; border-color:var(--accent); font-weight:800;
}

/* Estado de edición en la grilla: deja visible la carta modelo */
.editing #editModelWrap{ display:flex }

/* Responsivo */
@media (max-width:520px){
  .edit-model-card{ padding:14px }
  .seg button{ min-width:72px; padding:8px 8px }
}

/* Utilidades pequeñas para la vista previa */
.kv{
  display:flex; align-items:center; gap:6px; flex-wrap:wrap;
}
.kv .k{ color:#c7ced8 }
.kv .v{ font-weight:800; color:var(--accent) }
.kv .v.blue{ color:var(--focus) }

    
  </style>
</head>
<body>
  <header class="header">
    <div class="nav-grid">
      <a class="brand" href="index.html">MIELLIFERA</a>
      <nav class="nav-center" aria-label="Principal"></nav>
      <button id="btnLogout" class="cta" type="button">Salir</button>
    </div>
  </header>

  <main class="site">
    <section class="section alt">
      <div class="section-head">
        <div>
          <h2>Tu panel</h2>
          <p class="muted">Código de vinculación, dispositivos y lecturas.</p>
        </div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button id="lastReading" class="pill" type="button">Última medición: —</button>
          <button id="btnProdMain" class="btn small" type="button" title="Producción">Producción</button>
        </div>
      </div>

      <div class="split">
        <!-- ======= Cuenta ======= -->
        <div class="card" style="max-width:420px">
          <h3>Cuenta</h3>
          <p class="reveal-wrap">
            <span>Email: <b id="uEmail" data-real="">—</b></span>
            <button id="toggleEmail" class="eye-btn" type="button">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 3l18 18" stroke-width="2"/><path d="M21 12s-3.5-7-9-7" stroke-width="2"/></svg>
              <span>Ocultar</span>
            </button>
          </p>
          <p class="reveal-wrap">
            <span>Código de 4 dígitos: <b id="uCode" data-real="">—</b></span>
            <button id="toggleCode" class="eye-btn" type="button">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 3l18 18" stroke-width="2"/><path d="M21 12s-3.5-7-9-7" stroke-width="2"/></svg>
              <span>Ocultar</span>
            </button>
          </p>
          <div class="reveal-wrap" style="margin-top:6px">
            <button id="btnTutorials" class="btn small" type="button">Tutoriales</button>
          </div>
          <div id="msg" class="muted" style="margin-top:8px"></div>
          <hr style="border:0;border-top:1px solid var(--border)">

          <!-- ======= Clima ======= -->
          <div>
            <h3 style="margin:10px 0 8px">Clima y pronóstico</h3>
            <div id="wxCard" class="wx-card">
              <div class="wx-head">
                <div class="wx-title">Pronóstico local</div>
                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                  <button id="btnWxOpen" class="btn small yellow" type="button">Ingresar ubicación</button>
                  <button id="btnWxReset" class="btn small" type="button" style="display:none">Resetear</button>
                </div>
              </div>
              <div id="wxInputRow" style="display:none;margin:6px 0 10px;gap:8px;align-items:center;flex-wrap:wrap">
                <div class="loc-chip">
                  <input id="wxQuery" type="text" placeholder="Ciudad, provincia, país o lat,lon">
                </div>
                <button id="btnWxFind" class="btn small yellow" type="button">Buscar</button>
              </div>
              <div id="wxContent" class="wx-blur">
                <div class="wx-today">
                  <div>
                    <div class="wx-big" id="wxNow">— °C</div>
                    <div class="wx-loc" id="wxWhere">Ubicación no establecida</div>
                    <div class="wx-small" id="wxNowMeta">—</div>
                  </div>
                  <div class="wx-small" id="wxTodayMM">Máx —° · Mín —° · 💧 —mm</div>
                </div>
                <div class="wx-tiles" id="wxTiles"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- ======= KPIs madre + gráficos ======= -->
        <div>
          <div class="side-cards">
            <div class="card">
              <h3>Temperatura Exterior</h3>
              <div class="metric"><span id="temVal" class="val">—</span><span class="unit">°C</span></div>
              <div id="temWhen" class="muted">—</div>
            </div>
            <div class="card">
              <h3>Humedad Exterior</h3>
              <div class="metric"><span id="humVal" class="val">—</span><span class="unit">%</span></div>
              <div id="humWhen" class="muted">—</div>
            </div>
          </div>

          <div class="center" style="margin-top:14px">
            <button id="btnChart" class="btn yellow" type="button">Mostrar gráfica</button>
          </div>

          <div id="chartsWrap">
            <div class="charts-grid">
              <div class="chart-card">
                <h3 id="titleTemp">Temperatura de hoy</h3>
                <div class="chart-box"><canvas id="chartTemp"></canvas></div>
              </div>
              <div class="chart-card">
                <h3 id="titleHum">Humedad de hoy</h3>
                <div class="chart-box"><canvas id="chartHum"></canvas></div>
              </div>
            </div>

            <div class="hist-controls" id="histControls">
              <div class="date-chip">
                <input type="date" id="dateFrom">
                <button class="cal-btn" type="button" onclick="tryOpenPicker('dateFrom')">
                  <svg viewBox="0 0 24 24" stroke="currentColor" fill="none"><rect x="3" y="4" width="18" height="18" rx="3" stroke-width="2"/><path d="M16 2v4M8 2v4M3 10h18" stroke-width="2"/></svg>
                </button>
              </div>
              <div class="date-chip">
                <input type="date" id="dateTo">
                <button class="cal-btn" type="button" onclick="tryOpenPicker('dateTo')">
                  <svg viewBox="0 0 24 24" stroke="currentColor" fill="none"><rect x="3" y="4" width="18" height="18" rx="3" stroke-width="2"/><path d="M16 2v4M8 2v4M3 10h18" stroke-width="2"/></svg>
                </button>
              </div>
              <div class="hist-actions">
                <button id="btnShowRange" class="btn small" type="button">Mostrar</button>
                <button id="btnClearHistory" class="btn small" type="button">Borrar</button>
                <button id="btnDownloadCSV" class="btn small" type="button">Descargar CSV</button>
              </div>
            </div>
          </div>

          <div class="cards-head">
            <button id="btnEdit" class="btn small" type="button" aria-pressed="false">Editar orden</button>
          </div>
          <div id="autoCards" class="cards-grid" aria-live="polite"></div>
        </div>
      </div>
    </section>

    <section class="section" id="lecturas">
      <div class="section-head">
        <h3>Historial de mediciones</h3>
        <button id="toggleTbl" class="btn" type="button">Mostrar / Ocultar historial de mediciones</button>
      </div>
      <div id="tableWrap" style="overflow:auto;max-height:60vh;display:none;border-radius:12px">
        <table id="tbl">
          <thead><tr><th>Fecha</th><th>Dispositivo</th><th>Sensor</th><th>Valor / Info</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer style="padding:16px;color:#c3c9d1;border-top:1px solid var(--border);display:flex;justify-content:center">
    <span>© <span id="year"></span> MIELLIFERA</span>
  </footer>

  <!-- ======= Modal de configuración de modelo ======= -->
  <div id="editModelWrap">
    <div class="edit-model-card">
      <div class="edit-model-head">
        <h3 class="edit-model-title">Configuración de vista</h3>
        <span class="edit-model-sub" id="editModelHive">Colmena —</span>
      </div>

      <div class="model-preview">
        <h4 class="model-title">Vista previa</h4>
        <div class="model-rows">
          <div class="model-row"><span class="model-dot" style="background:var(--ok)"></span><span>Kilos mes</span><span class="model-chip">12.3</span></div>
          <div class="model-row"><span class="model-dot" style="background:var(--focus)"></span><span>Trabajo semanal</span><span class="model-chip">8h 20m</span></div>
        </div>
      </div>

      <div class="edit-controls">
        <div class="ctrl-row">
          <label class="ctrl-label">Mostrar kilos por</label>
          <div class="seg" id="segKilos">
            <button type="button" data-mode="mes" aria-pressed="true">Mes</button>
            <button type="button" data-mode="semana">Semana</button>
            <button type="button" data-mode="anio">Año</button>
          </div>
        </div>

        <div class="ctrl-row">
          <label class="ctrl-label">Mostrar trabajo por</label>
          <div class="seg" id="segTrabajo">
            <button type="button" data-mode="semana" aria-pressed="true">Semanal</button>
            <button type="button" data-mode="dia">Diario</button>
            <button type="button" data-mode="anio">Anual</button>
          </div>
        </div>
      </div>

      <div class="edit-actions">
        <button id="btnCancelEdit" class="btn outline" type="button">Cancelar</button>
        <button id="btnConfirmEdit" class="btn confirm" type="button">Confirmar</button>
      </div>
    </div>
  </div>

<script>
  // Año
  document.getElementById('year').textContent = new Date().getFullYear();

  // Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBH93vOKldh-IufVCZB1qyI6cRPoOr7iqw",
    authDomain: "mellifera-technology.firebaseapp.com",
    projectId: "mellifera-technology",
    storageBucket: "mellifera-technology.firebasestorage.app",
    messagingSenderId: "68043353319",
    appId: "1:68043353319:web:20a1aafde7b37d3457c642",
    measurementId: "G-FCW1E604DG"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();

  // Worker
  const WORKER_BASE = "https://mellifera-worker.mellifera-tech.workers.dev";
  const BASE = WORKER_BASE.replace(/\/+$/, '');
  const $ = id => document.getElementById(id);
  const setText = (id,t)=>{ const el=$(id); if(el) el.textContent=t; };

  // Estado
  let currentUID=null, editing=false;
  let chartTemp=null, chartHum=null, chartsVisible=false, lastItemsCache=null;
  let historyMode=false;
  let currentOverlayDevice=null, ovChartsVisible=false, ovChartTemp=null, ovChartHum=null;

  // ===== Prefs por colmena (kilos/trabajo) =====
  const PREF_KEY='miellifera.cardPref.v1'; // { [deviceId]: { kilos:'mes|semana|anio', trabajo:'dia|semana|anio' } }
  function loadPrefs(){ try{ return JSON.parse(localStorage.getItem(PREF_KEY)||'{}'); }catch{ return {}; } }
  function savePrefs(p){ try{ localStorage.setItem(PREF_KEY, JSON.stringify(p||{})); }catch{} }
  function getPrefFor(deviceId){
    const all=loadPrefs();
    const d=String(deviceId||'');
    const def={kilos:'mes', trabajo:'semana'};
    if(!d) return def;
    return Object.assign({}, def, all[d]||{});
  }
  function setPrefFor(deviceId, pref){
    const all=loadPrefs();
    all[String(deviceId)] = Object.assign({}, getPrefFor(deviceId), pref||{});
    savePrefs(all);
  }

  // ======= NUEVO: Estado clima por almacenamiento local =======
  const WX_KEY = 'miellifera.wxPlace'; // {lat,lon,label}
  function saveWxPlace(p){ try{ localStorage.setItem(WX_KEY, JSON.stringify(p||null)); }catch{} }
  function loadWxPlace(){ try{ const x = localStorage.getItem(WX_KEY); return x? JSON.parse(x): null; }catch{ return null; } }
  function clearWxPlace(){ try{ localStorage.removeItem(WX_KEY); }catch{} }

  // Auth
  auth.onAuthStateChanged(async (u)=>{
    if(!u){ location.href = 'login.html'; return; }
    currentUID = u.uid;
    const ue=$('uEmail'); ue.dataset.real = u.email || '(sin email)'; ue.textContent = ue.dataset.real;
    try{
      const { code } = await callWorker('/ensure_user', { method:'POST' });
      const uc=$('uCode'); uc.dataset.real = code || '—'; uc.textContent = uc.dataset.real;
      await loadDatapoints();
      initDateDefaults();
      initProdDefaults();

      // Clima: restituir
      const saved = loadWxPlace();
      if(saved && Number.isFinite(saved.lat) && Number.isFinite(saved.lon)){
        await renderWeather(saved.lat, saved.lon, saved.label||(`Lat ${saved.lat.toFixed(2)}, Lon ${saved.lon.toFixed(2)}`));
        setWxButtonsState('fixed');
      } else {
        setWxButtonsState('ready');
      }
    }catch(e){ const m=$('msg'); if(m) m.textContent="Error cargando datos: "+(e.message||e); }
  });
  $('btnLogout').onclick = ()=> auth.signOut().then(()=>location.href='login.html');
  $('btnTutorials').onclick = ()=> location.href='tutoriales.html';

  // Toggle email/código
  function maskVal(s){ if(!s) return '••••'; if(/@/.test(s)){ const [a,dom]=s.split('@'); const mm = a.length<=2 ? a[0]+'*' : a[0]+'*'.repeat(Math.max(1,a.length-2))+a.slice(-1); return mm+'@'+dom; } return '•'.repeat(Math.min(4,String(s).length)); }
  function toggleReveal(targetId, btnId){
    const el=$(targetId), btn=$(btnId);
    const hidden = el.dataset.shown !== '1';
    if(hidden){ el.dataset.prev = el.textContent; el.textContent = maskVal(el.dataset.real||el.textContent); el.dataset.shown='1'; btn.setAttribute('aria-pressed','true'); btn.querySelector('span').textContent='Mostrar'; }
    else{ el.textContent = el.dataset.real || el.dataset.prev || el.textContent; el.dataset.shown='0'; btn.setAttribute('aria-pressed','false'); btn.querySelector('span').textContent='Ocultar'; }
  }
  $('toggleEmail').onclick = ()=> toggleReveal('uEmail','toggleEmail');
  $('toggleCode').onclick  = ()=> toggleReveal('uCode','toggleCode');

  // Worker call
  async function callWorker(path, opts={}){
    const u = auth.currentUser; if(!u) throw new Error('No auth');
    const t = await u.getIdToken();
    const p = path.startsWith('/') ? path : `/${path}`;
    const res = await fetch(`${BASE}${p}`, {
      method: opts.method || 'GET',
      headers: { 'Authorization': `Bearer ${t}`, 'Content-Type': 'application/json' },
      body: opts.body ? JSON.stringify(opts.body) : undefined
    });
    if(!res.ok) throw new Error(await res.text());
    return res.json();
  }

  // Utils
  const fmt = v => (v==null||Number.isNaN(+v)) ? null : Number(v).toFixed(1);
  const dtAR = ts => new Date(ts).toLocaleString('es-AR');
  const isNumericId = id => /^\d+$/.test(id);
  function escapeHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}
  function ymd(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),dd=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${dd}`;}
  function toLocalDayStart(dateInput){ return new Date(dateInput+"T00:00:00").getTime(); }
  function toLocalDayEnd(dateInput){ return new Date(dateInput+"T23:59:59.999").getTime(); }
  function tryOpenPicker(id){ const el=$(id); if(el?.showPicker) el.showPicker(); else el?.focus(); }

  // KPIs madre
  function updateLastReading(items){
    const el=$('lastReading');
    if(!items?.length){ el.textContent='Última medición: —'; return; }
    const latest = items.reduce((a,b)=> new Date(a.ts)>new Date(b.ts)?a:b);
    el.textContent = 'Última medición: '+ dtAR(latest.ts);
  }
  function latestBySensor(items, key){
    let best=null, bt=0, KEY=String(key).toUpperCase();
    for(const d of items||[]){ if(String(d.sensor_key||'').toUpperCase()!==KEY) continue;
      const t=new Date(d.ts).getTime(); if(t>bt){ best=d; bt=t; } }
    return best;
  }
  function updateMotherKPIs(items){
    const tem=latestBySensor(items,'MOTHER.TEM');
    setText('temVal', tem?.value!=null? fmt(tem.value):'—');
    setText('temWhen', tem? dtAR(tem.ts):'—');
    const hum=latestBySensor(items,'MOTHER.HUM');
    setText('humVal', hum?.value!=null? fmt(hum.value):'—');
    setText('humWhen', hum? dtAR(hum.ts):'—');
  }

  // Tabla general
  function renderTable(items){
    const tbody=document.querySelector('#tbl tbody');
    tbody.innerHTML=(items||[]).map(d=>{
      const val = String(d.sensor_key||'').startsWith('EVENT.')
        ? (d.meta?.info||d.meta?.type||JSON.stringify(d.meta||{}))
        : (d.value==null?'':fmt(d.value));
      return `<tr><td>${dtAR(d.ts)}</td><td>${escapeHtml(d.device_id||'')}</td><td>${escapeHtml(d.sensor_key||'')}</td><td>${escapeHtml(val)}</td></tr>`;
    }).join('');
  }

  function formatMinutes(mins){
    const h = Math.floor(mins/60);
    const m = Math.round(mins%60);
    return h>0 ? `${h}h ${m}m` : `${m}m`;
  }

  // ===== Producción: helpers por período =====
  async function prodInsert(device_id, fecha, kilos){
    if(!(Number(kilos)>0)) throw new Error('kilos debe ser > 0');
    return callWorker('/production', { method:'POST', body:{ device_id, fecha, kilos }});
  }
  async function prodList(params){
    const url = new URL(BASE + '/production');
    if(params?.device_id) url.searchParams.set('device_id', params.device_id);
    if(params?.fromISO)    url.searchParams.set('from', params.fromISO);
    if(params?.toISO)      url.searchParams.set('to', params.toISO);
    const u = auth.currentUser; if(!u) throw new Error('No auth');
    const t = await u.getIdToken();
    const res = await fetch(url.toString(), { headers:{ 'Authorization':`Bearer ${t}` }});
    if(!res.ok) throw new Error(await res.text());
    return res.json();
  }

  function periodBounds(period, ref=new Date()){
    const r = new Date(ref);
    let from = new Date(r), to = new Date(r);
    if(period==='dia'){
      from.setHours(0,0,0,0); to.setHours(23,59,59,999);
    }else if(period==='semana'){
      const d=(r.getDay()+6)%7; // lunes
      from.setHours(0,0,0,0); from.setDate(from.getDate()-d);
      to = new Date(from); to.setDate(from.getDate()+6); to.setHours(23,59,59,999);
    }else if(period==='mes'){
      from = new Date(r.getFullYear(), r.getMonth(), 1, 0,0,0,0);
      to   = new Date(r.getFullYear(), r.getMonth()+1, 0, 23,59,59,999);
    }else{ // anio
      from = new Date(r.getFullYear(), 0, 1, 0,0,0,0);
      to   = new Date(r.getFullYear(), 11, 31, 23,59,59,999);
    }
    return { fromT:+from, toT:+to, fromISO: from.toISOString(), toISO: to.toISOString() };
  }

  // Cache producción por período para render rápido
  const prodCache = { mes:null, semana:null, anio:null };
  async function getProductionMap(period){
    if(prodCache[period]) return prodCache[period];
    const { fromISO, toISO } = periodBounds(period==='anio'?'anio':period);
    const { items } = await prodList({ fromISO, toISO });
    const map={}; // { device_id: totalKilos }
    for(const it of items||[]){
      const id = String(it.device_id||'');
      map[id] = (map[id]||0) + Number(it.kilos||0);
    }
    prodCache[period]=map;
    return map;
  }

  // ===== Trabajo: helpers y totales =====
  async function workFetchRange(fromISO, toISO, deviceId){
    try{
      const q = `/datapoints?from=${encodeURIComponent(fromISO)}&to=${encodeURIComponent(toISO)}&limit=5000`;
      const { items } = await callWorker(q);
      const keys = ['C2R','NHR','NXR','ALR','SMR','MS','OPN'];
      return (items||[]).filter(d =>
        String(d.device_id)===String(deviceId) &&
        keys.includes(String(d.sensor_key||'').toUpperCase().trim())
      );
    }catch(e){ return lastItemsCache||[]; }
  }
  function extractWorkTimes(items, deviceId) {
    const devId = String(deviceId);
    return (items || []).filter(d => {
      if (String(d.device_id) !== devId) return false;
      const k = String(d.sensor_key || '').toUpperCase().trim();
      return k === 'MS' || k.endsWith('.MS');
    });
  }
  function formatHM_fromMs(ms){
    const totalMin = Math.round((Number(ms)||0) / 60000);
    const h = Math.floor(totalMin/60);
    const m = totalMin % 60;
    return h>0 ? `${h}h ${m}m` : `${m}m`;
  }
  function isSameISOWeek(t, ref){
    const a = new Date(ref);
    const day = (a.getDay() + 6) % 7;
    a.setHours(0,0,0,0);
    a.setDate(a.getDate() - day);
    const start = a;
    const end = new Date(start); end.setDate(end.getDate()+7);
    return t >= start && t < end;
  }
  function calcWorkTotals_fromItems(items, deviceId, ref=new Date()){
    const msData = extractWorkTimes(items, deviceId);
    let day=0, week=0, month=0, year=0;
    for(const d of msData){
      const t=new Date(d.ts);
      const v=Number(d.value)||0;
      if(t.getFullYear()===ref.getFullYear()) year+=v;
      if(t.getFullYear()===ref.getFullYear() && t.getMonth()===ref.getMonth()) month+=v;
      if(isSameISOWeek(t, ref)) week+=v;
      if(t.getFullYear()===ref.getFullYear() && t.getMonth()===ref.getMonth() && t.getDate()===ref.getDate()) day+=v;
    }
    return { dayMs:day, weekMs:week, monthMs:month, yearMs:year };
  }
  async function getWorkTotal(deviceId, period){
    if(!deviceId) return 0;
    if(period==='dia'){
      // usar cache de los últimos 200 puntos
      const ref=new Date();
      const totals = calcWorkTotals_fromItems(lastItemsCache||[], deviceId, ref);
      return totals.dayMs;
    }
    const { fromISO, toISO } = periodBounds(period==='anio'?'anio':period);
    const items = await workFetchRange(fromISO, toISO, deviceId);
    const totals = calcWorkTotals_fromItems(items, deviceId, new Date());
    if(period==='semana') return totals.weekMs;
    if(period==='mes')    return totals.monthMs;
    return totals.yearMs; // anio
  }

  // Tarjetas colmena
  async function getMonthlyProduction(){
    try{
      const now = new Date();
      const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
      const fromISO = firstDay.toISOString();
      const toISO = new Date().toISOString();
      const { items } = await prodList({ fromISO, toISO });
      const map = {};
      for(const it of items||[]){
        const id = it.device_id;
        if(!map[id]) map[id]={kilos:0,trabajoMin:0};
        map[id].kilos += Number(it.kilos||0);
        map[id].trabajoMin += Number(it.trabajoMin||0);
      }
      return map;
    }catch{ return {}; }
  }

  async function renderDeviceCards(items){
    const wrap=$('autoCards'); if(!wrap) return;

    const lastById=new Map();
    for(const d of items||[]){
      const raw=String(d.device_id||'').trim();
      if(!raw || /mother/i.test(raw) || !isNumericId(raw)) continue;
      const t=new Date(d.ts).getTime(); const prev=lastById.get(raw)||0;
      if(t>prev) lastById.set(raw,t);
    }

    const devices=[...lastById.entries()].sort((a,b)=>b[1]-a[1]).map(([id,ts])=>({id,ts}));
    if(!devices.length){
      wrap.innerHTML='<div class="muted">Sin colmenas detectadas.</div>';
      // vaciar selector en Producción
      const sel=$('prodDevice'); if(sel){ sel.innerHTML='<option value="">Todas</option>'; }
      return;
    }

    const now=Date.now();
    // precache producción segun necesidades
    // Colectar qué períodos se requieren por preferencias
    const needPeriods = new Set();
    for(const d of devices){ const pref=getPrefFor(d.id); needPeriods.add(pref.kilos); }
    const prodMaps = {};
    for(const p of needPeriods){ prodMaps[p] = await getProductionMap(p); }

    wrap.innerHTML = await (async ()=>{
      const parts=[];
      for(const {id,ts} of devices){
        const diff=(now-ts)/60000;
        const conectado = diff<=15;
        const colorConn = conectado ? 'var(--ok)' : 'var(--bad)';
        const estadoColor = 'var(--idle)';

        const pref = getPrefFor(id);
        // Kilos por período elegido
        const kMap = prodMaps[pref.kilos] || {};
        const kilosVal = Number(kMap[id]||0);
        const kilosLabel = `Kilos ${pref.kilos==='anio'?'año':pref.kilos}`;
        // Trabajo por período elegido
        const workMs = await getWorkTotal(id, pref.trabajo); // puede tardar
        const trabajoLabel = `Trabajo ${pref.trabajo==='dia'?'diario':pref.trabajo==='anio'?'anual':pref.trabajo}`;
        const trabajoVal = formatHM_fromMs(workMs/60000*60); // workMs ya en ms → formatHM_fromMs espera ms; truco no necesario
        // corregir: formatHM_fromMs espera ms
        const trabajoText = formatHM_fromMs(workMs);

        parts.push(`
          <div class="card device-card" data-device="${id}" tabindex="0" role="button" aria-label="Abrir Colmena ${id}">
            <h3 style="margin:0">Colmena ${id}</h3>
            <div class="status-row"><span>Conectado</span><span class="status-dot" style="background:${colorConn}"></span></div>
            <div class="status-row"><span>Estado</span><span class="status-dot" style="background:${estadoColor}"></span></div>
            <div class="status-row"><span>${escapeHtml(kilosLabel)}</span><span style="font-weight:800;color:var(--accent)">${fmt(kilosVal)||'0.0'}</span></div>
            <div class="status-row"><span>${escapeHtml(trabajoLabel)}</span><span style="font-weight:800;color:var(--focus)">${escapeHtml(trabajoText)}</span></div>
          </div>`);
      }
      return parts.join('');
    })();

    if(editing) enableDnD();

    const sel = $('prodDevice');
    if(sel){
      const cur = sel.value;
      sel.innerHTML = '<option value="">Todas</option>' + devices.map(d=>`<option value="${d.id}">${d.id}</option>`).join('');
      if(cur) sel.value = cur;
    }
  }

  // DnD
  $('btnEdit').onclick=()=>{
    editing=!editing;
    $('btnEdit').textContent=editing?'Terminar edición':'Editar orden';
    $('autoCards').classList.toggle('editing',editing);
    if(editing){
      enableDnD();
      // abrir modal con primera colmena si existe
      const first = document.querySelector('.device-card');
      if(first) openEditModel(first.dataset.device);
    }else{
      disableDnD();
      closeEditModel();
    }
  };
  function enableDnD(){
    document.querySelectorAll('.device-card').forEach(c=>{
      c.draggable=true;
      c.addEventListener('dragstart',onDragStart);
      c.addEventListener('dragover',onDragOver);
      c.addEventListener('drop',onDrop);
      c.addEventListener('dragend',onDragEnd);
    });
  }
  function disableDnD(){
    document.querySelectorAll('.device-card').forEach(c=>{
      c.draggable=false;
      c.removeEventListener('dragstart',onDragStart);
      c.removeEventListener('dragover',onDragOver);
      c.removeEventListener('drop',onDrop);
      c.removeEventListener('dragend',onDragEnd);
    });
  }
  let dragId=null;
  function onDragStart(e){ dragId=this.dataset.device; e.dataTransfer.effectAllowed='move'; this.classList.add('dragging'); }
  function onDragOver(e){ e.preventDefault(); e.dataTransfer.dropEffect='move'; }
  function onDrop(e){
    e.preventDefault();
    const target=this.dataset.device;
    if(!dragId || dragId===target) return;
    const wrap=$('autoCards');
    const a=wrap.querySelector(`.device-card[data-device="${CSS.escape(dragId)}"]`);
    const b=wrap.querySelector(`.device-card[data-device="${CSS.escape(target)}"]`);
    const aNext=a.nextSibling, bNext=b.nextSibling;
    if(aNext===b) wrap.insertBefore(b,a);
    else if(bNext===a) wrap.insertBefore(a,b);
    else { wrap.insertBefore(a,bNext); wrap.insertBefore(b,aNext); }
  }
  function onDragEnd(){ this.classList.remove('dragging'); }

  // Click en card
  document.addEventListener('click',(e)=>{
    const card=e.target.closest('.device-card');
    if(!card) return;
    const id = card.dataset.device;
    if(editing){
      openEditModel(id);
      return;
    }
    if(card && !editing){ openOverlay(id); }
  });
  $('btnOverlayBack').onclick=closeOverlay;

  function openOverlay(id){
    currentOverlayDevice = String(id);
    setText('overlayTitle','Colmena '+id);
    const ov=$('deviceOverlay'); ov.style.display='block'; ov.setAttribute('aria-hidden','false');
    $('devicePanel').scrollTo({top:0,behavior:'instant'});
    updateOverlayKPIs(lastItemsCache, currentOverlayDevice);
    $('ovProdDate').value = ymd(new Date());
    $('ovProdKilos').value = '';
    $('ovProdTbody').innerHTML='<tr><td class="muted" colspan="2">Sin datos</td></tr>';
    $('ovProdHistWrap').style.display='none';
    $('ovBtnToggleHist').textContent='Ver historial';
    ovChartsVisible=false; $('ovChartsWrap').style.display='none';
    if(ovChartTemp){ ovChartTemp.destroy(); ovChartTemp=null; }
    if(ovChartHum){ ovChartHum.destroy(); ovChartHum=null; }
    $('ovDateFrom').value = ymd(new Date());
    $('ovDateTo').value = ymd(new Date());
  }
  function closeOverlay(){
    const ov=$('deviceOverlay'); ov.style.display='none'; ov.setAttribute('aria-hidden','true');
    currentOverlayDevice=null;
  }

  // KPIs colmena
  function keyIsTemp(k){ const K=String(k||'').toUpperCase(); if(K.startsWith('MOTHER.')) return false; return K.endsWith('.TEM')||K==='TEM'||K.includes('TEMP'); }
  function keyIsHum(k){  const K=String(k||'').toUpperCase(); if(K.startsWith('MOTHER.')) return false; return K.endsWith('.HUM')||K==='HUM'||K.includes('HUM'); }
  function latestByDevice(items, deviceId, kind){
    let best=null, bt=0;
    for(const d of items||[]){
      if(String(d.device_id||'')!==String(deviceId)) continue;
      const ok = kind==='TEM' ? keyIsTemp(d.sensor_key) : keyIsHum(d.sensor_key);
      if(!ok) continue;
      const t=new Date(d.ts).getTime();
      if(t>bt){ best=d; bt=t; }
    }
    return best;
  }
  function updateOverlayKPIs(items, deviceId){
    const t = latestByDevice(items, deviceId, 'TEM');
    const h = latestByDevice(items, deviceId, 'HUM');
    setText('ovTemVal', t?.value!=null ? fmt(t.value) : '—');
    setText('ovTemWhen', t ? dtAR(t.ts) : '—');
    setText('ovHumVal', h?.value!=null ? fmt(h.value) : '—');
    setText('ovHumWhen', h ? dtAR(h.ts) : '—');
  }

  // ===== Gráficos madre =====
  $('btnChart').onclick=()=>{
    chartsVisible=!chartsVisible;
    $('chartsWrap').style.display=chartsVisible?'block':'none';
    $('btnChart').textContent=chartsVisible?'Ocultar gráfica':'Mostrar gráfica';
    if(chartsVisible){
      if(historyMode){ /* noop */ }
      else if(lastItemsCache) renderChartsDaily(lastItemsCache);
    }
    $('histControls').style.display = chartsVisible ? 'flex' : 'none';
  };

  function buildLineChart(canvas, labels, values, lineColor){
    const ctx=canvas.getContext('2d');
    return new Chart(ctx,{
      type:'line',
      data:{ labels, datasets:[{
        data: values,
        borderColor: lineColor,
        backgroundColor: 'transparent',
        borderWidth: 2.5,
        tension:.25,
        pointRadius: 0,
        pointHoverRadius: 4,
        pointBackgroundColor: lineColor,
        pointBorderColor: lineColor
      }]},
      options:{
        responsive:true, maintainAspectRatio:false,
        interaction:{mode:'nearest',intersect:false},
        plugins:{legend:{display:false},tooltip:{callbacks:{
          title:(it)=>it[0]?.label||'', label:(it)=>` ${it.raw} `
        }}},
        scales:{x:{title:{display:true,text:'Hora'}},y:{title:{display:false},ticks:{precision:0}}}
      }
    });
  }

  function sameLocalDay(tsA, tsB){
    const a=new Date(tsA), b=new Date(tsB);
    return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
  }
  function seriesOfDay(items, key){
    const now=new Date(); const arr=[];
    for(const d of items||[]){
      if(String(d.sensor_key||'').toUpperCase()!==key) continue;
      if(!sameLocalDay(d.ts, now)) continue;
      const v = d.value==null || Number.isNaN(+d.value) ? null : Number(d.value);
      if(v==null) continue;
      const t=new Date(d.ts); const hh=String(t.getHours()).padStart(2,'0'); const mm=String(t.getMinutes()).padStart(2,'0');
      arr.push({label:`${hh}:${mm}`, x:t.getTime(), y:v});
    }
    arr.sort((a,b)=>a.x-b.x);
    return arr;
  }
  function renderChartsDaily(items){
    const tem=seriesOfDay(items,'MOTHER.TEM'); const labelsT=tem.map(d=>d.label); const valsT=tem.map(d=>d.y);
    const hum=seriesOfDay(items,'MOTHER.HUM'); const labelsH=hum.map(d=>d.label); const valsH=hum.map(d=>d.y);
    if(chartTemp) chartTemp.destroy(); if(chartHum) chartHum.destroy();
    chartTemp=buildLineChart($('chartTemp'), labelsT, valsT, '#ff4d4f');
    chartHum =buildLineChart($('chartHum'), labelsH, valsH, '#4da3ff');

    setText('titleTemp','Temperatura de hoy'); setText('titleHum','Humedad de hoy');
  }

  // ===== Gráficos por colmena =====
  $('overlayBtnChart').onclick=()=>{
    if(!currentOverlayDevice) return;
    ovChartsVisible = !ovChartsVisible;
    $('overlayBtnChart').textContent = ovChartsVisible ? 'Ocultar gráfica' : 'Mostrar gráfica';
    $('ovChartsWrap').style.display = ovChartsVisible ? 'block' : 'none';
    if(ovChartsVisible){ renderOverlayChartsDaily(lastItemsCache, currentOverlayDevice); }
  };
  function seriesOfDayForDevice(items, deviceId, pickKind){
    const now=new Date(); const arr=[];
    for(const d of items||[]){
      if(String(d.device_id||'')!==String(deviceId)) continue;
      const ok = pickKind==='TEM' ? keyIsTemp(d.sensor_key) : keyIsHum(d.sensor_key);
      if(!ok) continue;
      if(!sameLocalDay(d.ts, now)) continue;
      const v = d.value==null || Number.isNaN(+d.value) ? null : Number(d.value);
      if(v==null) continue;
      const t=new Date(d.ts); const hh=String(t.getHours()).padStart(2,'0'); const mm=String(t.getMinutes()).padStart(2,'0');
      arr.push({label:`${hh}:${mm}`, x:t.getTime(), y:v});
    }
    arr.sort((a,b)=>a.x-b.x);
    return arr;
  }
  function renderOverlayChartsDaily(items, deviceId){
    const tem=seriesOfDayForDevice(items, deviceId, 'TEM'); const labelsT=tem.map(d=>d.label); const valsT=tem.map(d=>d.y);
    const hum=seriesOfDayForDevice(items, deviceId, 'HUM'); const labelsH=hum.map(d=>d.label); const valsH=hum.map(d=>d.y);
    if(ovChartTemp) ovChartTemp.destroy(); if(ovChartHum) ovChartHum.destroy();
    ovChartTemp=buildLineChart($('ovChartTemp'), labelsT, valsT, '#ff4d4f');
    ovChartHum =buildLineChart($('ovChartHum'), labelsH, valsH, '#4da3ff');

    setText('ovTitleTemp','Temperatura de hoy'); setText('ovTitleHum','Humedad de hoy');
  }
  $('ovBtnShowRange').onclick=()=>{
    const df=$('ovDateFrom').value, dt=$('ovDateTo').value; if(!df || !dt || !currentOverlayDevice) return;
    const fromT=toLocalDayStart(df), toT=toLocalDayEnd(dt);
    const items=(lastItemsCache||[]).filter(d=>String(d.device_id||'')===String(currentOverlayDevice)
      && new Date(d.ts).getTime()>=fromT && new Date(d.ts).getTime()<=toT);
    const tem=items.filter(d=>keyIsTemp(d.sensor_key)).sort((a,b)=>new Date(a.ts)-new Date(b.ts)).map(d=>{
      const t=new Date(d.ts), lab=`${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}`; return {label:lab,y:Number(d.value)};});
    const hum=items.filter(d=>keyIsHum(d.sensor_key)).sort((a,b)=>new Date(a.ts)-new Date(b.ts)).map(d=>{
      const t=new Date(d.ts), lab=`${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}`; return {label:lab,y:Number(d.value)};});
    if(ovChartTemp) ovChartTemp.destroy(); if(ovChartHum) ovChartHum.destroy();
    ovChartTemp=buildLineChart($('ovChartTemp'), tem.map(x=>x.label), tem.map(x=>x.y), '#ff4d4f');
    ovChartHum =buildLineChart($('ovChartHum'), hum.map(x=>x.label), hum.map(x=>x.y), '#4da3ff');

    setText('ovTitleTemp', `Temperatura ${df} → ${dt}`);
    setText('ovTitleHum',  `Humedad ${df} → ${dt}`);
  };
  $('ovBtnExitHistory').onclick=()=>{
    if(ovChartsVisible) renderOverlayChartsDaily(lastItemsCache, currentOverlayDevice);
    $('ovDateFrom').value = ymd(new Date()); $('ovDateTo').value = ymd(new Date());
    setText('ovTitleTemp','Temperatura de hoy'); setText('ovTitleHum','Humedad de hoy');
  };

  // Historial madre UI
  function initDateDefaults(){
    const val = ymd(new Date());
    $('dateFrom').value = val;
    $('dateTo').value   = val;
  }
  $('btnShowRange').onclick=()=>showRange();
  $('btnDownloadCSV').onclick=()=>downloadCSV();
  $('btnClearHistory').onclick=()=>{
    $('dateFrom').value=''; $('dateTo').value='';
    historyMode=false;
    if(chartsVisible && lastItemsCache) renderChartsDaily(lastItemsCache);
    setText('titleTemp','Temperatura de hoy'); setText('titleHum','Humedad de hoy');
  };

  async function fetchRange(fromISO, toISO){
    try{
      const q = `/datapoints?from=${encodeURIComponent(fromISO)}&to=${encodeURIComponent(toISO)}&limit=5000`;
      const { items } = await callWorker(q);
      return items||[];
    }catch(e){ return lastItemsCache||[]; }
  }
  function normalizeDateRangeInputs(){
    let df=$('dateFrom').value, dt=$('dateTo').value;
    if(!df || !dt) return null;
    const a=toLocalDayStart(df), b=toLocalDayStart(dt); if(a>b){ const tmp=df; df=dt; dt=tmp; }
    return { df, dt, fromISO: new Date(df+'T00:00:00').toISOString(), toISO: new Date(dt+'T23:59:59.999').toISOString() };
  }
  async function showRange(){
    const r = normalizeDateRangeInputs(); if(!r) return;
    historyMode = true;
    const itemsSrv = await fetchRange(r.fromISO, r.toISO);
    const fromT = toLocalDayStart(r.df), toT = toLocalDayEnd(r.dt);
    const items = (itemsSrv||[]).filter(d=>{ const t=new Date(d.ts).getTime(); return t>=fromT && t<=toT; });

    const tem=seriesByRange(items,'MOTHER.TEM'); const labelsT=tem.map(d=>d.label); const valsT=tem.map(d=>d.y);
    const hum=seriesByRange(items,'MOTHER.HUM'); const labelsH=hum.map(d=>d.label); const valsH=hum.map(d=>d.y);
    if(chartTemp) chartTemp.destroy(); if(chartHum) chartHum.destroy();
    chartTemp=buildLineChart($('chartTemp'), labelsT, valsT, '#ff4d4f');
    chartHum =buildLineChart($('chartHum'), labelsH, valsH, '#4da3ff');

    setText('titleTemp', `Temperatura ${r.df} → ${r.dt}`);
    setText('titleHum',  `Humedad ${r.df} → ${r.dt}`);
  }
  function seriesByRange(items, key){
    const arr=[];
    for(const d of items||[]){
      if(String(d.sensor_key||'').toUpperCase()!==key) continue;
      const v = d.value==null || Number.isNaN(+d.value) ? null : Number(d.value);
      if(v==null) continue;
      const t=new Date(d.ts);
      const lab = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')} ${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}`;
      arr.push({label:lab, x:t.getTime(), y:v});
    }
    arr.sort((a,b)=>a.x-b.x);
    return arr;
  }
  function toCSV(items, df=null, dt=null){
    const fromT = df? toLocalDayStart(df): -Infinity, toT = dt? toLocalDayEnd(dt): Infinity;
    const base = (items||[]).filter(d=>{const t=new Date(d.ts).getTime(); return t>=fromT && t<=toT;});
    const rows = [['timestamp_iso','fecha_local','hora_local','dispositivo','sensor','valor']];
    for(const d of base){
      if(!/^MOTHER\.(TEM|HUM)$/i.test(String(d.sensor_key||''))) continue;
      const ts=new Date(d.ts);
      const fecha=ts.toLocaleDateString('es-AR'); const hora=ts.toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
      rows.push([ts.toISOString(), fecha, hora, d.device_id||'', d.sensor_key||'', d.value==null?'':String(d.value)]);
    }
    return rows.map(r=>r.map(cell=>/[,;\n"]/.test(cell)? `"${String(cell).replace(/"/g,'""')}"` : cell).join(',')).join('\n');
  }
  async function downloadCSV(){
    const df=$('dateFrom').value, dt=$('dateTo').value;
    const csv = toCSV(lastItemsCache, df||null, dt||null);
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = (df&&dt)? `miellifera_${df}_a_${dt}.csv` : 'miellifera_hoy.csv';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  // ===== Producción mini-dashboard en overlay colmena =====
  $('ovBtnSaveProd').onclick = async ()=>{
    if(!currentOverlayDevice) return;
    const fecha = $('ovProdDate').value;
    const kilos = Number($('ovProdKilos').value);
    if(!fecha || !(kilos>0)) { alert('Completá fecha y kilos > 0'); return; }
    try{
      await prodInsert(currentOverlayDevice, fecha, kilos);
      $('ovProdKilos').value='';
      if($('ovProdHistWrap').style.display!=='none'){ await loadOvProdHistory(); }
      // invalidate cache para tarjetas
      prodCache.mes = null; prodCache.semana=null; prodCache.anio=null;
      await renderDeviceCards(lastItemsCache||[]);
    }catch(e){ alert('Error guardando: ' + (e.message||e)); }
  };
  $('ovBtnToggleHist').onclick = async ()=>{
    const wrap = $('ovProdHistWrap');
    const show = wrap.style.display==='none';
    wrap.style.display = show ? 'block' : 'none';
    $('ovBtnToggleHist').textContent = show ? 'Ocultar historial' : 'Ver historial';
    if(show) await loadOvProdHistory();
  };
  async function loadOvProdHistory(){
    if(!currentOverlayDevice) return;
    const { items } = await prodList({ device_id: currentOverlayDevice });
    const tb = $('ovProdTbody');
    if(!items?.length){ tb.innerHTML='<tr><td class="muted" colspan="2">Sin datos</td></tr>'; return; }
    tb.innerHTML = items.map(r=>`<tr><td>${escapeHtml(r.fecha)}</td><td class="num">${Number(r.kilos).toFixed(2)}</td></tr>`).join('');
  }

  // ===== Overlay global Producción =====
  $('btnProdMain').onclick = ()=>{ openProdOverlay(); };
  $('btnProdBack').onclick = ()=>{ closeProdOverlay(); };
  $('btnProdShow').onclick = async ()=>{
    const df=$('prodFrom').value, dt=$('prodTo').value;
    const dev=$('prodDevice').value||'';
    const fromISO=df?new Date(df+'T00:00:00').toISOString():undefined;
    const toISO=dt?new Date(dt+'T23:59:59.999').toISOString():undefined;
    try{
      const { items }=await prodList({device_id:dev||undefined,fromISO,toISO});
      const tb=$('prodGlobalTbody');
      if(!items?.length){
        tb.innerHTML='<tr><td class="muted" colspan="3">Sin datos</td></tr>';
        setText('prodGlobalTotal','0.00');
        $('btnProdCSV').style.display='none';
        return;
      }
      tb.innerHTML=items.map(r=>
        `<tr><td>${escapeHtml(r.fecha)}</td><td>${escapeHtml(r.device_id)}</td><td class="num">${Number(r.kilos).toFixed(2)}</td></tr>`
      ).join('');
      const total=items.reduce((a,b)=>a+Number(b.kilos||0),0);
      setText('prodGlobalTotal',total.toFixed(2));
      $('btnProdCSV').style.display='inline-flex';
    }catch(e){ alert('Error consultando: '+(e.message||e)); }
  };
  function prodDownloadCSV(){
    const rows=[['fecha','colmena','kilos']];
    const tb=document.querySelectorAll('#prodGlobalTbody tr');
    tb.forEach(tr=>{
      const c=tr.querySelectorAll('td');
      if(c.length===3) rows.push([c[0].innerText,c[1].innerText,c[2].innerText]);
    });
    if(rows.length<=1){ alert('Sin datos para exportar'); return; }
    const csv=rows.map(r=>r.join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='produccion.csv';
    a.click();
  }
  function openProdOverlay(){
    $('prodOverlay').style.display='block';
    $('prodOverlay').setAttribute('aria-hidden','false');

    ['prodFrom','prodTo'].forEach(id=>{
      const el=$(id);
      if(el){ el.style.width='150px'; el.style.minWidth='120px'; el.style.maxWidth='160px'; }
    });

    if(!$('btnProdReset')){
      const sel=$('prodDevice');
      const btn=document.createElement('button');
      btn.id='btnProdReset';
      btn.type='button';
      btn.className='btn small';
      btn.textContent='Borrar';
      btn.onclick=prodResetFilters;
      sel.parentElement.style.display='flex';
      sel.parentElement.style.gap='8px';
      sel.parentElement.appendChild(btn);
    }

    const showBtn=$('btnProdShow');
    if(showBtn && !$('btnProdCSV')){
      const csv=document.createElement('button');
      csv.id='btnProdCSV';
      csv.type='button';
      csv.className='btn small';
      csv.textContent='Descargar CSV';
      csv.style.display='none';
      csv.onclick=prodDownloadCSV;
      showBtn.parentElement.appendChild(csv);
    }
  }
  function prodResetFilters(){
    const hoy=ymd(new Date());
    $('prodFrom').value=hoy;
    $('prodTo').value=hoy;
    $('prodDevice').value='';
    const tb=$('prodGlobalTbody');
    tb.innerHTML='<tr><td class="muted" colspan="3">Sin datos</td></tr>';
    setText('prodGlobalTotal','0.00');
    if($('btnProdCSV')) $('btnProdCSV').style.display='none';
  }
  function closeProdOverlay(){
    $('prodOverlay').style.display='none';
    $('prodOverlay').setAttribute('aria-hidden','true');
  }

  // Toggle tabla lecturas
  $('toggleTbl').onclick=()=>{ const w=$('tableWrap'); w.style.display=w.style.display==='none'?'block':'none'; };

  // Polling
  let polling=false;
  async function loadDatapoints(){
    if(polling) return;
    polling=true;
    try{
      const { items } = await callWorker('/datapoints?limit=200');
      lastItemsCache = items;
      renderTable(items);
      updateLastReading(items);
      updateMotherKPIs(items);
      await renderDeviceCards(items);
      if(chartsVisible && !historyMode) renderChartsDaily(items);
      if(currentOverlayDevice){
        updateOverlayKPIs(lastItemsCache, currentOverlayDevice);
        if(ovChartsVisible){ renderOverlayChartsDaily(lastItemsCache, currentOverlayDevice); }
        renderWorkSection(lastItemsCache, currentOverlayDevice);
      }
    }finally{
      polling=false;
    }
  }
  setInterval(()=>{ if(auth.currentUser) loadDatapoints().catch(()=>{}); }, 15000);

  function initProdDefaults(){
    const t = ymd(new Date());
    const ovd = $('ovProdDate'); if(ovd) ovd.value = t;
    const pf=$('prodFrom'), pt=$('prodTo'); if(pf) pf.value=t; if(pt) pt.value=t;
  }

  // ======== TRABAJO sección en overlay ========
  let workChart = null;

  function filterWorkSeries(items, deviceId, fromT, toT){
    const KEYS = ['C2R','NHR','NXR','ALR','SMR'];
    const byKey = Object.fromEntries(KEYS.map(k=>[k,[]]));
    const labelSet = new Set();

    for(const d of (items||[])){
      if(String(d.device_id)!==String(deviceId)) continue;
      const k = String(d.sensor_key||'').toUpperCase().trim();
      if(!KEYS.includes(k)) continue;
      const t = new Date(d.ts).getTime();
      if(t<fromT || t>toT) continue;
      const y = Number(d.value)||0;
      const tMin = Math.floor(t/60000)*60000;
      byKey[k].push({ t: tMin, y });
      labelSet.add(tMin);
    }

    const labelsTs = Array.from(labelSet).sort((a,b)=>a-b);
    const labels = labelsTs.map(ts=>new Date(ts).toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit'}));
    const maps = {};
    for(const k of Object.keys(byKey)){
      const m = new Map();
      byKey[k].sort((a,b)=>a.t-b.t);
      for(const p of byKey[k]) m.set(p.t, p.y);
      maps[k] = m;
    }
    const palette = { C2R:'#ffb74d', NHR:'#4da3ff', NXR:'#ff6b6b', ALR:'#7fb3ff', SMR:'#49d17d' };
    const datasets = Object.keys(byKey).map(k=>({
      label:k,
      data: labelsTs.map(ts=> maps[k].has(ts) ? maps[k].get(ts) : null),
      borderColor: palette[k]||'#ccc',
      backgroundColor: 'transparent',
      borderWidth:2, tension:.25, pointRadius:0, spanGaps:true
    }));
    return { labels, datasets };
  }

  function renderWorkSection(items, deviceId) {
    const { dayMs, weekMs, monthMs, yearMs } = calcWorkTotals_fromItems(items, deviceId);
    setText('workToday', `Trabajo de hoy: ${formatHM_fromMs(dayMs)}`);
    setText('workWeek', `Trabajo de la semana: ${formatHM_fromMs(weekMs)}`);
    setText('workMonth', `Trabajo del mes: ${formatHM_fromMs(monthMs)}`);
  }

  function renderWorkCharts(items, deviceId, range){
    if (!items || !deviceId) return;
    const fromT = range?.fromT ?? 0;
    const toT   = range?.toT   ?? Date.now();
    const { labels, datasets } = filterWorkSeries(items, deviceId, fromT, toT);

    if (workChart) workChart.destroy();
    workChart = new Chart($('workChart').getContext('2d'), {
      type: 'line',
      data: { labels, datasets },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:true} },
        interaction:{mode:'nearest',intersect:false},
        scales:{
          x:{ title:{display:true,text:'Hora'} },
          y:{ beginAtZero:true }
        }
      }
    });
  }

  async function getWorkDataFor(period, deviceId){
    if(period==='dia') return lastItemsCache || [];
    const { fromISO, toISO } = periodBounds(period);
    return await workFetchRange(fromISO, toISO, deviceId);
  }

  $('btnWorkChart').onclick = async ()=>{
    const wrap = $('workChartWrap');
    const visible = getComputedStyle(wrap).display !== 'none';
    wrap.style.display = visible ? 'none' : 'block';
    $('btnWorkChart').textContent = visible ? 'Mostrar gráficos' : 'Ocultar gráficos';
    if (visible) return;

    if (currentOverlayDevice){
      const period = $('workRange')?.value || 'dia';
      const data = await getWorkDataFor(period, currentOverlayDevice);
      const { fromT, toT } = periodBounds(period);
      renderWorkCharts(data, currentOverlayDevice, {fromT, toT});
    }
  };
  $('btnWorkCSV').onclick = ()=>{
    if (!currentOverlayDevice || !lastItemsCache) return;
    downloadWorkCSV(lastItemsCache, currentOverlayDevice);
  };
  $('workRange').onchange = async ()=>{
    const wrap = $('workChartWrap');
    const visible = getComputedStyle(wrap).display !== 'none';
    if (!visible || !currentOverlayDevice) return;
    const period = $('workRange').value || 'dia';
    const data = await getWorkDataFor(period, currentOverlayDevice);
    const { fromT, toT } = periodBounds(period);
    renderWorkCharts(data, currentOverlayDevice, {fromT, toT});
  };
  $('btnWorkHistToggle').onclick = ()=>{
    const c = $('workHistControls');
    const show = c.style.display === 'none';
    c.style.display = show ? 'flex' : 'none';
    $('btnWorkHistToggle').textContent = show ? 'Ocultar historial' : 'Historial';
    if(show){
      const t = ymd(new Date());
      $('workDateFrom').value = t;
      $('workDateTo').value   = t;
    }
  };
  $('btnWorkHistShow').onclick = async ()=>{
    const df = $('workDateFrom').value, dt = $('workDateTo').value;
    if(!df || !dt || !currentOverlayDevice) return;
    const fromISO = new Date(df+'T00:00:00').toISOString();
    const toISO   = new Date(dt+'T23:59:59.999').toISOString();
    const items = await workFetchRange(fromISO, toISO, currentOverlayDevice);
    const fromT = new Date(df+'T00:00:00').getTime();
    const toT   = new Date(dt+'T23:59:59.999').getTime();
    renderWorkCharts(items, currentOverlayDevice, {fromT, toT});
  };
  $('btnWorkHistCSV').onclick = async ()=>{
    const df = $('workDateFrom').value, dt = $('workDateTo').value;
    if(!df || !dt || !currentOverlayDevice) return;
    await downloadWorkCSV(currentOverlayDevice, df, dt);
  };
  async function downloadWorkCSV(deviceId, df=null, dt=null) {
    let data = lastItemsCache || [];
    if (df && dt){
      const fromISO = new Date(df+'T00:00:00').toISOString();
      const toISO   = new Date(dt+'T23:59:59.999').toISOString();
      data = await workFetchRange(fromISO, toISO, deviceId);
    }
    const keys = ['OPN','MS','C2R','NHR','NXR','ALR','SMR'];
    const relevant = data.filter(d =>
      String(d.device_id) === String(deviceId) &&
      keys.includes(String(d.sensor_key).toUpperCase())
    );
    if (!relevant.length) { alert('Sin datos de trabajo'); return; }
    const rows = [['timestamp_iso','fecha_local','hora_local','device_id','sensor','valor']];
    for (const d of relevant){
      const ts = new Date(d.ts);
      rows.push([
        ts.toISOString(),
        ts.toLocaleDateString('es-AR'),
        ts.toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit',second:'2-digit'}),
        d.device_id, d.sensor_key, d.value
      ]);
    }
    const csv = rows.map(r=>r.join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = df && dt ? `trabajo_${deviceId}_${df}_a_${dt}.csv` : `trabajo_${deviceId}.csv`;
    a.click(); URL.revokeObjectURL(url);
  }

  // ===== Modal de configuración (carta modelo) =====
  let editTargetId = null;
  const segK = $('segKilos');
  const segT = $('segTrabajo');
  function setSegPressed(segEl, mode){
    segEl.querySelectorAll('button').forEach(b=>{
      b.setAttribute('aria-pressed', String(b.dataset.mode===mode));
    });
  }
  function currentSegMode(segEl){
    const b=[...segEl.querySelectorAll('button')].find(x=>x.getAttribute('aria-pressed')==='true');
    return b?.dataset?.mode;
  }
  function openEditModel(deviceId){
    editTargetId = String(deviceId||'');
    setText('editModelHive', `Colmena ${editTargetId||'—'}`);

    const pref = getPrefFor(editTargetId);
    setSegPressed(segK, pref.kilos);    // mes | semana | anio
    setSegPressed(segT, pref.trabajo);  // dia | semana | anio
    // Vista previa simple
    updateModelPreview();

    const wrap=$('editModelWrap');
    wrap.style.display='flex';
  }
  function closeEditModel(){
    const wrap=$('editModelWrap');
    wrap.style.display='none';
    editTargetId=null;
  }
  function updateModelPreview(){
    const kmode = currentSegMode(segK)||'mes';
    const tmode = currentSegMode(segT)||'semana';
    const rows = [
      { color:'var(--ok)', label:`Kilos ${kmode==='anio'?'año':kmode}`, value:'—' },
      { color:'var(--focus)', label:`Trabajo ${tmode==='dia'?'diario':(tmode==='anio'?'anual':tmode)}`, value:'—' }
    ];
    const cont = document.querySelector('.model-rows');
    if(cont){
      cont.innerHTML = rows.map(r=>
        `<div class="model-row"><span class="model-dot" style="background:${r.color}"></span><span>${escapeHtml(r.label)}</span><span class="model-chip">${r.value}</span></div>`
      ).join('');
    }
  }
  // toggles
  segK.addEventListener('click',e=>{
    const b=e.target.closest('button'); if(!b) return;
    setSegPressed(segK, b.dataset.mode);
    updateModelPreview();
  });
  segT.addEventListener('click',e=>{
    const b=e.target.closest('button'); if(!b) return;
    setSegPressed(segT, b.dataset.mode);
    updateModelPreview();
  });

  $('btnCancelEdit').onclick = ()=> closeEditModel();
  $('btnConfirmEdit').onclick = async ()=>{
    if(!editTargetId) return;
    const kmode=currentSegMode(segK)||'mes';
    const tmode=currentSegMode(segT)||'semana';
    setPrefFor(editTargetId, { kilos:kmode, trabajo:tmode });
    closeEditModel();
    // refrescar tarjetas con las nuevas preferencias
    await renderDeviceCards(lastItemsCache||[]);
  };

  // ===== Clima (nuevo flujo por texto) =====
  const wxMap = {0:'Despejado',1:'Mayormente despejado',2:'Parcialmente nublado',3:'Nublado',45:'Niebla',48:'Niebla escarchada',51:'Llovizna',61:'Lluvia',71:'Nieve',80:'Chubascos'};
  function wxEmoji(code){ if([0].includes(code)) return '☀️'; if([1,2].includes(code)) return '🌤️'; if([3].includes(code)) return '☁️'; if([45,48].includes(code)) return '🌫️'; if([51,53,55].includes(code)) return '🌦️'; if([61,63,65,80,81,82].includes(code)) return '🌧️'; if([71,73,75].includes(code)) return '❄️'; return '⛅'; }
  function setWxButtonsState(state){
    const open=$('btnWxOpen'), reset=$('btnWxReset'), row=$('wxInputRow'), content=$('wxContent');
    if(state==='ready'){ open.style.display='inline-flex'; reset.style.display='none'; row.style.display='none'; content.classList.add('wx-blur'); setText('wxWhere','Ubicación no establecida'); setText('wxNow','— °C'); setText('wxNowMeta','—'); setText('wxTodayMM','Máx —° · Mín —° · 💧 —mm'); $('wxTiles').innerHTML=''; }
    if(state==='input'){ open.style.display='none'; reset.style.display='none'; row.style.display='flex'; }
    if(state==='fixed'){ open.style.display='none'; reset.style.display='inline-flex'; row.style.display='none'; $('wxContent').classList.remove('wx-blur'); }
  }
  $('btnWxOpen').onclick = ()=>{ setWxButtonsState('input'); $('wxQuery').focus(); };
  $('btnWxReset').onclick = ()=>{ clearWxPlace(); setWxButtonsState('ready'); };
  $('btnWxFind').onclick = ()=> doWxSearch();
  $('wxQuery').addEventListener('keydown',e=>{ if(e.key==='Enter') doWxSearch(); });
  async function doWxSearch(){
    const q = String(($('wxQuery').value||'').trim());
    if(!q) return;
    const m = q.match(/^\s*(-?\d+(?:\.\d+)?)\s*,\s*(-?\d+(?:\.\d+)?)\s*$/);
    if(m){
      const lat = parseFloat(m[1]), lon=parseFloat(m[2]);
      const label = `Lat ${lat.toFixed(2)}, Lon ${lon.toFixed(2)}`;
      await renderWeather(lat, lon, label);
      saveWxPlace({lat,lon,label});
      setWxButtonsState('fixed');
      return;
    }
    try{
      const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=1&language=es&format=json`;
      const r = await fetch(url); const j = await r.json();
      if(!j?.results?.length){ alert('No se encontró la ubicación. Probá con ciudad, provincia, país o “lat,lon”.'); return; }
      const g = j.results[0];
      const parts = [g.name, g.admin1, g.country].filter(Boolean);
      const label = parts.join(', ');
      await renderWeather(g.latitude, g.longitude, label);
      saveWxPlace({lat:g.latitude, lon:g.longitude, label});
      setWxButtonsState('fixed');
    }catch(e){
      alert('Error buscando ubicación');
    }
  }
  async function renderWeather(lat, lon, label){
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=auto&forecast_days=4`;
    const r = await fetch(url); const j = await r.json();
    const current = j.current || {};
    const daily = j.daily || {};
    document.getElementById('wxContent').classList.remove('wx-blur');
    setText('wxNow', (current.temperature_2m!=null? Math.round(current.temperature_2m)+' °C':'—'));
    setText('wxWhere', label || `Lat ${lat.toFixed(2)}, Lon ${lon.toFixed(2)}`);
    setText('wxNowMeta', `${wxMap[current.weather_code]||'—'} · HR ${current.relative_humidity_2m??'—'}%`);
    if(daily.time?.length){
      const max0 = Math.round(daily.temperature_2m_max?.[0] ?? NaN);
      const min0 = Math.round(daily.temperature_2m_min?.[0] ?? NaN);
      const pr0  = Math.round((daily.precipitation_sum?.[0] ?? 0));
      setText('wxTodayMM', `Máx ${isNaN(max0)?'—':max0}° · Mín ${isNaN(min0)?'—':min0}° · 💧 ${pr0}mm`);
    }
    const tiles = (daily.time||[]).slice(1,4).map((d,i)=>{
      const idx = i+1;
      const code = daily.weather_code?.[idx], tmax = daily.temperature_2m_max?.[idx], tmin = daily.temperature_2m_min?.[idx], pr = daily.precipitation_sum?.[idx];
      const dt = new Date(d); const lab = dt.toLocaleDateString('es-AR',{weekday:'short', day:'2-digit'});
      return `<div class="wx-tile">
        <div class="wx-small">${lab}</div>
        <div style="font-size:1.2rem">${wxEmoji(code)}</div>
        <div class="wx-small">${wxMap[code]||'—'}</div>
        <div class="wx-small">${Math.round(tmax)}° / ${Math.round(tmin)}°</div>
        <div class="wx-small">💧 ${Math.round(pr||0)}mm</div>
      </div>`;
    }).join('');
    $('wxTiles').innerHTML = tiles;
  }
</script>

</body>
</html>
