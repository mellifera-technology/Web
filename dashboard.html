<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Panel — MIELLIFERA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="assets/logo.svg" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
</head>
<body>
  <div id="bg-orb" aria-hidden="true"></div>

  <header id="site-header" class="header" role="banner">
    <div class="nav-grid">
      <a class="brand" href="index.html" aria-label="Inicio">MIELLIFERA</a>
      <nav class="nav-center" aria-label="Principal">
        <a href="index.html#solucion">Solución</a>
        <a href="index.html#como-funciona">Cómo funciona</a>
        <a href="index.html#hardware">Hardware</a>
        <a href="index.html#seguridad">Seguridad</a>
        <a href="index.html#faqs">FAQs</a>
        <a href="index.html#contacto">Contacto</a>
      </nav>
      <button id="btnLogout" class="cta" type="button">Salir</button>
    </div>
  </header>

  <main class="site">
  <section class="section alt">
    <div class="section-head">
      <h2>Tu panel</h2>
      <p>Código de vinculación, dispositivos y lecturas.</p>
    </div>

    <div class="split">
      <div class="card" style="max-width:420px">
        <h3>Cuenta</h3>
        <p>Email: <b id="uEmail">—</b></p>
        <p>Código de 4 dígitos: <b id="uCode">—</b></p>
        <div id="msg" class="muted" style="margin-top:8px"></div>
        <hr>
        
      </div>

      <div class="card" style="flex:1">
        <h3>Eventos y mediciones (últimas 200)</h3>
<table id="tbl" style="width:100%">
  <thead>
    <tr>
      <th>Fecha</th><th>Dispositivo</th><th>Sensor</th><th>Valor / Info</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

      </div>
    </div>
  </section>
</main>


  <footer class="footer">
    <span>© <span id="year"></span> MIELLIFERA</span>
  </footer>

<script>
  // Año footer
  document.getElementById('year').textContent = new Date().getFullYear();

  // --- Firebase ---
  const firebaseConfig = {
    apiKey: "AIzaSyBH93vOKldh-IufVCZB1qyI6cRPoOr7iqw",
    authDomain: "mellifera-technology.firebaseapp.com",
    projectId: "mellifera-technology",
    storageBucket: "mellifera-technology.firebasestorage.app",
    messagingSenderId: "68043353319",
    appId: "1:68043353319:web:20a1aafde7b37d3457c642",
    measurementId: "G-FCW1E604DG"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();

  // --- Worker base URL ---
  const WORKER_BASE = "https://mellifera-worker.mellifera-tech.workers.dev";
  const BASE = WORKER_BASE.replace(/\/+$/, ''); // quita barra final

  const $ = id => document.getElementById(id);
  const setText = (id, t)=>{ const el=$(id); if(el) el.textContent=t; };

  // --- Login guard ---
  auth.onAuthStateChanged(async (u)=>{
    if(!u){ location.href = 'login.html'; return; }
    setText('uEmail', u.email || '(sin email)');
    try {
      const { code } = await callWorker('/ensure_user', { method:'POST' });
      setText('uCode', code || '—');
      await loadDatapoints();

    } catch(e){
      console.error(e);
      alert("Error cargando datos: " + (e.message||e));
    }
  });

  $('btnLogout').onclick = ()=> auth.signOut().then(()=>location.href='login.html');

  // --- Llamadas al Worker ---
  async function callWorker(path, opts={}){
    const u = auth.currentUser; if(!u) throw new Error('No auth');
    const t = await u.getIdToken();
    const p = path.startsWith('/') ? path : `/${path}`;
    const res = await fetch(`${BASE}${p}`, {
      method: opts.method || 'GET',
      headers: { 'Authorization': `Bearer ${t}`, 'Content-Type': 'application/json' },
      body: opts.body ? JSON.stringify(opts.body) : undefined
    });
    if(!res.ok) throw new Error(await res.text());
    return res.json();
  }

  // --- Cargar lecturas ---
  // Reemplaza loadReadings() por esto:
  async function loadDatapoints(){
    const { items } = await callWorker('/datapoints?limit=200'); // requiere GET /datapoints en el Worker
    const rows = (items||[]).map(d=>{
      const dt = new Date(d.ts).toLocaleString();
      const isEvent = String(d.sensor_key||'').startsWith('EVENT.');
      const isAlert = String(d.device_id||'').toUpperCase()==='ALERT';
      const cls = isEvent || isAlert ? 'row-alert' : '';
      const val = isEvent
        ? (d.meta?.info || d.meta?.type || JSON.stringify(d.meta||{}))
        : (d.value==null ? '' : Number(d.value).toFixed(2));
      return `<tr class="${cls}">
        <td>${dt}</td>
        <td>${d.device_id||''}</td>
        <td>${d.sensor_key||''}</td>
        <td>${val}</td>
      </tr>`;
    }).join('');
    document.querySelector('#tbl tbody').innerHTML = rows;
  }

  // En tu onAuthStateChanged, donde llamabas a loadReadings(), cambiá por:
  //   await loadDatapoints();

  // Y reemplazá el setInterval por este:
  setInterval(()=>{ if(auth.currentUser) loadDatapoints().catch(()=>{}); }, 15000);


  const fmt = v => (v==null||Number.isNaN(+v)) ? '' : Number(v).toFixed(2);
</script>

</body>
</html>
