<!DOCTYPE html>
<html lang="es">
<head> 
  <meta charset="utf-8" />
  <title>Panel ‚Äî MIELLIFERA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="assets/logo.svg" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="blacklogo.png" />
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
  /* =========================================================
   *  VARIABLES Y BASE
   * =======================================================*/
  :root {
    /* Colores base */
    --bg: #0e0f12;
    --bg-soft: #13151a;
    --card: #171a21;
    --card-2: #1b1f27;

    /* Texto / bordes */
    --text: #eef0f3;
    --muted: #b8bec7;
    --border: #262b35;
    --zebra: #141820;

    /* Acentos / estados */
    --accent: #ffd54f;
    --accent-600: #f0c12c;
    --focus: #7fb3ff;
    --blue-ln: rgba(77, 163, 255, .45);
    --blue-pt: #4da3ff;
    --amber-ln: rgba(255, 183, 77, .55);
    --amber-pt: #ff7043;
    --ok: #49d17d;
    --warn: #ffb74d;
    --bad: #ff6b6b;
    --idle: #9aa3ad;

    /* Chips / fondos intermedios */
    --chip-bg: #10141a;
  }

  html,
  body {
    height: 100%;
  }

  body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font-family: Inter, system-ui, Arial;
    font-size: 16.5px;
    line-height: 1.6;
  }

  /* Contenedor general del contenido */
  .site {
    padding: 24px;
    max-width: 1200px;
    margin: 0 auto;
  }

  /* =========================================================
   *  HEADER / NAVBAR
   * =======================================================*/
  .header {
    position: sticky;
    top: 0;
    z-index: 10;
    background: rgba(14, 15, 18, .9);
    border-bottom: 1px solid var(--border);
    backdrop-filter: blur(6px);
  }

  .nav-grid {
    display: grid;
    grid-template-columns: 1fr auto auto;
    gap: 16px;
    align-items: center;
    padding: 12px 16px;
  }

  .brand {
    color: var(--accent);
    text-decoration: none;
    font-weight: 800;
  }

  .nav-center a {
    color: #d6dae0;
    text-decoration: none;
    margin: 0 10px;
  }

  .cta {
    background: var(--accent);
    color: #111;
    border: 0;
    padding: 9px 14px;
    border-radius: 10px;
    font-weight: 700;
    cursor: pointer;
  }

  /* =========================================================
   *  SECCIONES PRINCIPALES (panel, historial, etc.)
   * =======================================================*/
  .section {
    margin: 28px auto;
  }

  /* Caja del panel principal */
  .section.alt {
    background: var(--bg-soft);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 16px;
  }

  .section-head {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
  }

  /* Layout de 2 columnas: izquierda (cuenta/clima), derecha (KPI/gr√°ficas) */
  .split {
    display: grid;
    grid-template-columns: 420px 1fr;
    gap: 18px;
  }

  @media (max-width: 980px) {
    .split {
      grid-template-columns: 1fr;
    }
  }

  /* =========================================================
   *  TARJETAS / CARDS GENERALES
   * =======================================================*/
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
  }

  /* Tarjetas de temperatura/humedad del panel principal */
  .side-cards {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  @media (max-width: 860px) {
    .side-cards {
      grid-template-columns: 1fr;
    }
  }

  /* Grid de tarjetas de colmenas (autoCards) */
  .cards-head {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    margin: 12px 0 6px;
  }

  .cards-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
  }

  @media (max-width: 860px) {
    .cards-grid {
      grid-template-columns: 1fr;
    }
  }

  /* =========================================================
   *  BOTONES / PASTILLAS / ESTILOS GENERALES
   * =======================================================*/
  .pill {
    background: var(--accent);
    color: #111;
    border: 2px solid var(--accent);
    border-radius: 999px;
    font-weight: 800;
    padding: 8px 14px;
    white-space: nowrap;
  }

  .btn {
    background: var(--card-2);
    color: var(--text);
    border: 1px solid var(--border);
    padding: 10px 16px;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
  }

  .btn.yellow {
    background: var(--accent);
    border-color: var(--accent);
    color: #111;
  }

  .btn.small {
    padding: 6px 10px;
    font-size: .9rem;
  }

  .center {
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .muted {
    color: var(--muted);
  }

  /* =========================================================
   *  CARTAS ‚ÄúMETA‚Äù (Sanidad, Calendario, Notas) EN EL PANEL
   * =======================================================*/
  /* Cartas bajo la gr√°fica principal en el dashboard */
  .meta-cards {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 16px;
    margin-top: 18px;
  }

  /* Meta cards como botones */
  .meta-cards .card{
    cursor: pointer;
    transition: transform .08s ease, border-color .08s ease;
  }
  .meta-cards .card:hover{
    transform: translateY(-1px);
    border-color: rgba(255,255,255,.18);
  }
  .meta-cards .card button{
    display:none; /* ocultamos el bot√≥n chico */
  }


  @media (max-width: 980px) {
    .meta-cards {
      grid-template-columns: 1fr;
    }
  }

  .meta-card-title {
    font-weight: 700;
    margin: 0 0 4px;
  }

  .meta-card-text {
    margin: 0;
    color: var(--muted);
    font-size: .9rem;
  }

  /* =========================================================
   *  OVERLAY META (Sanidad / Calendario / Notas)
   * =======================================================*/
  #metaOverlay {
    position: fixed;
    inset: 0;
    display: none;
    z-index: 1000;
    background: rgba(8, 10, 14, .95);
    backdrop-filter: blur(4px);
  }

  #metaPanel {
    position: absolute;
    inset: 0;
    display: grid;
    grid-template-rows: auto 1fr;
    max-width: 1200px;
    margin: 0 auto;
  }

  /* Tabs superiores del overlay meta */
  .meta-tabs {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 10px;
  }

  .meta-tabs button {
    background: #10141a;
    border: 1px solid var(--border);
    color: #fff;
    border-radius: 999px;
    padding: 6px 12px;
    cursor: pointer;
    font-weight: 600;
    font-size: .9rem;
  }

  .meta-tabs button.active {
    background: var(--accent);
    border-color: var(--accent);
    color: #111;
  }

  /* Secciones de contenido por tab (sanidad / calendario / notas) */
  .meta-section {
    display: none;
  }

  .meta-section.active {
    display: block;
  }

  /* Fila de filtros superiores en cada secci√≥n meta */
  .meta-filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 10px;
  }

  .meta-filter-row select,
  .meta-filter-row input[type="date"],
  .meta-filter-row input[type="month"] {
    background: #10141a;
    border: 1px solid var(--border);
    color: #fff;
    padding: 6px 10px;
    border-radius: 10px;
    font-size: .9rem;
  }

  /* Grilla de formulario dentro del overlay meta */
  .meta-form-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 10px;
    margin-bottom: 12px;
  }

  @media (max-width: 760px) {
    .meta-form-grid {
      grid-template-columns: 1fr;
    }
  }

  .meta-form-grid textarea {
    min-height: 80px;
    resize: vertical;
  }

  /* Lista tipo calendario dentro del overlay */
  .calendar-list-day {
    margin-bottom: 12px;
  }

  .calendar-list-day h4 {
    margin: 0 0 4px;
    font-size: .95rem;
    color: var(--muted);
  }

  .calendar-event {
    border-radius: 10px;
    padding: 8px 10px;
    margin-bottom: 4px;
    background: var(--card);
    border: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 8px;
  }

  .calendar-event-main {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .calendar-event-title {
    font-weight: 600;
  }

  .calendar-event-meta {
    font-size: .85rem;
    color: var(--muted);
  }

  /* Notas en el overlay meta */
  .note-item {
    border-radius: 10px;
    padding: 8px 10px;
    margin-bottom: 6px;
    background: var(--card);
    border: 1px solid var(--border);
  }

  .note-item-head {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
  }

  .note-item-meta {
    font-size: .85rem;
    color: var(--muted);
  }

  /* =========================================================
   *  TABLA HISTORIAL (panel principal)
   * =======================================================*/
  table {
    border-collapse: separate;
    border-spacing: 0;
    width: 100%;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
  }

  thead th {
    position: sticky;
    top: 0;
    background: var(--accent);
    color: #111;
    font-weight: 800;
    padding: 10px;
    border-bottom: 2px solid #caa332;
  }

  tbody td {
    padding: 10px;
    border-bottom: 1px solid var(--border);
  }

  tbody tr:nth-child(odd) {
    background: var(--zebra);
  }

  #tableWrap {
    box-shadow: 0 1px 0 rgba(0, 0, 0, .2) inset;
  }

  /* =========================================================
   *  CAMPOS OCULTAR / MOSTRAR (email / c√≥digo)
   * =======================================================*/
  .reveal-wrap {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  .eye-btn {
    background: #1d212a;
    border: 1px solid var(--border);
    color: #cfd6df;
    border-radius: 8px;
    cursor: pointer;
    padding: 4px 8px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .eye-btn svg {
    width: 18px;
    height: 18px;
  }

  /* =========================================================
   *  OVERLAY COLMENA (detalle de una colmena)
   * =======================================================*/
  #deviceOverlay {
    position: fixed;
    inset: 0;
    display: none;
    z-index: 1000;
    background: rgba(8, 10, 14, .95);
    backdrop-filter: blur(4px);
  }

  #devicePanel {
    position: absolute;
    inset: 0;
    display: grid;
    grid-template-rows: auto 1fr;
    max-width: 1200px;
    margin: 0 auto;
  }

  .overlay-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    background: #0f1218;
  }

  .overlay-content {
    padding: 16px;
    overflow: auto;
  }

  /* Grid superior en overlay de colmena (Temp / Hum) */
  .overlay-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(260px, 360px));
    gap: 16px;
    margin-bottom: 12px;
    justify-content: center;
  }


  @media (max-width: 1100px) {
    .overlay-grid {
      grid-template-columns: 1fr 1fr;
    }
  }

  @media (max-width: 760px) {
    .overlay-grid {
      grid-template-columns: 1fr;
    }
  }

  /* Estado ‚Äúedici√≥n‚Äù para tarjetas drag & drop (si aplica) */
  .editing .device-card {
    cursor: grab;
    animation: shake .9s ease-in-out infinite;
  }

  @keyframes shake {
    0% {
      transform: translate(0, 0);
    }

    25% {
      transform: translate(1px, -1px);
    }

    50% {
      transform: translate(-1px, 1px);
    }

    75% {
      transform: translate(1px, 0);
    }

    100% {
      transform: translate(0, 0);
    }
  }

  /* M√©tricas grandes (valor + unidad) */
  .metric {
    display: flex;
    align-items: baseline;
    gap: 10px;
    margin-top: 6px;
  }

  .metric .val {
    font-size: 2.4rem;
    font-weight: 800;
    letter-spacing: .3px;
  }

  .metric .unit {
    font-size: 1.05rem;
    font-weight: 800;
    color: #111;
    background: var(--accent);
    border-radius: 8px;
    padding: 2px 8px;
    border: 2px solid var(--accent);
  }

  /* Centrar tarjetas de Temp/Hum dentro del overlay de colmena */
  .overlay-grid .card {
    text-align: center;
  }

  .overlay-grid .card h3 {
    text-align: center;
    width: 100%;
  }

  .overlay-grid .card .metric {
    justify-content: center;
  }

  .overlay-grid .card .muted {
    text-align: center;
  }

  /* Botonera de modos: Trabajo / Aire / Movimiento */
  .mode-toggle {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 4px;
  }

  .mode-toggle button {
    background: #10141a;
    border: 1px solid var(--border);
    color: #fff;
    border-radius: 999px;
    padding: 6px 12px;
    cursor: pointer;
    font-weight: 600;
  }

  .mode-toggle button.selected {
    background: var(--accent);
    border-color: var(--accent);
    color: #111;
    box-shadow: 0 0 0 1px rgba(0, 0, 0, .3);
  }

    /* Panel desplegable dentro de la carta "Herramientas de an√°lisis" */
  .analysis-inline{
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border);
  }
  .analysis-inline .card{
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
    padding: 0 !important;
    margin-top: 0 !important;
  }
  .analysis-inline .card h3{
    margin-top: 0;
  }


  /* =========================================================
   *  GR√ÅFICAS (panel principal y overlay colmena)
   * =======================================================*/
  #chartsWrap {
    display: none;
    margin-top: 14px;
  }

  .chart-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px;
  }

  .charts-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  @media (max-width: 860px) {
    .charts-grid {
      grid-template-columns: 1fr;
    }
  }

  .chart-box {
    position: relative;
    height: 240px;
  }

  .chart-box canvas {
    position: absolute;
    inset: 0;
    width: 100% !important;
    height: 100% !important;
  }

    /* =========================================================
   *  TRABAJO: layout de gr√°fico + promedios
   * =======================================================*/
  .work-chart-grid{
    display: grid;
    grid-template-columns: 1fr 260px;
    gap: 14px;
    align-items: stretch;
  }
  @media (max-width: 860px){
    .work-chart-grid{
      grid-template-columns: 1fr;
    }
  }
  .work-chart-main h3{
    margin-top: 0;
  }
  .work-avg-panel{
    border-left: 1px solid var(--border);
    padding-left: 12px;
  }
  @media (max-width: 860px){
    .work-avg-panel{
      border-left: none;
      border-top: 1px solid var(--border);
      padding-left: 0;
      padding-top: 12px;
    }
  }
  .work-avg-title{
    font-weight: 800;
    margin-bottom: 8px;
  }
  .work-avg-grid{
    display: grid;
    grid-template-columns: 1fr;
    gap: 8px;
  }
  .work-avg-item{
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(255,255,255,.03);
    border: 1px solid rgba(255,255,255,.06);
    border-radius: 10px;
    padding: 8px 10px;
  }
  .work-avg-item .k{
    font-weight: 800;
    letter-spacing: .3px;
  }
  .work-avg-item .v{
    font-variant-numeric: tabular-nums;
    font-weight: 800;
  }
  .work-avg-foot{
    margin-top: 10px;
    font-size: .9rem;
  }


  /* Controles de historial para gr√°ficas (rango de fechas, botones) */
  .hist-controls {
    display: none;
    gap: 10px;
    align-items: end;
    margin-top: 10px;
    flex-wrap: wrap;
  }

  .hist-actions {
    display: flex;
    gap: 8px;
  }

  /* =========================================================
   *  DATE-CHIP (inputs de fecha con bot√≥n de calendario)
   * =======================================================*/
  .date-chip {
    display: inline-flex;
    align-items: center;
    gap: 0;
    background: var(--chip-bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
  }

  .date-chip input[type="date"] {
    appearance: none;
    -webkit-appearance: none;
    border: 0;
    background: transparent;
    color: #fff;
    font-weight: 600;
    padding: 8px 10px;
    cursor: pointer;
    min-width: 170px;
    line-height: 1.2;
  }

  .date-chip input[type="date"]::-webkit-calendar-picker-indicator {
    opacity: 0.9;
    cursor: pointer;
  }

  .cal-btn {
    background: var(--accent);
    border: 2px solid var(--accent);
    color: #111;
    border-radius: 0 10px 10px 0;
    padding: 8px 10px;
    display: inline-flex;
    align-items: center;
    cursor: pointer;
  }

  .cal-btn svg {
    width: 18px;
    height: 18px;
    color: #111;
  }

  .cal-btn:focus {
    outline: 2px solid var(--focus);
  }

  /* =========================================================
   *  PRODUCCI√ìN: FILTROS / INPUTS
   * =======================================================*/
  /* Filtros de producci√≥n en el overlay global */
  .prod-filters-grid {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 12px;
    align-items: flex-start; /* evita que las date-chip se estiren en altura */
  }

  /* Limitar ancho de las date-chip solo en secci√≥n producci√≥n */
  .prod-filters-grid .date-chip {
    max-width: 230px;
  }

  @media (max-width: 900px) {
    .prod-filters-grid {
      grid-template-columns: 1fr;
    }
  }

  /* Inputs de producci√≥n por colmena (Fecha + Kilos) */
  .prod-inputs {
    display: flex;
    gap: 10px;
    align-items: flex-start;
  }

  .prod-inputs .date-chip {
    max-width: 230px;
  }

  .prod-inputs .prod-kilos {
    background: #10141a;
    border: 1px solid var(--border);
    color: #fff;
    padding: 8px;
    border-radius: 10px;
    width: 160px;
  }

  /* Input-chip gen√©rico (actualmente para Kilos si se usa en otro contexto) */
  .input-chip {
    display: flex;
    align-items: center;
    background: #10141a;
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
  }

  .input-chip input {
    width: 100%;
    background: transparent;
    border: 0;
    color: #fff;
    padding: 8px 10px;
    line-height: 1.2;
  }
  /* ================= SANIDAD ================= */

.sanidad-layout {
  display: grid;
  grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.5fr);
  gap: 1.5rem;
  align-items: flex-start;
}

.sanidad-panel {
  background: var(--card-bg, #10141c);
  border-radius: 10px;
  padding: 1rem 1.25rem;
  box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.04);
}

.sanidad-panel h4 {
  margin: 0 0 .75rem;
  font-size: 0.95rem;
}

.sanidad-form .field-row,
.varroa-form .field-row {
  margin-bottom: .75rem;
}

.sanidad-form label,
.varroa-form label {
  display: flex;
  flex-direction: column;
  gap: .25rem;
  font-size: .85rem;
}

/* Sanidad/Barroa: dejamos que el date-chip mande en inputs type="date" */
.sanidad-form input[type="text"],
.sanidad-form input[type="number"],
.sanidad-form select,
.varroa-form input[type="number"],
.varroa-form select {
  padding: 0.55rem 0.7rem;
  border-radius: 10px;
  border: 1px solid var(--border-soft, #2a3240);
  background: var(--bg-soft, #0c1118);
  color: #f5f7fb;
  font-size: .9rem;
}


.sanidad-cards {
  display: grid;
  gap: .75rem;
}

.san-card {
  border-radius: 10px;
  padding: .75rem .9rem;
  background: radial-gradient(circle at 0 0, rgba(255,255,255,0.02), transparent 45%);
  border: 1px solid rgba(255,255,255,0.05);
  display: flex;
  flex-direction: column;
  gap: .5rem;
}

.san-card-ok {
  border-left: 4px solid var(--ok, #49d17d);
}

.san-card-late {
  border-left: 4px solid var(--bad, #ff6b6b);
  background: radial-gradient(circle at 0 0, rgba(255,0,0,0.06), transparent 55%);
}

.san-card-header {
  display: flex;
  align-items: baseline;
  justify-content: space-between;
  gap: .5rem;
}

.san-card-header h4 {
  margin: 0;
  font-size: .9rem;
}

.san-card-status {
  font-size: .7rem;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  padding: 0.1rem .4rem;
  border-radius: 999px;
  background: rgba(255,255,255,0.07);
}

.san-card-body {
  font-size: .8rem;
  display: flex;
  flex-direction: column;
  gap: .25rem;
}

.san-card-product {
  font-weight: 600;
}

.san-card-dates .label {
  opacity: .7;
  margin-right: .25rem;
}

.san-card-footer {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: .5rem .75rem;
  margin-top: .3rem;
}

.san-card-footer .field-inline {
  display: flex;
  flex-direction: column;
  gap: .2rem;
  font-size: .75rem;
}

.san-card-footer .field-inline.check {
  flex-direction: row;
  align-items: center;
  gap: .35rem;
}

.san-card-footer input[type="date"] {
  padding: 0.1rem 0.4rem;
  font-size: .8rem;
}

.san-card-footer .btn.btn-small {
  font-size: .75rem;
  padding: 0.25rem .6rem;
}

/* Historial sanidad */

.sanidad-historial {
  margin-top: .5rem;
}

.sanidad-hist-filters {
  display: grid;
  grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr) minmax(0, 1fr) auto;
  gap: .6rem 1rem;
  align-items: end;
  margin-bottom: .7rem;
}

@media (max-width: 720px){
  .sanidad-hist-filters { grid-template-columns: 1fr; }
}

.sanidad-hist-filters label {
  display: flex;
  flex-direction: column;
  gap: .25rem;
  font-size: .85rem;
}

.sanidad-hist-filters > button {
  height: 42px;
}


/* ================= BARROA ================= */

.varroa-layout {
  display: grid;
  grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.5fr);
  gap: 1.5rem;
  align-items: flex-start;
}

.varroa-panel {
  background: var(--card-bg, #10141c);
  border-radius: 10px;
  padding: 1rem 1.25rem;
  box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.04);
}

.varroa-panel h4 {
  margin: 0 0 .75rem;
  font-size: 0.95rem;
}

.varroa-filters {
  display: grid;
  grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr) minmax(0, 1fr) auto;
  gap: .6rem 1rem;
  align-items: end;
  margin-bottom: .7rem;
}

@media (max-width: 720px){
  .varroa-filters { grid-template-columns: 1fr; }
}

.varroa-filters label {
  display: flex;
  flex-direction: column;
  gap: .25rem;
  font-size: .85rem;
}

.varroa-filters > button {
  height: 42px;
}


/* Pastilla de % barroa */

.varroa-pill {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0.1rem 0.55rem;
  border-radius: 999px;
  font-size: .8rem;
  font-weight: 600;
  min-width: 3.5rem;
  text-align: center;
}

.varroa-green {
  background: rgba(73, 209, 125, 0.15);
  border: 1px solid #49d17d;
  color: #1b7e3a;
}

.varroa-yellow {
  background: rgba(255, 215, 0, 0.12);
  border: 1px solid #ffeb3b;
  color: #c69a00;
}

.varroa-orange {
  background: rgba(255, 152, 0, 0.16);
  border: 1px solid #ff9800;
  color: #f57c00;
}

.varroa-red {
  background: rgba(244, 67, 54, 0.18);
  border: 1px solid #f44336;
  color: #ff7961;
}

.varroa-red-strong {
  background: radial-gradient(circle at 20% 0, rgba(255, 0, 0, 0.25), transparent 55%);
  border: 1px solid #ff1744;
  color: #ff8a80;
}

.varroa-warning {
  margin-left: .35rem;
  font-size: .9rem;
  color: #ff9800;
  cursor: help;
}

  /* ================= NOTAS ================= */

  .notes-layout{
    display: grid;
    grid-template-columns: minmax(0, 1.15fr) minmax(0, 1.55fr);
    gap: 1.5rem;
    align-items: flex-start;
  }

  @media (max-width: 900px){
    .notes-layout{ grid-template-columns: 1fr; }
  }

  .notes-panel{
    background: var(--card-bg, #10141c);
    border-radius: 12px;
    padding: 1.05rem 1.25rem;
    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.04);
  }

  .notes-panel h4{
    margin: 0 0 .85rem;
    font-size: 1.02rem;
  }

  .notes-panel-head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
    margin-bottom: .6rem;
  }

  .notes-filters{
    display: grid;
    grid-template-columns: minmax(0, 1fr);
    gap: .75rem;
    align-items: end;
    margin-bottom: .9rem;
  }

  .notes-filters label,
  .notes-form label{
    display:flex; 
    flex-direction:column;
    gap:.25rem;
    font-size:.9rem;
  }

  .notes-form .ui-select,
  .notes-filters .ui-select,
  .notes-form .ui-textarea{
    border-radius: 12px;
    padding: 10px 12px;
    font-size: 1rem;
  }

  .notes-form .ui-textarea{
    min-height: 140px;
    line-height: 1.35;
  }

  #metaNotas #btnNoteSave{
    height: 44px;
  }

  #metaNotas #btnNotesReload{
    height: 40px;
  }

  /* Tarjetas de anotaciones: agrandadas (reusa el HTML que arma refreshNotas) */
  #metaNotas .note-item{
    border-radius: 12px;
    padding: 10px 12px;
    margin-bottom: 10px;
    background: rgba(255,255,255,0.02);
    border: 1px solid var(--border);
  }

  #metaNotas .note-item-head{
    gap: 12px;
  }

  #metaNotas .note-item-meta{
    font-size: .9rem;
  }

  /* el texto es el 2do <div> dentro de .note-item */
  #metaNotas .note-item > div:last-child{
    margin-top: 8px;
    white-space: pre-wrap;
    line-height: 1.35;
    font-size: 1rem;
  }


  /* ================== Reina ================== */

  .queen-layout{
    display:grid;
    grid-template-columns: minmax(0,1.2fr) minmax(0,1.3fr);
    gap:16px;
  }

  @media(max-width:900px){
    .queen-layout{
      grid-template-columns:1fr;
    }
  }

  .queen-main-card{
    text-align:center;
  }

  .queen-circle-wrap{
    display:flex;
    justify-content:center;
    align-items:center;
    margin:18px 0 10px;
  }

  .queen-circle{
    width:120px;
    height:120px;
    border-radius:50%;
    border:6px solid var(--border);
    background:radial-gradient(circle at 30% 30%, #ffffff, #cfd6df);
    box-shadow:0 0 0 4px rgba(0,0,0,.35),
              0 0 24px rgba(0,0,0,.7);
  }

  .queen-year-label{
    font-size:1.8rem;
    font-weight:800;
    letter-spacing:.05em;
  }

  .queen-legend{
    font-size:.9rem;
    margin-top:6px;
  }

  /* Panel lateral */
  .queen-side{
    display:flex;
    flex-direction:column;
    gap:16px;
  }

  .queen-form-row{
    display:flex;
    flex-direction:column;
    gap:4px;
    margin-bottom:12px;
    text-align:left;
  }

  .queen-form-row input{
    background:#10141a;
    border:1px solid var(--border);
    color:#fff;
    padding:8px 10px;
    border-radius:10px;
  }

  /* Historial */
  .queen-history-head{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    margin-bottom:8px;
  }

  .queen-history-body{
    max-height:220px;
    overflow:auto;
  }

  .queen-history-list{
    list-style:none;
    padding:0;
    margin:0;
  }

  .queen-history-item{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:8px;
    padding:8px 10px;
    border-radius:10px;
    background:var(--card);
    border:1px solid var(--border);
    margin-bottom:6px;
  }

  .queen-history-item-main{
    display:flex;
    flex-direction:column;
    gap:2px;
  }

  .queen-history-year{
    font-weight:700;
  }

  .queen-history-meta{
    font-size:.85rem;
    color:var(--muted);
  }

  /* Leyenda de colores */
  .queen-color-legend{
    margin-top:16px;
  }

  .queen-color-grid{
    display:flex;
    flex-wrap:wrap;
    gap:12px 24px;
  }

  .queen-color-item{
    display:flex;
    align-items:center;
    gap:8px;
    font-size:.9rem;
  }

  .queen-color-dot{
    width:16px;
    height:16px;
    border-radius:50%;
    border:2px solid #fff;
    box-shadow:0 0 0 1px rgba(0,0,0,.4);
  }

  /* Colores espec√≠ficos */
  .queen-color-white{ background:#fdfdfd; }
  .queen-color-yellow{ background:#ffd54f; }
  .queen-color-red{ background:#ff6b6b; }
  .queen-color-green{ background:#49d17d; }
  .queen-color-blue{ background:#4da3ff; }

  /* C√≠rculo principal adaptando color dinamicamente por JS:
    por defecto lo dejamos "blanco" y el JS pisa el background. */

  /* Tabla de producci√≥n m√°s compacta */
  .prod-table-small .prod-table-scroll {
    max-height: 220px;   /* ajust√° el alto a gusto */
    overflow: auto;
  }

  .prod-table-small table {
    font-size: 0.9rem;
  }

  .prod-table-small th,
  .prod-table-small td {
    padding: 4px 8px;
  }

  /* =========================================================
   *  TABLAS ‚ÄúNICE‚Äù (producci√≥n, sanidad, etc.)
   * =======================================================*/
  .nice-table {
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    background: var(--card);
  }

  .nice-table thead th {
    background: var(--accent);
    color: #111;
    border-bottom: 1px solid #caa332;
  }

  .nice-table tbody tr:nth-child(odd) {
    background: var(--zebra);
  }

  .nice-table td,
  .nice-table th {
    padding: 10px;
  }

  .nice-table td.num {
    text-align: right;
    font-variant-numeric: tabular-nums;
  }

  .badge {
    display: inline-block;
    background: #222;
    border: 1px solid var(--border);
    padding: 2px 8px;
    border-radius: 999px;
    font-weight: 700;
  }

  /* =========================================================
   *  STATUS DOT / INDICADORES DE ESTADO
   * =======================================================*/
  .status-row {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--muted);
    margin: .25rem 0 0;
  }

  .status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--idle);
    box-shadow: 0 0 0 2px rgba(0, 0, 0, .2) inset;
  }

  /* Alerta: por ejemplo ‚Äúcolmena abierta‚Äù */
  .status-dot.alert {
    background: var(--bad);
    animation: status-blink .8s ease-in-out infinite alternate;
  }

  @keyframes status-blink {
    from {
      opacity: 1;
    }

    to {
      opacity: .25;
    }
  }

  /* =========================================================
   *  CLIMA (tarjeta de pron√≥stico)
   * =======================================================*/
  .wx-card {
    background: linear-gradient(140deg, #0b0d12, #141926);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px;
    margin-top: 12px;
    position: relative;
    overflow: hidden;
  }

  /* Estado ‚Äúdesenfocado‚Äù cuando falta ubicaci√≥n */
  .wx-blur {
    filter: blur(3px);
    opacity: .6;
    pointer-events: none;
  }

  .wx-head {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    gap: 8px;
    flex-wrap: wrap;
  }

  .wx-title {
    font-weight: 800;
  }

  .wx-tiles {
    display: grid;
    grid-template-columns: repeat(7, minmax(92px, 1fr));
    gap: 8px;
    overflow-x: auto;
    padding-bottom: 4px;
  }


  .wx-tile {
    background: #10141a;
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 8px;
    text-align: center;
  }

  .wx-tile {
    cursor: pointer;
    user-select: none;
    transition: transform .08s ease, border-color .08s ease;
  }
  .wx-tile:hover { transform: translateY(-1px); }
  .wx-tile.selected {
    border-color: var(--accent);
    box-shadow: 0 0 0 1px rgba(0,0,0,.35);
  }

  .wx-results{
    display:none;
    margin: 0 0 10px;
    border: 1px solid var(--border);
    border-radius: 12px;
    background: #0f141b;
    overflow: hidden;
  }
  .wx-results button{
    width: 100%;
    text-align: left;
    padding: 10px 12px;
    background: transparent;
    border: 0;
    color: #fff;
    cursor: pointer;
    border-bottom: 1px solid rgba(255,255,255,.06);
  }
  .wx-results button:hover{ background: rgba(255,255,255,.06); }
  .wx-results button:last-child{ border-bottom: 0; }

  .wx-day-detail{
    margin-top: 10px;
    padding: 10px;
    background: #10141a;
    border: 1px solid var(--border);
    border-radius: 12px;
  }


  .wx-big {
    font-size: 1.6rem;
    font-weight: 800;
  }

  .wx-small {
    color: var(--muted);
    font-size: .9rem;
  }

  .wx-loc {
    color: var(--muted);
    font-size: .9rem;
  }

  .wx-today {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #10141a;
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px;
    margin-bottom: 8px;
  }

  .loc-chip {
    display: flex;
    gap: 8px;
    align-items: center;
    background: var(--chip-bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 6px 6px;
  }

  .loc-chip input {
    background: transparent;
    border: 0;
    color: #fff;
    padding: 6px;
    font-weight: 600;
    min-width: 220px;
  }

  .loc-chip input::placeholder {
    color: #8fa1b3;
  }

  /* =======================================================
 *  OVERLAY PRODUCCI√ìN: LAYOUT + GR√ÅFICOS + FORM
 * =====================================================*/
  #prodOverlay{
    position:fixed;
    inset:0;
    display:none;
    z-index:1000;
    background:rgba(8,10,14,.95);
    backdrop-filter:blur(4px);
  }

  #prodPanel{
    position:absolute;
    inset:0;
    display:grid;
    grid-template-rows:auto 1fr;
    max-width:1200px;
    margin:0 auto;
  }

  /* Cabecera del overlay (reutiliza .overlay-header) */
  /* Ya la ten√©s para otros overlays, la usamos igual */

  /* Grilla de gr√°ficos de producci√≥n */
  .prod-charts-grid{
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:16px;
    margin-bottom:18px;
  }

  @media(max-width:900px){
    .prod-charts-grid{
      grid-template-columns:1fr;
    }
  }

  /* Layout general filtros + tabla */
  .prod-layout{
    display:grid;
    grid-template-columns:320px minmax(0,1fr);
    gap:16px;
    align-items:flex-start;
    margin-top:8px;
  }

  @media(max-width:960px){
    .prod-layout{
      grid-template-columns:1fr;
    }
  }

  .prod-filters-column{
    display:flex;
    flex-direction:column;
    gap:8px;
  }

  .prod-table-column{
    min-width:0;
  }

  /* Filtros: fechas + colmena */
  .prod-filters-row{
    overflow: visible;

    display:grid;
    grid-template-columns:repeat(3,minmax(0,1fr));
    gap:10px;
  }

  @media(max-width:680px){
    .prod-filters-row{
      grid-template-columns:1fr 1fr;
    }
    .prod-filters-row .prod-field:last-child{
      grid-column:1 / -1;
    }
  }

  .prod-field{
    display:flex;
    flex-direction:column;
    gap:4px;
    font-size:.9rem;
  }

  .prod-field label{
    color:var(--muted);
  }

  .prod-field > input[type="date"],
  .prod-field > input[type="number"],
  .prod-field > select{
    background:#10141a;
    border:1px solid var(--border);
    color:#fff;
    padding:6px 8px;
    border-radius:8px;
    font-size:.9rem;
  }

  /* Producci√≥n: date-chip ancho completo + bot√≥n calendario bien ‚Äúclickeable‚Äù */
  .prod-filters-row .date-chip,
  #prodNewForm .date-chip,
  .sanidad-hist-filters .date-chip,
  .sanidad-form .date-chip,
  .varroa-filters .date-chip,
  .varroa-form .date-chip{
    width: 100%;
  }

  .prod-filters-row .date-chip input[type="date"],
  #prodNewForm .date-chip input[type="date"],
  .sanidad-hist-filters .date-chip input[type="date"],
  .sanidad-form .date-chip input[type="date"],
  .varroa-filters .date-chip input[type="date"],
  .varroa-form .date-chip input[type="date"]{
    min-width: 0;      /* pisa el min-width:170 del date-chip base */
    width: 100%;
    padding: 10px 12px;
  }


  /* Bot√≥n calendario: icono amarillo + borde amarillo (se entiende que es un bot√≥n) */
  .prod-filters-row .date-chip .cal-btn,
  #prodNewForm .date-chip .cal-btn,
  .sanidad-hist-filters .date-chip .cal-btn,
  .sanidad-form .date-chip .cal-btn,
  .varroa-filters .date-chip .cal-btn,
  .varroa-form .date-chip .cal-btn{
    padding: 10px 12px;
    background: rgba(255, 213, 79, 0.16);
    border: 1px solid var(--accent);
    color: var(--accent);
  }

  .prod-filters-row .date-chip .cal-btn svg,
  #prodNewForm .date-chip .cal-btn svg,
  .sanidad-hist-filters .date-chip .cal-btn svg,
  .sanidad-form .date-chip .cal-btn svg,
  .varroa-filters .date-chip .cal-btn svg,
  .varroa-form .date-chip .cal-btn svg{
    color: var(--accent);
  }

  .prod-filters-row .date-chip .cal-btn:hover,
  #prodNewForm .date-chip .cal-btn:hover,
  .sanidad-hist-filters .date-chip .cal-btn:hover,
  .sanidad-form .date-chip .cal-btn:hover,
  .varroa-filters .date-chip .cal-btn:hover,
  .varroa-form .date-chip .cal-btn:hover{
    background: rgba(255, 213, 79, 0.22);
  }

  .prod-filters-row .date-chip .cal-btn:active,
  #prodNewForm .date-chip .cal-btn:active,
  .sanidad-hist-filters .date-chip .cal-btn:active,
  .sanidad-form .date-chip .cal-btn:active,
  .varroa-filters .date-chip .cal-btn:active,
  .varroa-form .date-chip .cal-btn:active{
    transform: translateY(1px);
  }



  /* Botones filtros */
  .prod-actions-row{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-top:8px;
  }

  /* Caja ‚ÄúNueva producci√≥n‚Äù */
  .prod-new-box{
    margin-top:10px;
    padding:10px;
    border-radius:10px;
    background:var(--card);
    border:1px solid var(--border);
  }

  .prod-new-box h4{
    margin:0 0 6px;
    font-size:.95rem;
  }

  /* Tabla ‚Äúnice‚Äù que ya usabas */
  .nice-table{
    border:1px solid var(--border);
    border-radius:12px;
    overflow:hidden;
    background:var(--card);
  }

  .nice-table thead th{
    background:var(--accent);
    color:#111;
    border-bottom:1px solid #caa332;
  }

  .nice-table td,
  .nice-table th{
    padding:10px;
  }

  .nice-table tbody tr:nth-child(odd){
    background:var(--zebra);
  }

  .nice-table td.num{
    text-align:right;
    font-variant-numeric:tabular-nums;
  }
  

  /* === Ajustes visuales Producci√≥n / Calendarios === */
  .date-chip input[type="date"]::-webkit-calendar-picker-indicator{
    opacity: 0; /* ocultar icono nativo (evita doble calendario) */
    width: 0;
    height: 0;
  }


  #prodNewForm{
    display: grid;
    gap: 10px;
  }
  #prodNewForm button[type="submit"]{
    margin-top: 2px;
    width: 100%;
  }

  .prod-no-data{
    margin-top: 10px;
    padding: 10px;
    border-radius: 10px;
    border: 1px dashed var(--border);
    background: rgba(255,255,255,0.04);
    color: #cfd6df;
    font-weight: 700;
    text-align: center;
  }

  /* === Ocultar KPIs/Gr√°ficas exteriores sin romper updates === */
  .hide-exterior #extKpisWrap,
  .hide-exterior #btnChart,
  .hide-exterior #chartsWrap{
    display: none !important;
  }


  /* =========================================================
   *  UI - Controles oscuros (evita ‚Äúcajas blancas‚Äù)
   * =======================================================*/
  .ui-input, .ui-select, .ui-textarea{
    width:100%;
    background:#10141a;
    border:1px solid var(--border);
    color:#fff;
    border-radius:10px;
    padding:8px 10px;
    outline:none;
  }
  .ui-textarea{ min-height:90px; resize:vertical; }
  select.ui-select{ appearance:none; }

  /* =========================================================
   *  Meta overlay: menos ‚Äúbruma mental‚Äù
   * =======================================================*/
  .meta-section{ max-width: 1080px; margin:0 auto; }
  .meta-subtitle{ margin: 0 0 10px 0; font-size: 1.15rem; }
  .meta-tabs button{
    background: transparent;
    border: 1px solid var(--border);
    color: var(--muted);
    border-radius: 999px;
    padding: 6px 12px;
  }
  .meta-tabs button.active{
    background: rgba(255, 183, 77, .12);
    border-color: rgba(255, 183, 77, .35);
    color: #fff;
  }
  .meta-filter-row{
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }
  .meta-filter-row > *{ min-width: 160px; }
  .meta-filter-row .cal-nav{ display:flex; align-items:center; gap:6px; }

  /* ‚ÄúBloques‚Äù con aire */
  .meta-block{
    background:#0f1319;
    border:1px solid var(--border);
    border-radius:14px;
    padding:12px;
    margin: 12px 0;
  }
  .meta-block h4{ margin:0 0 10px 0; font-size:1rem; }
  .field-row label span{ color: var(--muted); font-size:.9rem; }

  /* =========================================================
   *  Date chip (sin overlay): usa el chip ‚Äúinput + bot√≥n‚Äù
   * =======================================================*/
  /* oculto el icono nativo para evitar ‚Äúdoble calendario‚Äù (solo dentro del chip) */
  .date-chip input[type="date"]::-webkit-calendar-picker-indicator,
  .date-chip input[type="month"]::-webkit-calendar-picker-indicator{
    opacity: 0;
    width: 0;
    height: 0;
  }


  /* =========================================================
   *  Calendario grande (grid mensual)
   * =======================================================*/
  .calendar-shell{
    display:grid;
    grid-template-columns: 1.2fr .8fr;
    gap:12px;
    margin-top:10px;
  }
  @media (max-width: 980px){
    .calendar-shell{ grid-template-columns: 1fr; }
  }
  .calendar-grid-wrap{
    background:#0f1319;
    border:1px solid var(--border);
    border-radius:16px;
    padding:12px;
    overflow:hidden;
  }
  .calendar-weekdays{
    display:grid;
    grid-template-columns: repeat(7, 1fr);
    gap:6px;
    color: var(--muted);
    font-size: .85rem;
    margin-bottom: 8px;
  }
  .calendar-weekdays > div{ text-align:center; padding:6px 0; }
  .calendar-grid{
    display:grid;
    grid-template-columns: repeat(7, 1fr);
    gap:6px;
  }
  .cal-day{
    border:1px solid var(--border);
    border-radius:12px;
    padding:8px;
    min-height:92px;
    background: rgba(255,255,255,.02);
    cursor:pointer;
  }
  .cal-day:hover{ background: rgba(255,255,255,.04); }
  .cal-day.muted{
    opacity:.55;
  }
  .cal-day-head{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:6px;
    font-size:.85rem;
    color: var(--muted);
  }
  .cal-badges{ display:flex; flex-direction:column; gap:4px; }
  .cal-badge{
    font-size:.78rem;
    padding:2px 6px;
    border-radius:999px;
    border:1px solid var(--border);
    background: rgba(255,255,255,.03);
    overflow:hidden;
    white-space:nowrap;
    text-overflow:ellipsis;
  }
  .calendar-side{
    background:#0f1319;
    border:1px solid var(--border);
    border-radius:16px;
    padding:12px;
  }
  .calendar-side-head{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    margin-bottom:10px;
  }
  .calendar-day-list{
    border:1px solid var(--border);
    border-radius:14px;
    padding:10px;
    min-height:120px;
    background: rgba(255,255,255,.02);
  }
  .day-item{
    display:flex;
    gap:10px;
    padding:8px;
    border-radius:12px;
    border:1px solid var(--border);
    background: rgba(255,255,255,.03);
    margin-bottom:8px;
    cursor:pointer;
  }
  .day-item:last-child{ margin-bottom:0; }
  .day-dot{
    width:10px;height:10px;border-radius:50%;
    margin-top:4px; flex:0 0 auto;
  }
  .day-item .t{ font-weight:650; }
  .day-item .m{ color: var(--muted); font-size:.85rem; }
  .calendar-editor{ margin-top:12px; }
  .gcal-box{
    margin-top:12px;
    border:1px solid var(--border);
    border-radius:14px;
    padding:10px;
    background: rgba(255,255,255,.02);
  }
  .gcal-box summary{ cursor:pointer; }
  .danger{ border-color: rgba(255,107,107,.35) !important; color:#ffb3b3 !important; }

</style>
</head>
<body class="hide-exterior">
  <header class="header">
    <div class="nav-grid">
      <a class="brand" href="index.html">MIELLIFERA</a>
      <nav class="nav-center" aria-label="Principal"></nav>
      <button id="btnLogout" class="cta" type="button">Salir</button>
    </div>
  </header>

  <main class="site">
    <section class="section alt">
      <div class="section-head">
        <div>
          <h2>Tu panel</h2>
          <p class="muted">C√≥digo de vinculaci√≥n, dispositivos y lecturas.</p>
        </div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button id="lastReading" class="pill" type="button">√öltima medici√≥n: ‚Äî</button>
          <button id="btnProdMain" class="btn small" type="button" title="Producci√≥n">Producci√≥n</button>
        </div>
      </div>

      <div class="split">
        <!-- Cuenta -->
        <div class="card" style="max-width:420px">
          <h3>Cuenta</h3>
          <p class="reveal-wrap">
            <span>Email: <b id="uEmail" data-real="">‚Äî</b></span>
            <button id="toggleEmail" class="eye-btn" type="button" aria-pressed="false" title="Mostrar/ocultar email">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 3l18 18" stroke-width="2"/><path d="M21 12s-3.5-7-9-7" stroke-width="2"/></svg>
              <span>Ocultar</span>
            </button>
          </p>
          <p class="reveal-wrap">
            <span>C√≥digo de 4 d√≠gitos: <b id="uCode" data-real="">‚Äî</b></span>
            <button id="toggleCode" class="eye-btn" type="button" aria-pressed="false" title="Mostrar/ocultar c√≥digo">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 3l18 18" stroke-width="2"/><path d="M21 12s-3.5-7-9-7" stroke-width="2"/></svg>
              <span>Ocultar</span>
            </button>
          </p>
          <div class="reveal-wrap" style="margin-top:6px">
            <button id="btnTutorials" class="btn small" type="button">Tutoriales</button>
          </div>
          <div id="msg" class="muted" style="margin-top:8px"></div>
          <hr style="border:0;border-top:1px solid var(--border)">
          <!-- Clima y pron√≥stico -->
          <div>
            <h3 style="margin:10px 0 8px">Clima y pron√≥stico</h3>
            <div id="wxCard" class="wx-card">
              <div class="wx-head">
                <div class="wx-title">Pron√≥stico local</div>
                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                  <button id="btnWxOpen" class="btn small yellow" type="button">Elegir ubicaci√≥n</button>
                  <button id="btnWxReset" class="btn small" type="button" style="display:none">Cambiar ubicaci√≥n</button>
                </div>
              </div>

              <!-- Fila de entrada para buscar ubicaci√≥n -->
              <div id="wxInputRow" style="display:none;margin:6px 0 10px;gap:8px;align-items:center;flex-wrap:wrap">
                <div class="loc-chip">
                  <input id="wxQuery" type="text" placeholder="Ciudad, provincia, pa√≠s o lat,lon" aria-label="Ubicaci√≥n">
                </div>
                <button id="btnWxFind" class="btn small yellow" type="button">Buscar</button>
                <button id="btnWxGeo" class="btn small" type="button" title="Usar ubicaci√≥n del dispositivo">Usar mi ubicaci√≥n</button>
              </div>

              <!-- Resultados geocoding -->
              <div id="wxResults" class="wx-results" style="display:none"></div>

              <div id="wxContent" class="wx-blur">
                <!-- Hoy / seleccionado -->
                <div class="wx-today">
                  <div>
                    <div class="wx-big" id="wxNow">‚Äî ¬∞C</div>
                    <div class="wx-loc" id="wxWhere">Ubicaci√≥n no establecida</div>
                    <div class="wx-small" id="wxNowMeta">‚Äî</div>
                  </div>
                  <div class="wx-small" id="wxTodayMM">M√°x ‚Äî¬∞ ¬∑ M√≠n ‚Äî¬∞ ¬∑ üåßÔ∏è ‚Äî% ¬∑ üíß ‚Äîmm</div>
                </div>

                <!-- Pr√≥ximos 7 (tocables) -->
                <div class="wx-tiles" id="wxTiles"></div>

                <!-- Gr√°fico semanal -->
                <div id="wxWeekWrap" class="chart-card" style="margin-top:10px;display:none">
                  <h4 style="margin:0 0 4px">Pr√≥ximos 7 d√≠as (tocar un d√≠a para ver detalle)</h4>
                  <div class="chart-box" style="height:170px">
                    <canvas id="wxWeekChart"></canvas>
                  </div>
                </div>

                <!-- Detalle del d√≠a -->
                <div id="wxDayDetail" class="wx-day-detail" style="display:none"></div>
              </div>
            </div>
          </div>
          <!-- /Clima -->
        </div>

        <!-- KPIs madre + gr√°ficos -->
        <div>
          <div class="side-cards" id="extKpisWrap">
            <div class="card">
              <h3>Temperatura Exterior</h3>
              <div class="metric"><span id="temVal" class="val">‚Äî</span><span class="unit">¬∞C</span></div>
              <div id="temWhen" class="muted">‚Äî</div>
            </div>
            <div class="card">
              <h3>Humedad Exterior</h3>
              <div class="metric"><span id="humVal" class="val">‚Äî</span><span class="unit">%</span></div>
              <div id="humWhen" class="muted">‚Äî</div>
            </div>
          </div>

          <div class="center" style="margin-top:14px">
            <button id="btnChart" class="btn yellow" type="button">Mostrar gr√°fica</button>
          </div>

          <!-- Gr√°ficos + historial -->
          <div id="chartsWrap">
            <div class="charts-grid">
              <div class="chart-card">
                <h3 id="titleTemp" style="margin:0 0 8px">Temperatura de hoy</h3>
                <div class="chart-box"><canvas id="chartTemp"></canvas></div>
              </div>
              <div class="chart-card">
                <h3 id="titleHum" style="margin:0 0 8px">Humedad de hoy</h3>
                <div class="chart-box"><canvas id="chartHum"></canvas></div>
              </div>
            </div>

            <div class="hist-controls" id="histControls">
              <div class="date-chip">
                <input type="date" id="dateFrom">
                <button class="cal-btn" type="button" aria-label="Desde" onclick="tryOpenPicker('dateFrom')">
                  <svg viewBox="0 0 24 24" stroke="currentColor" fill="none"><rect x="3" y="4" width="18" height="18" rx="3" stroke-width="2"/><path d="M16 2v4M8 2v4M3 10h18" stroke-width="2"/></svg>
                </button>
              </div>
              <div class="date-chip">
                <input type="date" id="dateTo">
                <button class="cal-btn" type="button" aria-label="Hasta" onclick="tryOpenPicker('dateTo')">
                  <svg viewBox="0 0 24 24" stroke="currentColor" fill="none"><rect x="3" y="4" width="18" height="18" rx="3" stroke-width="2"/><path d="M16 2v4M8 2v4M3 10h18" stroke-width="2"/></svg>
                </button>
              </div>
              <div class="hist-actions">
                <button id="btnShowRange" class="btn small" type="button">Mostrar</button>
                <button id="btnClearHistory" class="btn small" type="button">Borrar</button>
                <button id="btnDownloadCSV" class="btn small" type="button">Descargar CSV</button>
              </div>
            </div>
          </div>

          <!-- Cartas de manejo / calendario / anotaciones -->
          <div class="meta-cards">
            <div class="card" id="cardSanidad">
              <h3 class="meta-card-title">Manejo sanitario</h3>
              <button class="btn small yellow" type="button">Abrir manejo sanitario</button>
            </div>
            <div class="card" id="cardCalendario">
              <h3 class="meta-card-title">Calendario</h3>
              
              <button class="btn small yellow" type="button">Abrir calendario</button>
            </div>
            <div class="card" id="cardNotas">
              <h3 class="meta-card-title">Anotaciones</h3>
              
              <button class="btn small yellow" type="button">Abrir anotaciones</button>
            </div>
          </div>

          <!-- Modelo de tarjeta de colmena (solo visible en modo edici√≥n) -->
          <br><br><br>
          <div id="cardModel"
               class="card"
               style="margin:8px auto 12px;max-width:260px;display:none;text-align:center">
            <h3 style="margin-top:0;">Modelo de tarjeta</h3>

            <div style="margin-top:8px;display:flex;flex-direction:column;gap:8px;align-items:stretch">
              <select id="cardCfgKilos"
                      class="btn small"
                      style="background:#10141a;border:1px solid var(--border);color:#fff;border-radius:10px;padding:6px 10px">
                <option value="mes">Kilos del mes</option>
                <option value="anio">Kilos del a√±o</option>
              </select>

              <select id="cardCfgTrabajo"
                      class="btn small"
                      style="background:#10141a;border:1px solid var(--border);color:#fff;border-radius:10px;padding:6px 10px">
                <option value="semana">Trabajo semanal</option>
                <option value="mes">Trabajo mensual</option>
                <option value="anio">Trabajo anual</option>
              </select>
            </div>

            <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
              <button id="cardCfgConfirm" class="btn small yellow" type="button">Confirmar</button>
              <button id="cardCfgReset" class="btn small" type="button">Resetear</button>
            </div>
          </div>

          <div class="cards-head">
            <button id="btnEdit" class="btn small" type="button" aria-pressed="false">Editar orden</button>
          </div>
          <div id="autoCards" class="cards-grid" aria-live="polite"></div>
        </div>
      </div>
    </section>

    <!-- Historial tabla -->
    <section class="section" id="lecturas">
      <div class="section-head">
        <h3>Historial de mediciones</h3>
        <button id="toggleTbl" class="btn" type="button">Mostrar / Ocultar historial de mediciones</button>
      </div>
      <div id="tableWrap" style="overflow:auto;max-height:60vh;display:none;border-radius:12px">
        <table id="tbl">
          <thead><tr><th>Fecha</th><th>Dispositivo</th><th>Sensor</th><th>Valor / Info</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer style="padding:16px;color:#c3c9d1;border-top:1px solid var(--border);display:flex;justify-content:center">
    <span>¬© <span id="year"></span> MIELLIFERA</span>
  </footer>

  <!-- Overlay Colmena -->
  <div id="deviceOverlay" aria-hidden="true">
    <div id="devicePanel">
      <div class="overlay-header">
        <button id="btnOverlayBack" class="btn small" type="button" title="Volver">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" style="margin-right:6px"><path d="M15 18l-6-6 6-6" stroke-width="2"/></svg>
          Volver
        </button>
        <h3 id="overlayTitle" style="margin:0;flex:1">Colmena ‚Äî</h3>
        <button class="btn small" id="btnOverlayQueen">Reina</button>
        <button id="btnOverlayNotes" class="btn small" type="button" title="Ver anotaciones de esta colmena">
          Anotaciones
        </button>
      </div>

      <div class="overlay-content">
        <!-- Mini dashboard: Temp, Hum -->
        <div class="overlay-grid">
          <div class="card">
            <h3>Temperatura Colmena</h3>
            <div class="metric">
              <span id="ovTemVal" class="val">‚Äî</span>
              <span class="unit">¬∞C</span>
            </div>
            <div id="ovTemWhen" class="muted">‚Äî</div>
          </div>
          <div class="card">
            <h3>Humedad Colmena</h3>
            <div class="metric">
              <span id="ovHumVal" class="val">‚Äî</span>
              <span class="unit">%</span>
            </div>
            <div id="ovHumWhen" class="muted">‚Äî</div>
          </div>
        </div>

        <!-- Gr√°fica + historial por colmena -->
        <div class="card" style="margin-top:12px">
          <div class="center">
            <button id="overlayBtnChart" class="btn yellow" type="button">Mostrar gr√°fica</button>
          </div>
          <div id="ovChartsWrap" style="display:none;margin-top:10px">
            <div class="charts-grid">
              <div class="chart-card">
                <h3 id="ovTitleTemp" style="margin:0 0 8px">Temperatura de hoy</h3>
                <div class="chart-box"><canvas id="ovChartTemp"></canvas></div>
              </div>
              <div class="chart-card">
                <h3 id="ovTitleHum" style="margin:0 0 8px">Humedad de hoy</h3>
                <div class="chart-box"><canvas id="ovChartHum"></canvas></div>
              </div>
            </div>
            <div class="hist-controls" id="ovHistControls" style="display:none;margin-top:10px">
              <div class="date-chip">
                <input type="date" id="ovDateFrom">
                <button class="cal-btn" type="button" aria-label="Desde" onclick="tryOpenPicker('ovDateFrom')">
                  <svg viewBox="0 0 24 24" stroke="currentColor" fill="none"><rect x="3" y="4" width="18" height="18" rx="3" stroke-width="2"/><path d="M16 2v4M8 2v4M3 10h18" stroke-width="2"/></svg>
                </button>
              </div>
              <div class="date-chip">
                <input type="date" id="ovDateTo">
                <button class="cal-btn" type="button" aria-label="Hasta" onclick="tryOpenPicker('ovDateTo')">
                  <svg viewBox="0 0 24 24" stroke="currentColor" fill="none"><rect x="3" y="4" width="18" height="18" rx="3" stroke-width="2"/><path d="M16 2v4M8 2v4M3 10h18" stroke-width="2"/></svg>
                </button>
              </div>
              <div class="hist-actions">
                <button id="ovBtnShowRange" class="btn small" type="button">Mostrar</button>
                <button id="ovBtnExitHistory" class="btn small" type="button">Borrar</button>
              </div>
            </div>
          </div>
        </div>
                <!-- Herramientas de an√°lisis -->
        <div class="card" style="margin-top:12px">
          <h3 style="margin-top:0">Herramientas de an√°lisis</h3>
          <div class="mode-toggle">
            <button type="button" data-mode="work" id="btnModeWork">Trabajo</button>
            <button type="button" data-mode="air" id="btnModeAir">Aire</button>
            <button type="button" data-mode="motion" id="btnModeMotion">Movimiento</button>
            <button type="button" data-mode="prod" id="btnModeProd">Producci√≥n</button>
          </div>
          <div id="analysisInline" class="analysis-inline" style="display:none"></div>
        </div>

        <!-- Trabajo -->
        <!-- Trabajo -->
        <div class="card" id="workCard" style="margin-top:12px;display:none">
          <h3>Trabajo</h3>
          <div id="workToday" class="muted">Trabajo de hoy: ‚Äî</div>
          <div id="workWeek" class="muted">Trabajo de la semana: ‚Äî</div>
          <div id="workMonth" class="muted">Trabajo del mes: ‚Äî</div>

          <div id="workChartWrap" style="display:block;margin-top:10px">
            <div class="chart-card work-chart-grid">
              <div class="work-chart-main">
                <h3 id="workChartTitle">Trabajo mensual ‚Äî Variables (ppm)</h3>
                <div class="chart-box"><canvas id="workChart"></canvas></div>
              </div>

              <aside class="work-avg-panel" aria-label="Promedios del per√≠odo">
                <div class="work-avg-title">Promedio del per√≠odo</div>
                <div class="work-avg-grid">
                  <div class="work-avg-item"><div class="k">C2R</div><div class="v" id="workAvgC2R">‚Äî</div></div>
                  <div class="work-avg-item"><div class="k">NHR</div><div class="v" id="workAvgNHR">‚Äî</div></div>
                  <div class="work-avg-item"><div class="k">NXR</div><div class="v" id="workAvgNXR">‚Äî</div></div>
                  <div class="work-avg-item"><div class="k">ALR</div><div class="v" id="workAvgALR">‚Äî</div></div>
                  <div class="work-avg-item"><div class="k">SMR</div><div class="v" id="workAvgSMR">‚Äî</div></div>
                </div>
                <div class="work-avg-foot muted">Se calcula promedio dentro del rango seleccionado.</div>
              </aside>
            </div>
          </div>

          <div class="work-controls" style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <select id="workRange" class="btn small" style="background:#10141a;border:1px solid var(--border);color:#fff;border-radius:10px;padding:6px 10px">
              <option value="dia">D√≠a</option>
              <option value="semana">Semana</option>
              <option value="mes" selected>Mes</option>
            </select>
            <button id="btnWorkHistToggle" class="btn small" type="button">Historial</button>
            <button id="btnWorkCSV" class="btn small" type="button">Descargar CSV</button>
          </div>

          <div id="workHistControls" class="hist-controls" style="display:none;margin-top:10px">
            <div class="date-chip">
              <input type="date" id="workDateFrom">
              <button class="cal-btn" type="button" aria-label="Desde" onclick="tryOpenPicker('workDateFrom')">
                <svg viewBox="0 0 24 24" stroke="currentColor" fill="none">
                  <rect x="3" y="4" width="18" height="18" rx="2" />
                  <path d="M16 2v4M8 2v4M3 10h18" />
                </svg>
              </button>
            </div>

            <div class="date-chip">
              <input type="date" id="workDateTo">
              <button class="cal-btn" type="button" aria-label="Hasta" onclick="tryOpenPicker('workDateTo')">
                <svg viewBox="0 0 24 24" stroke="currentColor" fill="none">
                  <rect x="3" y="4" width="18" height="18" rx="2" />
                  <path d="M16 2v4M8 2v4M3 10h18" />
                </svg>
              </button>
            </div>

            <div class="hist-actions">
              <button id="btnWorkHistShow" class="btn small" type="button">Mostrar</button>
              <button id="btnWorkHistCSV" class="btn small" type="button">Descargar CSV</button>
            </div>
          </div>
        </div>


        <!-- Aire (placeholder, por si luego lo llenamos) -->
        <div class="card" id="airCard" style="margin-top:12px;display:none">
          <h3>Aire</h3>
          <p class="muted">Aqu√≠ ir√°n las herramientas de an√°lisis de ventilaci√≥n / CO‚ÇÇ / etc.</p>
        </div>

        <!-- Movimiento (placeholder) -->
        <div class="card" id="motionCard" style="margin-top:12px;display:none">
          <h3>Movimiento</h3>
          <p class="muted">Aqu√≠ ir√°n las herramientas de an√°lisis de movimiento.</p>
        </div>

        <!-- Producci√≥n por colmena (modo dentro de Herramientas) -->
        <div class="card" id="prodCardHive" style="margin-top:12px;display:none">
          <h3>Producci√≥n</h3>

          <!-- FORM: Producci√≥n (fecha + kilos + guardar) -->
          <div class="prod-inputs" style="margin-bottom:10px">
            <div class="date-chip">
              <input type="date" id="ovProdDate">
              <button class="cal-btn" type="button" aria-label="Fecha" onclick="tryOpenPicker('ovProdDate')">
                <svg viewBox="0 0 24 24" stroke="currentColor" fill="none">
                  <rect x="3" y="4" width="18" height="18" rx="3" stroke-width="2"/>
                  <path d="M16 2v4M8 2v4M3 10h18" stroke-width="2"/>
                </svg>
              </button>
            </div>

            <input type="number"
                   id="ovProdKilos"
                   inputmode="decimal"
                   min="0.01"
                   step="0.01"
                   placeholder="Kilos"
                   class="prod-kilos">

            <button id="ovBtnSaveProd" class="btn yellow" type="button">
              Guardar
            </button>
          </div>

          <!-- GR√ÅFICOS: todos para ESTA colmena -->
          <div class="hive-prod-charts">
            <!-- 1. Producci√≥n anual (barras por a√±o) -->
            <div class="chart-card">
              <h3 style="margin-top:0;">Producci√≥n anual de la colmena</h3>
              <p class="muted" style="margin-top:0;margin-bottom:6px;">
                Total de kilos por a√±o (barras comparativas).
              </p>
              <div class="chart-box">
                <canvas id="hiveProdYearChart"></canvas>
              </div>
            </div>

            <!-- 2. L√≠nea mensual por a√±o (superpuestas) -->
            <div class="chart-card">
              <h3 style="margin-top:0;">Producci√≥n mensual por a√±o</h3>
              <p class="muted" style="margin-top:0;margin-bottom:6px;">
                Producci√≥n mes a mes, comparando a√±os (una l√≠nea por a√±o).
              </p>
              <div class="chart-box">
                <canvas id="hiveProdMonthlyChart"></canvas>
              </div>
            </div>

            <!-- 3. L√≠nea multianual (evoluci√≥n) -->
            <div class="chart-card">
              <h3 style="margin-top:0;">Evoluci√≥n multianual</h3>
              <p class="muted" style="margin-top:0;margin-bottom:6px;">
                Evoluci√≥n de la producci√≥n a lo largo de los a√±os (por mes o por cosecha).
              </p>
              <div class="chart-box">
                <canvas id="hiveProdMultiYearChart"></canvas>
              </div>
            </div>

            <!-- 4. L√≠nea con hitos de cambio de reina -->
            <div class="chart-card">
              <h3 style="margin-top:0;">Producci√≥n y cambios de reina</h3>
              <p class="muted" style="margin-top:0;margin-bottom:6px;">
                Muestra la producci√≥n anual/mensual y marca los cambios de reina (l√≠neas verticales o s√≠mbolos).
              </p>
              <div class="chart-box">
                <canvas id="hiveProdQueenChart"></canvas>
              </div>
            </div>
          </div>

          <!-- HISTORIAL (tabla limitada en alto, como ahora) -->
          <div style="margin-top:12px;">
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px;align-items:center;justify-content:space-between">
              <span class="muted">Historial de producci√≥n de esta colmena</span>
              <button id="ovBtnToggleHist" class="btn small" type="button">
                Ver / ocultar historial
              </button>
            </div>

            <div id="ovProdHistWrap" style="display:none">
              <div class="nice-table">
                <div style="max-height:220px;overflow:auto">
                  <table style="width:100%">
                    <thead>
                      <tr>
                        <th>Fecha</th>
                        <th class="num">Kilos</th>
                      </tr>
                    </thead>
                    <tbody id="ovProdTbody">
                      <tr><td class="muted" colspan="2">Sin datos</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div> <!-- overlay-content -->
    </div>
  </div>
  <!-- ================= Overlay Reina ================= -->
  <div id="queenOverlay" style="display:none;position:fixed;inset:0;z-index:1100;background:rgba(8,10,14,.95);backdrop-filter:blur(4px);" aria-hidden="true">
    <div id="queenPanel" style="max-width:800px;margin:0 auto;display:grid;grid-template-rows:auto 1fr;">
      <div class="overlay-header">
        <button class="btn small" id="btnQueenBack">Volver</button>
        <h2 id="queenTitle" style="margin:0;flex:1">Reina ¬∑ Colmena</h2>
      </div>
      <div class="overlay-content" style="padding:16px;overflow:auto;">
        <div class="queen-layout">
          <!-- Carta central con c√≠rculo y a√±o -->
          <div class="card queen-main-card">
            <h3 style="margin-top:0;margin-bottom:8px;">Estado de la reina</h3>
            <p class="muted" id="queenSubtitle">√öltima reina registrada</p>
            <div class="queen-circle-wrap">
              <div id="queenCircle" class="queen-circle"></div>
            </div>
            <div class="queen-year-label">
              <span id="queenYear">‚Äî</span>
            </div>
            <p class="muted queen-legend" id="queenLegend">
              Sin datos de reina para esta colmena.
            </p>
          </div>

          <!-- Panel lateral: alta + historial -->
          <div class="queen-side">
            <div class="card queen-form-card">
              <h3 style="margin-top:0;">Nueva reina</h3>
              <p class="muted" style="margin-top:0;">
                Registre el a√±o de introducci√≥n de la nueva reina.
              </p>
              <div class="queen-form-row">
                <label for="queenYearInput">A√±o de adquisici√≥n</label>
                <input id="queenYearInput" type="number" min="1900" max="2100" placeholder="2025">
              </div>
              <button class="btn yellow" id="queenSaveBtn" type="button">
                Guardar nueva reina
              </button>
            </div>

            <div class="card queen-history-card">
              <div class="queen-history-head">
                <h3 style="margin:0;">Historial de reinas</h3>
                <button class="btn small" id="queenReloadBtn" type="button">
                  Actualizar
                </button>
              </div>
              <div class="queen-history-body" id="queenHistoryWrap">
                <p class="muted">Sin registros para esta colmena.</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Leyenda de colores -->
        <div class="card queen-color-legend">
          <h4 style="margin-top:0;">C√≥digos de colores (√∫ltimo d√≠gito del a√±o)</h4>
          <div class="queen-color-grid">
            <div class="queen-color-item">
              <span class="queen-color-dot queen-color-white"></span>
              <span>1 o 6 ‚Üí Blanco</span>
            </div>
            <div class="queen-color-item">
              <span class="queen-color-dot queen-color-yellow"></span>
              <span>2 o 7 ‚Üí Amarillo</span>
            </div>
            <div class="queen-color-item">
              <span class="queen-color-dot queen-color-red"></span>
              <span>3 o 8 ‚Üí Rojo</span>
            </div>
            <div class="queen-color-item">
              <span class="queen-color-dot queen-color-green"></span>
              <span>4 o 9 ‚Üí Verde</span>
            </div>
            <div class="queen-color-item">
              <span class="queen-color-dot queen-color-blue"></span>
              <span>5 o 0 ‚Üí Azul</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
<!-- =============== Fin Overlay Reina =============== -->

  <!-- =======================================================
     OVERLAY: PRODUCCI√ìN GLOBAL (APIARIO + COLMENA)
     =======================================================-->
  <div id="prodOverlay" style="display:none" aria-hidden="true">
    <div id="prodPanel">
      <!-- Header overlay -->
      <header class="overlay-header">
        <button class="btn small" id="btnProdBack">Volver</button>
        <h2 style="margin:0">Producci√≥n</h2>
        <div class="muted" id="prodSummary">
          Seleccione un rango y presione ‚ÄúMostrar‚Äù para ver la producci√≥n.
        </div>
      </header>

      <div class="overlay-content">
        <!-- ==========================
            Zona de gr√°ficos
            ==========================-->
        <div id="prodCharts">
          <!-- Vista APIARIO (sin colmena filtrada) -->
          <div id="prodApiaryCharts" class="prod-charts-grid">
            <div class="chart-card">
              <h3>Producci√≥n anual del apiario</h3>
              <div class="chart-box">
                <canvas id="prodApiaryYearChart"></canvas>
              </div>
            </div>
            <div class="chart-card">
              <h3>Producci√≥n mensual por a√±o (apiario)</h3>
              <div class="chart-box">
                <canvas id="prodApiaryMonthlyChart"></canvas>
              </div>
            </div>
          </div>

          <!-- Vista COLMENA (cuando hay filtro de colmena) -->
          <div id="prodHiveCharts" class="prod-charts-grid" style="display:none">
            <div class="chart-card">
              <h3 id="prodHiveMonthlyTitle">Producci√≥n mensual por a√±o ‚Äì Colmena</h3>
              <div class="chart-box">
                <canvas id="prodHiveMonthlyChart"></canvas>
              </div>
            </div>
            <div class="chart-card">
              <h3 id="prodHiveQueenTitle">Producci√≥n anual y cambios de reina</h3>
              <div class="chart-box">
                <canvas id="prodHiveQueenChart"></canvas>
              </div>
            </div>
          </div>
        </div>
                <!-- ==========================
            Filtros + Nueva producci√≥n + Tabla
            ==========================-->
        <div class="prod-layout">
          <!-- Columna izquierda: filtros + nueva producci√≥n -->
          <div class="prod-filters-column">
            <!-- Filtros de b√∫squeda -->
            <div class="prod-filters-row">
              <div class="prod-field">
                <label for="prodFrom">Desde</label>
                <div class="date-chip">
                  <input type="date" id="prodFrom">
                  <button class="cal-btn"
                          type="button"
                          aria-label="Desde"
                          onclick="tryOpenPicker('prodFrom')">
                    <svg viewBox="0 0 24 24" stroke="currentColor" fill="none">
                      <rect x="3" y="4" width="18" height="18" rx="3" stroke-width="2"/>
                      <path d="M16 2v4M8 2v4M3 10h18" stroke-width="2"/>
                    </svg>
                  </button>
                </div>
              </div>

              <div class="prod-field">
                <label for="prodTo">Hasta</label>
                <div class="date-chip">
                  <input type="date" id="prodTo">
                  <button class="cal-btn"
                          type="button"
                          aria-label="Hasta"
                          onclick="tryOpenPicker('prodTo')">
                    <svg viewBox="0 0 24 24" stroke="currentColor" fill="none">
                      <rect x="3" y="4" width="18" height="18" rx="3" stroke-width="2"/>
                      <path d="M16 2v4M8 2v4M3 10h18" stroke-width="2"/>
                    </svg>
                  </button>
                </div>
              </div>

              <div class="prod-field">
                <label for="prodDevice">Colmena</label>
                <select id="prodDevice">
                  <option value="">Todas</option>
                </select>
              </div>
            </div>

            <!-- Botones de acci√≥n -->
            <div class="prod-actions-row">
              <button class="btn small" id="btnProdShow">Mostrar</button>
              <button class="btn small" id="btnProdReset">Borrar</button>
              <button class="btn small" id="btnProdCSV" style="display:none">
                Descargar CSV
              </button>
            </div>

            <!-- Nueva producci√≥n -->
            <div class="prod-new-box">
              <h4>Nueva producci√≥n</h4>
              <form id="prodNewForm">
                <div class="prod-field">
                  <label for="prodNewDevice">Colmena</label>
                  <select id="prodNewDevice" required>
                    <option value="">Seleccionar‚Ä¶</option>
                  </select>
                </div>

                <div class="prod-field">
                  <label for="prodNewDate">Fecha</label>
                  <div class="date-chip">
                    <input type="date" id="prodNewDate" required>
                    <button class="cal-btn"
                            type="button"
                            aria-label="Fecha"
                            onclick="tryOpenPicker('prodNewDate')">
                      <svg viewBox="0 0 24 24" stroke="currentColor" fill="none">
                        <rect x="3" y="4" width="18" height="18" rx="3" stroke-width="2"/>
                        <path d="M16 2v4M8 2v4M3 10h18" stroke-width="2"/>
                      </svg>
                    </button>
                  </div>
                </div>

                <div class="prod-field">
                  <label for="prodNewKilos">Kilos</label>
                  <input type="number"
                         step="0.01"
                         min="0"
                         id="prodNewKilos"
                         placeholder="0,00"
                         required>
                </div>

                <button type="submit" class="btn small yellow">
                  Guardar producci√≥n
                </button>
              </form>
            </div>
          </div>

          <!-- Columna derecha: tabla historial -->
          <div class="prod-table-column">
            <div class="nice-table" style="max-height:none;overflow:visible;">
              <table>
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Colmena</th>
                    <th class="num">Kilos</th>
                  </tr>
                </thead>
                <tbody id="prodGlobalTbody">
                  <tr>
                    <td class="muted" colspan="3">Sin datos</td>
                  </tr>
                
                </tbody>
              </table>
              <div id="prodNoDataMsg" class="prod-no-data" style="display:none">Sin datos encontrados</div>
            </div>
            <div class="muted" style="margin-top:6px;font-size:.9rem;">
              Total del per√≠odo:
              <span id="prodGlobalTotal">0,00</span> kg
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- Overlay Meta (Sanidad / Calendario / Notas) -->
  <div id="metaOverlay" aria-hidden="true">
    <div id="metaPanel">
      <div class="overlay-header">
        <button id="btnMetaBack" class="btn small" type="button">Volver</button>
        <h3 id="metaTitle" style="margin:0">Panel</h3>
      </div>
      <div class="overlay-content">
        <div class="meta-tabs">
          <button type="button" id="tabSanidad" data-mode="sanidad">Manejo sanitario</button>
          <button type="button" id="tabCalendario" data-mode="calendario">Calendario</button>
          <button type="button" id="tabNotas" data-mode="notas">Anotaciones</button>
        </div>
        <!-- ===================== SANIDAD ===================== -->
        <section id="metaSanidad" class="meta-section">
          <h3 class="meta-subtitle">Manejo sanitario</h3>

          <div class="sanidad-layout">
            <!-- Alta de tratamiento -->
            <div class="sanidad-panel">
              <h4>Nuevo tratamiento</h4>
              <form id="sanidadForm" class="sanidad-form">
                <div class="field-row">
                  <label>
                    <span>Colmena</span>
                    <select id="sanidadDevice" class="ui-select"></select>
                  </label>
                </div>

                <div class="field-row">
                  <label>
                    <span>Fecha de inicio</span>
                    <div class="date-chip">
                      <input type="date" id="sanidadDate">
                      <button class="cal-btn" type="button" aria-label="Fecha de inicio" onclick="tryOpenPicker('sanidadDate')">
                        <svg viewBox="0 0 24 24" stroke="currentColor" fill="none"><rect x="3" y="4" width="18" height="18" rx="3" stroke-width="2"/><path d="M16 2v4M8 2v4M3 10h18" stroke-width="2"/></svg>
                      </button>
                    </div>
                  </label>
                </div>

                <div class="field-row">
                  <label>
                    <span>Producto</span>
                    <input type="text" id="sanidadProduct" list="sanidadProductList" autocomplete="off" placeholder="Ej. Amitraz, Timol‚Ä¶" class="ui-input">
                    <datalist id="sanidadProductList"></datalist>
                  </label>
                </div>

                <div class="field-row">
                  <label>
                    <span>Fecha estimada de retiro</span>
                    <div class="date-chip">
                      <input type="date" id="sanidadEstimated" class="ui-input">
                      <button class="cal-btn" type="button" aria-label="Fecha estimada de retiro" onclick="tryOpenPicker('sanidadEstimated')">
                        <svg viewBox="0 0 24 24" stroke="currentColor" fill="none"><rect x="3" y="4" width="18" height="18" rx="3" stroke-width="2"/><path d="M16 2v4M8 2v4M3 10h18" stroke-width="2"/></svg>
                      </button>
                    </div>
                  </label>
                </div>

                <div class="field-row">
                  <button type="button" id="btnSanidadSave" class="btn primary">Guardar tratamiento</button>
                </div>
              </form>
            </div>

            <!-- Tratamientos en curso -->
            <div class="sanidad-panel">
              <h4>Tratamientos en curso</h4>
              <div id="sanidadPendingCards" class="sanidad-cards">
                <p class="muted">No hay tratamientos pendientes.</p>
              </div>
            </div>
          </div>

          <hr class="meta-separator">

          <!-- Historial de tratamientos (tabla) -->
          <div class="sanidad-historial">
            <div class="sanidad-hist-filters">
              <label>
                <span>Colmena</span>
                <select id="sanidadFilterDevice" class="ui-select"></select>
              </label>

              <label>
                <span>Desde</span>
                <div class="date-chip">
                  <input type="date" id="sanidadFrom">
                  <button class="cal-btn" type="button" aria-label="Desde" onclick="tryOpenPicker('sanidadFrom')">
                    <svg viewBox="0 0 24 24" stroke="currentColor" fill="none"><rect x="3" y="4" width="18" height="18" rx="3" stroke-width="2"/><path d="M16 2v4M8 2v4M3 10h18" stroke-width="2"/></svg>
                  </button>
                </div>
              </label>

              <label>
                <span>Hasta</span>
                <div class="date-chip">
                  <input type="date" id="sanidadTo">
                  <button class="cal-btn" type="button" aria-label="Hasta" onclick="tryOpenPicker('sanidadTo')">
                    <svg viewBox="0 0 24 24" stroke="currentColor" fill="none"><rect x="3" y="4" width="18" height="18" rx="3" stroke-width="2"/><path d="M16 2v4M8 2v4M3 10h18" stroke-width="2"/></svg>
                  </button>
                </div>
              </label>

              <button type="button" id="btnSanidadReload" class="btn subtle">Actualizar</button>
            </div>
            <div class="table-wrap">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Fecha inicio</th>
                    <th>Colmena</th>
                    <th>Producto</th>
                    <th>Retiro estimado</th>
                    <th>Retiro efectivo</th>
                    <th>Efectivo</th>
                  </tr>
                </thead>
                <tbody id="sanidadTbody">
                  <tr><td colspan="6" class="muted">Sin registros</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <hr class="meta-separator">

          <!-- ===================== BARROA ===================== -->
          <h3 class="meta-subtitle">Conteo de barroa</h3>

          <div class="varroa-layout">
            <!-- Alta conteo de barroa -->
            <div class="varroa-panel">
              <h4>Nuevo conteo</h4>
              <form id="varroaForm" class="varroa-form">
                <div class="field-row">
                  <label>
                    <span>Colmena</span>
                    <select id="varroaDevice" class="ui-select"></select>
                  </label>
                </div>
                <div class="field-row">
                  <label>
                    <span>Fecha</span>
                    <div class="date-chip">
                      <input type="date" id="varroaDate">
                      <button class="cal-btn" type="button" aria-label="Fecha" onclick="tryOpenPicker('varroaDate')">
                        <svg viewBox="0 0 24 24" stroke="currentColor" fill="none"><rect x="3" y="4" width="18" height="18" rx="3" stroke-width="2"/><path d="M16 2v4M8 2v4M3 10h18" stroke-width="2"/></svg>
                      </button>
                    </div>
                  </label>
                </div>
                <div class="field-row">
                  <label>
                    <span>% de barroa</span>
                    <input type="number" id="varroaPct" class="ui-input" step="0.1" min="0" placeholder="Ej. 1.5">
                  </label>
                </div>
                <div class="field-row">
                  <button type="button" id="btnVarroaSave" class="btn primary">Guardar conteo</button>
                </div>
              </form>
            </div>

            <!-- Tabla hist√≥rica de barroa -->
            <div class="varroa-panel">
              <h4>Historial de conteos</h4>
              <div class="varroa-filters">
                <label>
                  <span>Colmena</span>
                  <select id="varroaDeviceFilter" class="ui-select"></select>
                </label>

                <label>
                  <span>Desde</span>
                  <div class="date-chip">
                    <input type="date" id="varroaFrom">
                    <button class="cal-btn" type="button" aria-label="Desde" onclick="tryOpenPicker('varroaFrom')">
                      <svg viewBox="0 0 24 24" stroke="currentColor" fill="none"><rect x="3" y="4" width="18" height="18" rx="3" stroke-width="2"/><path d="M16 2v4M8 2v4M3 10h18" stroke-width="2"/></svg>
                    </button>
                  </div>
                </label>

                <label>
                  <span>Hasta</span>
                  <div class="date-chip">
                    <input type="date" id="varroaTo">
                    <button class="cal-btn" type="button" aria-label="Hasta" onclick="tryOpenPicker('varroaTo')">
                      <svg viewBox="0 0 24 24" stroke="currentColor" fill="none"><rect x="3" y="4" width="18" height="18" rx="3" stroke-width="2"/><path d="M16 2v4M8 2v4M3 10h18" stroke-width="2"/></svg>
                    </button>
                  </div>
                </label>

                <button type="button" id="btnVarroaReload" class="btn subtle">Actualizar</button>
              </div>
              <div class="table-wrap">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Fecha</th>
                      <th>Colmena</th>
                      <th>% Barroa</th>
                    </tr>
                  </thead>
                  <tbody id="varroaTbody">
                    <tr><td colspan="3" class="muted">Sin conteos registrados.</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </section>
        <!-- CALENDARIO -->
        <section id="metaCalendario" class="meta-section">
          <h3 class="meta-subtitle">Calendario</h3>
          <p class="muted" style="margin-top:0">
            Eventos por fecha y colmena. Incluye manejos sanitarios y eventos creados manualmente.
          </p>

          <div class="meta-filter-row">
            <select id="calDeviceFilter" class="ui-select">
              <option value="">Todas las colmenas</option>
            </select>

            <div class="cal-nav">
              <button id="btnCalPrev" class="btn small subtle" type="button" title="Mes anterior">‚óÄ</button>
              <input type="month" id="calMonth" class="ui-input" />
              <button id="btnCalNext" class="btn small subtle" type="button" title="Mes siguiente">‚ñ∂</button>
            </div>

            <button id="btnCalReload" class="btn small" type="button">Mostrar</button>
          </div>

          <div class="calendar-shell">
            <div class="calendar-grid-wrap">
              <div class="calendar-weekdays">
                <div>Lun</div><div>Mar</div><div>Mi√©</div><div>Jue</div><div>Vie</div><div>S√°b</div><div>Dom</div>
              </div>
              <div id="calBig" class="calendar-grid" aria-label="Calendario"></div>
              <div class="muted" style="font-size:.85rem;margin-top:8px;">
                Consejo: click en un d√≠a para crear evento. Click en un evento para editarlo.
              </div>
            </div>

            <div class="calendar-side">
              <div class="calendar-side-head">
                <div>
                  <div class="muted" style="font-size:.85rem">Eventos del d√≠a</div>
                  <div id="calSideDate" style="font-weight:700">‚Äî</div>
                </div>
                <button id="btnCalNew" class="btn yellow small" type="button">+ Nuevo</button>
              </div>

              <div id="calDayList" class="calendar-day-list"></div>

              <div class="meta-form-grid calendar-editor" id="calEditor">
                <div>
                  <label class="muted" for="calDevice">Colmena</label>
                  <select id="calDevice" class="ui-select" style="width:100%">
                    <option value="">(opcional) Sin colmena</option>
                  </select>
                </div>
                <div>
                  <label class="muted" for="calDate">Fecha</label>
                  <div class="date-chip">
                    <input type="date" id="calDate" class="ui-input">
                    <button class="cal-btn" type="button" aria-label="Calendario" onclick="tryOpenPicker('calDate')">
                      <svg viewBox="0 0 24 24" stroke="currentColor" fill="none">
                        <rect x="3" y="4" width="18" height="18" rx="3" stroke-width="2"/>
                        <path d="M16 2v4M8 2v4M3 10h18" stroke-width="2"/>
                      </svg>
                    </button>
                  </div>
                </div>
                <div style="grid-column:1/-1">
                  <label class="muted" for="calTitle">T√≠tulo</label>
                  <input id="calTitle" class="ui-input" type="text" placeholder="Ej. Control varroa, Alimentaci√≥n‚Ä¶">
                </div>
                <div>
                  <label class="muted" for="calType">Tipo</label>
                  <select id="calType" class="ui-select" style="width:100%">
                    <option value="sanidad">Manejo sanitario</option>
                    <option value="revisi√≥n">Revisi√≥n</option>
                    <option value="alimentaci√≥n">Alimentaci√≥n</option>
                    <option value="otro">Otro</option>
                  </select>
                </div>
                <div style="grid-column:1/-1">
                  <label class="muted" for="calNotes">Notas</label>
                  <textarea id="calNotes" class="ui-textarea" placeholder="Opcional"></textarea>
                </div>
                <div style="grid-column:1/-1;display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap">
                  <button id="btnCalDelete" class="btn small subtle danger" type="button" style="display:none">Eliminar</button>
                  <div style="display:flex;gap:8px;justify-content:flex-end;flex:1">
                    <button id="btnCalCancel" class="btn small subtle" type="button">Cancelar</button>
                    <button id="btnCalSave" class="btn yellow small" type="button">Guardar</button>
                  </div>
                </div>
              </div>

              <details class="gcal-box">
                <summary>Conexi√≥n Google Calendar (UI)</summary>
                <div class="muted" style="font-size:.9rem;line-height:1.35">
                  Esta pantalla deja listo el flujo visual. Para sincronizaci√≥n real con Google Calendar hace falta
                  un backend (OAuth2 + API de Google). En este HTML queda preparado el mapeo de eventos y el bot√≥n.
                </div>
                <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
                  <button id="btnGCalConnect" class="btn small" type="button">Conectar</button>
                  <button id="btnGCalSync" class="btn small subtle" type="button">Sincronizar</button>
                </div>
                <div id="gcalStatus" class="muted" style="margin-top:8px;font-size:.85rem">No conectado</div>
              </details>
            </div>
          </div>

          <!-- Mantengo el listado existente (por compatibilidad) -->
          <div id="calList" style="display:none"></div>
        </section>

        <!-- NOTAS -->
        <section id="metaNotas" class="meta-section">
          <h3 class="meta-subtitle">Anotaciones</h3>
          <p class="muted" style="margin-top:0">
            Registrar observaciones y ver el historial por colmena.
          </p>

          <div class="notes-layout">
            <!-- Nueva anotaci√≥n -->
            <div class="notes-panel">
              <h4>Nueva anotaci√≥n</h4>

              <div class="notes-form">
                <div class="field-row">
                  <label>
                    <span>Colmena</span>
                    <select id="noteDevice" class="ui-select">
                      <option value="">Seleccionar colmena‚Ä¶</option>
                    </select>
                  </label>
                </div>

                <div class="field-row">
                  <label>
                    <span>Texto de la anotaci√≥n</span>
                    <textarea id="noteText" class="ui-textarea" placeholder="Escribir anotaci√≥n..."></textarea>
                  </label>
                </div>

                <div class="field-row" style="display:flex;justify-content:flex-end">
                  <button id="btnNoteSave" class="btn yellow" type="button">Guardar anotaci√≥n</button>
                </div>
              </div>
            </div>

            <!-- Historial -->
            <div class="notes-panel">
              <div class="notes-panel-head">
                <h4 style="margin:0">Historial</h4>
                <button id="btnNotesReload" class="btn subtle" type="button">Actualizar</button>
              </div>

              <div class="notes-filters">
                <label>
                  <span>Colmena</span>
                  <select id="notesDeviceFilter" class="ui-select">
                    <option value="">Todas las colmenas</option>
                  </select>
                </label>
              </div>

              <div id="notesList"></div>
            </div>
          </div>
        </section>


      </div>
    </div>
  </div>
<script>
  /* =========================================================
   *  A√ëO EN FOOTER
   * =======================================================*/
  document.getElementById('year').textContent = new Date().getFullYear();

  /* =========================================================
   *  FIREBASE AUTH
   * =======================================================*/
  const firebaseConfig = {
    apiKey: "AIzaSyBH93vOKldh-IufVCZB1qyI6cRPoOr7iqw",
    authDomain: "mellifera-technology.firebaseapp.com",
    projectId: "mellifera-technology",
    storageBucket: "mellifera-technology.firebasestorage.app",
    messagingSenderId: "68043353319",
    appId: "1:68043353319:web:20a1aafde7b37d3457c642",
    measurementId: "G-FCW1E604DG"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();

  /* =========================================================
   *  WORKER + HELPERS B√ÅSICOS
   * =======================================================*/
  const WORKER_BASE = "https://mellifera-worker.mellifera-tech.workers.dev";
  const BASE = WORKER_BASE.replace(/\/+$/, '');

  const $ = id => document.getElementById(id);
  const setText = (id, t) => {
    const el = $(id);
    if (el) el.textContent = t;
  };

  /* =========================================================
   *  ESTADO GLOBAL JS
   * =======================================================*/
  let currentUID = null;
  let editing = false;

  // Gr√°ficos ‚Äúmadre‚Äù
  let chartTemp = null;
  let chartHum = null;
  let chartsVisible = false;

  let lastItemsCache = null;
  let historyMode = false;

  // Overlay por colmena
  let currentOverlayDevice = null;
  let ovChartsVisible = false;
  let ovChartTemp = null;
  let ovChartHum = null;
  
  // Producci√≥n global
  let prodLastItems = [];        // √∫ltimos registros de producci√≥n cargados

  // Meta overlay (Sanidad / Calendario / Notas)
  let metaCurrentMode = null;    // 'sanidad' | 'calendario' | 'notas'
  let metaDeviceContext = null;  // colmena desde la que abrimos notas (opcional)
  let queenDeviceContext = null;   // Colmena actual en overlay de reina


  /* =========================================================
   *  COLORES POR COLMENA (para calendario)
   * =======================================================*/
  const META_COLORS = [
    '#ffb74d', '#4da3ff', '#49d17d', '#ff6b6b',
    '#7fb3ff', '#ce93d8', '#fff176', '#80cbc4'
  ];
  const DEVICE_COLOR_CACHE = {};

  function getDeviceColor(id) {
    if (!id) return '#9aa3ad';
    if (!DEVICE_COLOR_CACHE[id]) {
      const keys = Object.keys(DEVICE_COLOR_CACHE);
      const idx = keys.length % META_COLORS.length;
      DEVICE_COLOR_CACHE[id] = META_COLORS[idx];
    }
    return DEVICE_COLOR_CACHE[id];
  }

  function getKnownDevices() {
    const set = new Set();
    for (const d of lastItemsCache || []) {
      const id = String(d.device_id || '').trim();
      if (!id || /mother/i.test(id) || !isNumericId(id)) continue;
      set.add(id);
    }
    return Array.from(set).sort((a, b) => Number(a || 0) - Number(b || 0));
  }

  /* =========================================================
   *  CONFIG TARJETAS COLMENA (mes / a√±o, sem / mes / a√±o)
   * =======================================================*/
  const CARD_CFG_KEY = 'miellifera.cardCfg';
  let cardCfg = loadCardCfg();

  function loadCardCfg() {
    try {
      const raw = localStorage.getItem(CARD_CFG_KEY);
      if (!raw) return { kilos: 'mes', trabajo: 'semana' };
      const c = JSON.parse(raw);
      return {
        kilos: ['mes', 'anio'].includes(c.kilos) ? c.kilos : 'mes',
        trabajo: ['semana', 'mes', 'anio'].includes(c.trabajo) ? c.trabajo : 'semana'
      };
    } catch {
      return { kilos: 'mes', trabajo: 'semana' };
    }
  }

  function saveCardCfg() {
    try {
      localStorage.setItem(CARD_CFG_KEY, JSON.stringify(cardCfg));
    } catch { }
  }

  // Etiquetas visibles en tarjetas
  function getKilosLabel() {
    return cardCfg.kilos === 'anio' ? 'Kilos a√±o' : 'Kilos mes';
  }

  function getTrabajoLabel() {
    if (cardCfg.trabajo === 'mes') return 'Trabajo mensual';
    if (cardCfg.trabajo === 'anio') return 'Trabajo anual';
    return 'Trabajo semanal';
  }

  // Sincroniza las etiquetas del ‚Äúmodelo‚Äù con la config actual
  function syncCardModelLabels() {
    setText('cardModelKilosLabel', getKilosLabel());
    setText('cardModelTrabajoLabel', getTrabajoLabel());
  }

  /* =========================================================
   *  CLIMA: ESTADO EN LOCALSTORAGE
   * =======================================================*/
  const WX_KEY = 'miellifera.wxPlace'; // {lat,lon,label}

  function saveWxPlace(p) {
    try { localStorage.setItem(WX_KEY, JSON.stringify(p || null)); } catch { }
  }

  function loadWxPlace() {
    try {
      const x = localStorage.getItem(WX_KEY);
      return x ? JSON.parse(x) : null;
    } catch {
      return null;
    }
  }

  function clearWxPlace() {
    try { localStorage.removeItem(WX_KEY); } catch { }
  }

  // ===== Reina: color seg√∫n √∫ltimo d√≠gito del a√±o =====
  function queenColorForYear(year){
    const y = Number(year);
    if(!Number.isInteger(y)) return { color:'#9aa3ad', name:'Sin dato' };
    const d = Math.abs(y) % 10;
    if(d===1 || d===6) return { color:'#fdfdfd', name:'Blanco' };
    if(d===2 || d===7) return { color:'#ffd54f', name:'Amarillo' };
    if(d===3 || d===8) return { color:'#ff6b6b', name:'Rojo' };
    if(d===4 || d===9) return { color:'#49d17d', name:'Verde' };
    if(d===5 || d===0) return { color:'#4da3ff', name:'Azul' };
    return { color:'#9aa3ad', name:'Sin dato' };
  }


  /* =========================================================
   *  AUTH: LOGIN / LOGOUT / ARRANQUE
   * =======================================================*/
  auth.onAuthStateChanged(async (u) => {
    if (!u) {
      location.href = 'login.html';
      return;
    }
    currentUID = u.uid;

    const ue = $('uEmail');
    ue.dataset.real = u.email || '(sin email)';
    ue.textContent = ue.dataset.real;

    try {
      const { code } = await callWorker('/ensure_user', { method: 'POST' });

      const uc = $('uCode');
      uc.dataset.real = code || '‚Äî';
      uc.textContent = uc.dataset.real;

      await loadDatapoints();
      initDateDefaults();
      initProdDefaults();

      // Clima: si hay ubicaci√≥n guardada la usamos
      const saved = loadWxPlace();
      if (saved && Number.isFinite(saved.lat) && Number.isFinite(saved.lon)) {
        await renderWeather(
          saved.lat,
          saved.lon,
          saved.label || (`Lat ${saved.lat.toFixed(2)}, Lon ${saved.lon.toFixed(2)}`)
        );
        setWxButtonsState('fixed');
      } else {
        setWxButtonsState('input');
        // opcional: foco directo
        setTimeout(() => $('wxQuery')?.focus(), 0);
      }
    } catch (e) {
      const m = $('msg');
      if (m) m.textContent = "Error cargando datos: " + (e.message || e);
    }
  });

  $('btnLogout').onclick = () => auth.signOut().then(() => location.href = 'login.html');
  $('btnTutorials').onclick = () => location.href = 'tutoriales.html';

  /* =========================================================
   *  TOGGLE EMAIL / C√ìDIGO (mascar)
   * =======================================================*/
  function maskVal(s) {
    if (!s) return '‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
    if (/@/.test(s)) {
      const [local, dom] = s.split('@');
      const l = String(local || '');
      const d = String(dom || '');
      const lFirst = l.charAt(0) || '';
      const lLast = l.slice(-1) || '';
      const dFirst = d.charAt(0) || '';
      const dLast = d.slice(-1) || '';
      return `${lFirst}***${lLast}@${dFirst}***${dLast}`;
    }
    return '‚Ä¢'.repeat(Math.min(4, String(s).length));
  }

  function toggleReveal(targetId, btnId) {
    const el = $(targetId), btn = $(btnId);
    const hidden = el.dataset.shown !== '1';
    if (hidden) {
      el.dataset.prev = el.textContent;
      el.textContent = maskVal(el.dataset.real || el.textContent);
      el.dataset.shown = '1';
      btn.setAttribute('aria-pressed', 'true');
      btn.querySelector('span').textContent = 'Mostrar';
    } else {
      el.textContent = el.dataset.real || el.dataset.prev || el.textContent;
      el.dataset.shown = '0';
      btn.setAttribute('aria-pressed', 'false');
      btn.querySelector('span').textContent = 'Ocultar';
    }
  }

  $('toggleEmail').onclick = () => toggleReveal('uEmail', 'toggleEmail');
  $('toggleCode').onclick = () => toggleReveal('uCode', 'toggleCode');

  /* =========================================================
   *  CALL WORKER (API principal)
   * =======================================================*/
  async function callWorker(path, opts = {}) {
    const u = auth.currentUser;
    if (!u) throw new Error('No auth');
    const t = await u.getIdToken();
    const p = path.startsWith('/') ? path : `/${path}`;
    const res = await fetch(`${BASE}${p}`, {
      method: opts.method || 'GET',
      headers: {
        'Authorization': `Bearer ${t}`,
        'Content-Type': 'application/json'
      },
      body: opts.body ? JSON.stringify(opts.body) : undefined
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  /* =========================================================
   *  UTILIDADES VARIAS
   * =======================================================*/
  const fmt = v => (v == null || Number.isNaN(+v)) ? null : Number(v).toFixed(2);
  const dtAR = ts => new Date(ts).toLocaleString('es-AR');
  const isNumericId = id => /^\d+$/.test(id);

  function escapeHtml(s) {
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function ymd(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${dd}`;
  }

  function toLocalDayStart(dateInput) {
    return new Date(dateInput + "T00:00:00").getTime();
  }

  function toLocalDayEnd(dateInput) {
    return new Date(dateInput + "T23:59:59.999").getTime();
  }

  function tryOpenPicker(id) {
    const el = $(id);
    if (el?.showPicker) el.showPicker();
    else el?.focus();
  }

  /* =========================================================
   *  KPIs MADRE (TEM / HUM)
   * =======================================================*/
  function updateLastReading(items) {
    const el = $('lastReading');
    if (!items?.length) {
      el.textContent = '√öltima medici√≥n: ‚Äî';
      return;
    }
    const latest = items.reduce((a, b) =>
      new Date(a.ts) > new Date(b.ts) ? a : b
    );
    el.textContent = '√öltima medici√≥n: ' + dtAR(latest.ts);
  }

  function latestBySensor(items, key) {
    let best = null, bt = 0;
    const KEY = String(key).toUpperCase();
    for (const d of items || []) {
      if (String(d.sensor_key || '').toUpperCase() !== KEY) continue;
      const t = new Date(d.ts).getTime();
      if (t > bt) {
        best = d;
        bt = t;
      }
    }
    return best;
  }

  function updateMotherKPIs(items) {
    const tem = latestBySensor(items, 'MOTHER.TEM');
    setText('temVal', tem?.value != null ? fmt(tem.value) : '‚Äî');
    setText('temWhen', tem ? dtAR(tem.ts) : '‚Äî');

    const hum = latestBySensor(items, 'MOTHER.HUM');
    setText('humVal', hum?.value != null ? fmt(hum.value) : '‚Äî');
    setText('humWhen', hum ? dtAR(hum.ts) : '‚Äî');
  }

  /* =========================================================
   *  TABLA GENERAL (lecturas crudas)
   * =======================================================*/
  function renderTable(items) {
    const tbody = document.querySelector('#tbl tbody');
    tbody.innerHTML = (items || []).map(d => {
      const val = String(d.sensor_key || '').startsWith('EVENT.')
        ? (d.meta?.info || d.meta?.type || JSON.stringify(d.meta || {}))
        : (d.value == null ? '' : fmt(d.value));
      return `<tr>
        <td>${dtAR(d.ts)}</td>
        <td>${escapeHtml(d.device_id || '')}</td>
        <td>${escapeHtml(d.sensor_key || '')}</td>
        <td>${escapeHtml(val)}</td>
      </tr>`;
    }).join('');
  }

  /* =========================================================
   *  UTILIDAD TIEMPO (minutos / horas)
   * =======================================================*/
  function formatMinutes(mins) {
    const h = Math.floor(mins / 60);
    const m = Math.round(mins % 60);
    return h > 0 ? `${h}h ${m}m` : `${m}m`;
  }

  /* =========================================================
   *  PRODUCCI√ìN: RANGOS (mes / semana / a√±o)
   * =======================================================*/
  function getProdRange(period) {
    const now = new Date();
    let from;
    if (period === 'anio') {
      from = new Date(now.getFullYear(), 0, 1, 0, 0, 0, 0);
    } else if (period === 'semana') {
      const d = (now.getDay() + 6) % 7; // lunes
      from = new Date(now);
      from.setDate(now.getDate() - d);
      from.setHours(0, 0, 0, 0);
    } else { // mes por defecto
      from = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0, 0);
    }
    const to = new Date();
    return { fromISO: from.toISOString(), toISO: to.toISOString() };
  }

  async function getProductionSummary(period) {
    const { fromISO, toISO } = getProdRange(period);
    try {
      const { items } = await prodList({ fromISO, toISO });
      const map = {};
      for (const it of items || []) {
        const id = String(it.device_id || '').trim();
        if (!id) continue;
        if (!map[id]) map[id] = { kilos: 0, trabajoMin: 0 };
        map[id].kilos += Number(it.kilos || 0);
        map[id].trabajoMin += Number(it.trabajoMin || 0);
      }
      return map;
    } catch {
      return {};
    }
  }

  /* =========================================================
   *  TARJETAS DE COLMENAS (panel principal)
   * =======================================================*/
  async function renderDeviceCards(items) {
    const wrap = $('autoCards');
    if (!wrap) return;

    // √öltimo timestamp por colmena
    const lastById = new Map();
    // Estado OPN / MS por colmena
    const statusById = new Map();

    for (const d of items || []) {
      const rawId = String(d.device_id || '').trim();
      if (!rawId || /mother/i.test(rawId) || !isNumericId(rawId)) continue;

      const t = new Date(d.ts).getTime();
      const prev = lastById.get(rawId) || 0;
      if (t > prev) lastById.set(rawId, t);

      const key = String(d.sensor_key || '').toUpperCase().trim();
      if (!statusById.has(rawId)) {
        statusById.set(rawId, { lastOpen: 0, lastClose: 0 });
      }
      const st = statusById.get(rawId);

      // OPN = colmena abierta
      if (key === 'OPN' || key.endsWith('.OPN') || key.includes('OPN')) {
        if (t > st.lastOpen) st.lastOpen = t;
      }
      // MS = ‚Äúcierra‚Äù alerta
      if (key === 'MS' || key.endsWith('.MS')) {
        if (t > st.lastClose) st.lastClose = t;
      }
    }

    const devices = [...lastById.entries()]
      .sort((a, b) => b[1] - a[1])
      .map(([id, ts]) => ({ id, ts }));

    if (!devices.length) {
      wrap.innerHTML = '<div class="muted">Sin colmenas detectadas.</div>';
      return;
    }

    const now = Date.now();

    // Sumar producci√≥n seg√∫n configuraci√≥n global
    const prodKilos = await getProductionSummary(cardCfg.kilos);     // mes / a√±o
    const prodTrabajo = await getProductionSummary(cardCfg.trabajo); // semana / mes / a√±o

    const labelKilos = getKilosLabel();
    const labelTrabajo = getTrabajoLabel();

    wrap.innerHTML = devices.map(({ id, ts }) => {
      const diffMin = (now - ts) / 60000;
      const conectado = diffMin <= 15;
      const colorConn = conectado ? 'var(--ok)' : 'var(--bad)';

      const st = statusById.get(id) || { lastOpen: 0, lastClose: 0 };

      let estadoLabel = 'Estado';
      let estadoDotCls = 'status-dot';
      let estadoDotStyle = 'background:var(--idle);';

      if (st.lastOpen || st.lastClose) {
        if (st.lastOpen > st.lastClose) {
          // √öltimo evento fue OPN ‚Üí alerta activa
          estadoLabel = 'ABIERTO';
          estadoDotCls = 'status-dot alert';
          estadoDotStyle = '';
        } else {
          // √öltimo evento fue MS ‚Üí OK
          estadoLabel = 'Estado';
          estadoDotCls = 'status-dot';
          estadoDotStyle = 'background:var(--ok);';
        }
      }

      const kilosVal = (prodKilos[id]?.kilos || 0).toFixed(1);
      const trabajoMin = prodTrabajo[id]?.trabajoMin || 0;
      const trabajoText = formatMinutes(trabajoMin);

      return `
        <div class="card device-card"
             data-device="${id}"
             tabindex="0"
             role="button"
             aria-label="Abrir Colmena ${id}">
          <h3 style="margin:0">Colmena ${id}</h3>
          <div class="status-row">
            <span>Conectado</span>
            <span class="status-dot" style="background:${colorConn}"></span>
          </div>
          <div class="status-row">
            <span>${estadoLabel}</span>
            <span class="${estadoDotCls}"${estadoDotStyle ? ` style="${estadoDotStyle}"` : ''}></span>
          </div>
          <div class="status-row">
            <span>${labelKilos}</span>
            <span style="font-weight:800;color:var(--accent)">${kilosVal}</span>
          </div>
          <div class="status-row">
            <span>${labelTrabajo}</span>
            <span style="font-weight:800;color:var(--focus)">${trabajoText}</span>
          </div>
        </div>`;
    }).join('');

    if (editing) enableDnD();

    // Mantener select del overlay de producci√≥n sincronizado
    const sel = $('prodDevice');
    if (sel) {
      const cur = sel.value;
      sel.innerHTML = '<option value="">Todas</option>' +
        devices.map(d => `<option value="${d.id}">${d.id}</option>`).join('');
      if (cur) sel.value = cur;
    }
  }

  /* =========================================================
   *  MODO EDICI√ìN TARJETAS + DnD
   * =======================================================*/
  $('btnEdit').onclick = () => {
    editing = !editing;
    $('btnEdit').textContent = editing ? 'Terminar edici√≥n' : 'Editar orden';
    $('autoCards').classList.toggle('editing', editing);

    const model = $('cardModel');
    if (model) {
      model.style.display = editing ? 'block' : 'none';
      if (editing) {
        const kSel = $('cardCfgKilos');
        const wSel = $('cardCfgTrabajo');
        if (kSel) kSel.value = cardCfg.kilos;
        if (wSel) wSel.value = cardCfg.trabajo;
        syncCardModelLabels();
      }
    }

    if (editing) enableDnD();
    else disableDnD();
  };

  const cfgKilosSel = $('cardCfgKilos');
  const cfgTrabajoSel = $('cardCfgTrabajo');

  // Cambio en select de kilos ‚Üí preview
  if (cfgKilosSel) {
    cfgKilosSel.onchange = () => {
      const v = cfgKilosSel.value || 'mes';
      setText('cardModelKilosLabel', v === 'anio' ? 'Kilos a√±o' : 'Kilos mes');
    };
  }

  // Cambio en select de trabajo ‚Üí preview
  if (cfgTrabajoSel) {
    cfgTrabajoSel.onchange = () => {
      const v = cfgTrabajoSel.value || 'semana';
      let txt;
      if (v === 'mes') txt = 'Trabajo mensual';
      else if (v === 'anio') txt = 'Trabajo anual';
      else txt = 'Trabajo semanal';
      setText('cardModelTrabajoLabel', txt);
    };
  }

  // Confirmar configuraci√≥n de tarjetas
  $('cardCfgConfirm').onclick = () => {
    const kSel = $('cardCfgKilos');
    const wSel = $('cardCfgTrabajo');

    const k = kSel?.value || 'mes';
    const w = wSel?.value || 'semana';

    cardCfg = {
      kilos: ['mes', 'anio'].includes(k) ? k : 'mes',
      trabajo: ['semana', 'mes', 'anio'].includes(w) ? w : 'semana'
    };
    saveCardCfg();
    syncCardModelLabels();

    // Re-render de todas las tarjetas
    renderDeviceCards(lastItemsCache || []);

    // Salir de modo edici√≥n
    editing = false;
    const btnEdit = $('btnEdit');
    if (btnEdit) btnEdit.textContent = 'Editar orden';
    const cardsWrap = $('autoCards');
    if (cardsWrap) cardsWrap.classList.remove('editing');
    const model = $('cardModel');
    if (model) model.style.display = 'none';
    disableDnD();
  };

  // Reset configuraci√≥n a valores por defecto
  $('cardCfgReset').onclick = () => {
    cardCfg = { kilos: 'mes', trabajo: 'semana' };
    saveCardCfg();

    const kSel = $('cardCfgKilos');
    const wSel = $('cardCfgTrabajo');
    if (kSel) kSel.value = cardCfg.kilos;
    if (wSel) wSel.value = cardCfg.trabajo;

    syncCardModelLabels();
    renderDeviceCards(lastItemsCache || []);
  };

  function enableDnD() {
    document.querySelectorAll('.device-card').forEach(c => {
      c.draggable = true;
      c.addEventListener('dragstart', onDragStart);
      c.addEventListener('dragover', onDragOver);
      c.addEventListener('drop', onDrop);
      c.addEventListener('dragend', onDragEnd);
    });
  }

  function disableDnD() {
    document.querySelectorAll('.device-card').forEach(c => {
      c.draggable = false;
      c.removeEventListener('dragstart', onDragStart);
      c.removeEventListener('dragover', onDragOver);
      c.removeEventListener('drop', onDrop);
      c.removeEventListener('dragend', onDragEnd);
    });
  }

  let dragId = null;

  function onDragStart(e) {
    dragId = this.dataset.device;
    e.dataTransfer.effectAllowed = 'move';
    this.classList.add('dragging');
  }

  function onDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
  }

  function onDrop(e) {
    e.preventDefault();
    const target = this.dataset.device;
    if (!dragId || dragId === target) return;
    const wrap = $('autoCards');
    const a = wrap.querySelector(`.device-card[data-device="${CSS.escape(dragId)}"]`);
    const b = wrap.querySelector(`.device-card[data-device="${CSS.escape(target)}"]`);
    const aNext = a.nextSibling, bNext = b.nextSibling;
    if (aNext === b) wrap.insertBefore(b, a);
    else if (bNext === a) wrap.insertBefore(a, b);
    else {
      wrap.insertBefore(a, bNext);
      wrap.insertBefore(b, aNext);
    }
  }

  function onDragEnd() {
    this.classList.remove('dragging');
  }

  /* =========================================================
   *  OVERLAY POR COLMENA (detalle)
   * =======================================================*/
  document.addEventListener('click', (e) => {
    const card = e.target.closest('.device-card');
    if (card && !editing) {
      openOverlay(card.dataset.device);
    }
  });

  $('btnOverlayBack').onclick = closeOverlay;

  function openOverlay(id) {
    currentOverlayDevice = String(id);
    setText('overlayTitle', 'Colmena ' + id);

    const ov = $('deviceOverlay');
    ov.style.display = 'block';
    ov.setAttribute('aria-hidden', 'false');
    $('devicePanel').scrollTo({ top: 0, behavior: 'instant' });

    updateOverlayKPIs(lastItemsCache, currentOverlayDevice);

    $('ovProdDate').value = ymd(new Date());
    $('ovProdKilos').value = '';
    $('ovProdTbody').innerHTML = '<tr><td class="muted" colspan="2">Sin datos</td></tr>';
    $('ovProdHistWrap').style.display = 'none';
    $('ovBtnToggleHist').textContent = 'Ver historial';

    ovChartsVisible = false;
    $('ovChartsWrap').style.display = 'none';
    if (ovChartTemp) { ovChartTemp.destroy(); ovChartTemp = null; }
    if (ovChartHum) { ovChartHum.destroy(); ovChartHum = null; }

    $('ovDateFrom').value = ymd(new Date());
    $('ovDateTo').value = ymd(new Date());

    // Al abrir, modo ‚ÄúTrabajo / Aire / Movimiento‚Äù apagado
    setModeSelection(null);
  }

  function closeOverlay() {
    const ov = $('deviceOverlay');
    ov.style.display = 'none';
    ov.setAttribute('aria-hidden', 'true');
    currentOverlayDevice = null;
  }

  // Detecci√≥n de TEM/HUM por colmena
  function keyIsTemp(k) {
    const K = String(k || '').toUpperCase();
    if (K.startsWith('MOTHER.')) return false;
    return K.endsWith('.TEM') || K === 'TEM' || K.includes('TEMP');
  }

  function keyIsHum(k) {
    const K = String(k || '').toUpperCase();
    if (K.startsWith('MOTHER.')) return false;
    return K.endsWith('.HUM') || K === 'HUM' || K.includes('HUM');
  }

  function latestByDevice(items, deviceId, kind) {
    let best = null, bt = 0;
    for (const d of items || []) {
      if (String(d.device_id || '') !== String(deviceId)) continue;
      const ok = kind === 'TEM' ? keyIsTemp(d.sensor_key) : keyIsHum(d.sensor_key);
      if (!ok) continue;
      const t = new Date(d.ts).getTime();
      if (t > bt) {
        best = d;
        bt = t;
      }
    }
    return best;
  }

  function updateOverlayKPIs(items, deviceId) {
    const t = latestByDevice(items, deviceId, 'TEM');
    const h = latestByDevice(items, deviceId, 'HUM');
    setText('ovTemVal', t?.value != null ? fmt(t.value) : '‚Äî');
    setText('ovTemWhen', t ? dtAR(t.ts) : '‚Äî');
    setText('ovHumVal', h?.value != null ? fmt(h.value) : '‚Äî');
    setText('ovHumWhen', h ? dtAR(h.ts) : '‚Äî');
  }

  /* =========================================================
   *  BOUNDS (d√≠a / semana / mes) PARA TRABAJO
   * =======================================================*/
  function periodBounds(period, ref = new Date()) {
    const r = new Date(ref);
    let from = new Date(r), to = new Date(r);
    if (period === 'dia') {
      from.setHours(0, 0, 0, 0);
      to.setHours(23, 59, 59, 999);
    } else if (period === 'semana') {
      const d = (r.getDay() + 6) % 7; // lunes
      from.setHours(0, 0, 0, 0);
      from.setDate(from.getDate() - d);
      to = new Date(from);
      to.setDate(from.getDate() + 6);
      to.setHours(23, 59, 59, 999);
    } else { // mes
      from = new Date(r.getFullYear(), r.getMonth(), 1, 0, 0, 0, 0);
      to = new Date(r.getFullYear(), r.getMonth() + 1, 0, 23, 59, 59, 999);
    }
    return {
      fromT: +from,
      toT: +to,
      fromISO: from.toISOString(),
      toISO: to.toISOString()
    };
  }

  async function getWorkDataFor(period, deviceId) {
    if (period === 'dia') return lastItemsCache || [];
    const { fromISO, toISO } = periodBounds(period);
    return await workFetchRange(fromISO, toISO, deviceId);
  }

  /* =========================================================
   *  GR√ÅFICOS MADRE: TEM / HUM
   * =======================================================*/
  $('btnChart').onclick = () => {
    chartsVisible = !chartsVisible;
    $('chartsWrap').style.display = chartsVisible ? 'block' : 'none';
    $('btnChart').textContent = chartsVisible ? 'Ocultar gr√°fica' : 'Mostrar gr√°fica';
    if (chartsVisible) {
      if (!historyMode && lastItemsCache) {
        renderChartsDaily(lastItemsCache);
      }
    }
    $('histControls').style.display = chartsVisible ? 'flex' : 'none';
  };

  function buildLineChart(canvas, labels, values, lineColor, pointColor) {
    const ctx = canvas.getContext('2d');
    return new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          data: values,
          borderColor: lineColor,
          backgroundColor: 'transparent',
          borderWidth: 2.5,
          tension: .25,
          pointRadius: 0,
          pointHoverRadius: 4,
          pointBackgroundColor: lineColor,
          pointBorderColor: lineColor
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'nearest', intersect: false },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              title: (it) => it[0]?.label || '',
              label: (it) => ` ${it.raw} `
            }
          }
        },
        scales: {
          x: { title: { display: true, text: 'Hora' } },
          y: {
            title: { display: false },
            ticks: { precision: 0 }
          }
        }
      }
    });
  }

  function sameLocalDay(tsA, tsB) {
    const a = new Date(tsA), b = new Date(tsB);
    return a.getFullYear() === b.getFullYear() &&
      a.getMonth() === b.getMonth() &&
      a.getDate() === b.getDate();
  }

  function seriesOfDay(items, key) {
    const now = new Date();
    const arr = [];
    for (const d of items || []) {
      if (String(d.sensor_key || '').toUpperCase() !== key) continue;
      if (!sameLocalDay(d.ts, now)) continue;
      const v = d.value == null || Number.isNaN(+d.value) ? null : Number(d.value);
      if (v == null) continue;
      const t = new Date(d.ts);
      const hh = String(t.getHours()).padStart(2, '0');
      const mm = String(t.getMinutes()).padStart(2, '0');
      arr.push({ label: `${hh}:${mm}`, x: t.getTime(), y: v });
    }
    arr.sort((a, b) => a.x - b.x);
    return arr;
  }

  function renderChartsDaily(items) {
    const tem = seriesOfDay(items, 'MOTHER.TEM');
    const labelsT = tem.map(d => d.label);
    const valsT = tem.map(d => d.y);

    const hum = seriesOfDay(items, 'MOTHER.HUM');
    const labelsH = hum.map(d => d.label);
    const valsH = hum.map(d => d.y);

    if (chartTemp) chartTemp.destroy();
    if (chartHum) chartHum.destroy();

    chartTemp = buildLineChart($('chartTemp'), labelsT, valsT, '#ff4d4f');
    chartHum = buildLineChart($('chartHum'), labelsH, valsH, '#4da3ff');

    setText('titleTemp', 'Temperatura de hoy');
    setText('titleHum', 'Humedad de hoy');
  }

  /* =========================================================
   *  GR√ÅFICOS OVERLAY COLMENA: TEM / HUM
   * =======================================================*/
  $('overlayBtnChart').onclick = () => {
    if (!currentOverlayDevice) return;
    ovChartsVisible = !ovChartsVisible;
    $('overlayBtnChart').textContent = ovChartsVisible ? 'Ocultar gr√°fica' : 'Mostrar gr√°fica';
    $('ovChartsWrap').style.display = ovChartsVisible ? 'block' : 'none';
    $('ovHistControls').style.display = ovChartsVisible ? 'flex' : 'none';
    if (ovChartsVisible) {
      renderOverlayChartsDaily(lastItemsCache, currentOverlayDevice);
    }
  };

  function seriesOfDayForDevice(items, deviceId, pickKind) {
    const now = new Date();
    const arr = [];
    for (const d of items || []) {
      if (String(d.device_id || '') !== String(deviceId)) continue;
      const ok = pickKind === 'TEM' ? keyIsTemp(d.sensor_key) : keyIsHum(d.sensor_key);
      if (!ok) continue;
      if (!sameLocalDay(d.ts, now)) continue;
      const v = d.value == null || Number.isNaN(+d.value) ? null : Number(d.value);
      if (v == null) continue;
      const t = new Date(d.ts);
      const hh = String(t.getHours()).padStart(2, '0');
      const mm = String(t.getMinutes()).padStart(2, '0');
      arr.push({ label: `${hh}:${mm}`, x: t.getTime(), y: v });
    }
    arr.sort((a, b) => a.x - b.x);
    return arr;
  }

  function renderOverlayChartsDaily(items, deviceId) {
    const tem = seriesOfDayForDevice(items, deviceId, 'TEM');
    const labelsT = tem.map(d => d.label);
    const valsT = tem.map(d => d.y);

    const hum = seriesOfDayForDevice(items, deviceId, 'HUM');
    const labelsH = hum.map(d => d.label);
    const valsH = hum.map(d => d.y);

    if (ovChartTemp) ovChartTemp.destroy();
    if (ovChartHum) ovChartHum.destroy();

    ovChartTemp = buildLineChart($('ovChartTemp'), labelsT, valsT, '#ff4d4f');
    ovChartHum = buildLineChart($('ovChartHum'), labelsH, valsH, '#4da3ff');

    setText('ovTitleTemp', 'Temperatura de hoy');
    setText('ovTitleHum', 'Humedad de hoy');
  }

  $('ovBtnShowRange').onclick = () => {
    const df = $('ovDateFrom').value;
    const dt = $('ovDateTo').value;
    if (!df || !dt || !currentOverlayDevice) return;

    const fromT = toLocalDayStart(df);
    const toT = toLocalDayEnd(dt);

    const items = (lastItemsCache || []).filter(d =>
      String(d.device_id || '') === String(currentOverlayDevice) &&
      new Date(d.ts).getTime() >= fromT &&
      new Date(d.ts).getTime() <= toT
    );

    const tem = items
      .filter(d => keyIsTemp(d.sensor_key))
      .sort((a, b) => new Date(a.ts) - new Date(b.ts))
      .map(d => {
        const t = new Date(d.ts);
        const lab = `${String(t.getHours()).padStart(2, '0')}:${String(t.getMinutes()).padStart(2, '0')}`;
        return { label: lab, y: Number(d.value) };
      });

    const hum = items
      .filter(d => keyIsHum(d.sensor_key))
      .sort((a, b) => new Date(a.ts) - new Date(b.ts))
      .map(d => {
        const t = new Date(d.ts);
        const lab = `${String(t.getHours()).padStart(2, '0')}:${String(t.getMinutes()).padStart(2, '0')}`;
        return { label: lab, y: Number(d.value) };
      });

    if (ovChartTemp) ovChartTemp.destroy();
    if (ovChartHum) ovChartHum.destroy();

    ovChartTemp = buildLineChart(
      $('ovChartTemp'),
      tem.map(x => x.label),
      tem.map(x => x.y),
      '#ff4d4f'
    );
    ovChartHum = buildLineChart(
      $('ovChartHum'),
      hum.map(x => x.label),
      hum.map(x => x.y),
      '#4da3ff'
    );

    setText('ovTitleTemp', `Temperatura ${df} ‚Üí ${dt}`);
    setText('ovTitleHum', `Humedad ${df} ‚Üí ${dt}`);
  };

  $('ovBtnExitHistory').onclick = () => {
    if (ovChartsVisible) {
      renderOverlayChartsDaily(lastItemsCache, currentOverlayDevice);
    }
    $('ovDateFrom').value = ymd(new Date());
    $('ovDateTo').value = ymd(new Date());
    setText('ovTitleTemp', 'Temperatura de hoy');
    setText('ovTitleHum', 'Humedad de hoy');
  };

  /* =========================================================
   *  HISTORIAL MADRE (rango fechas + CSV)
   * =======================================================*/
  function initDateDefaults() {
    const val = ymd(new Date());
    $('dateFrom').value = val;
    $('dateTo').value = val;
  }

  $('btnShowRange').onclick = () => showRange();
  $('btnDownloadCSV').onclick = () => downloadCSV();
  $('btnClearHistory').onclick = () => {
    $('dateFrom').value = '';
    $('dateTo').value = '';
    historyMode = false;
    if (chartsVisible && lastItemsCache) renderChartsDaily(lastItemsCache);
    setText('titleTemp', 'Temperatura de hoy');
    setText('titleHum', 'Humedad de hoy');
  };

  async function fetchRange(fromISO, toISO) {
    try {
      const q = `/datapoints?from=${encodeURIComponent(fromISO)}&to=${encodeURIComponent(toISO)}&limit=5000`;
      const { items } = await callWorker(q);
      return items || [];
    } catch (e) {
      return lastItemsCache || [];
    }
  }

  function normalizeDateRangeInputs() {
    let df = $('dateFrom').value;
    let dt = $('dateTo').value;
    if (!df || !dt) return null;
    const a = toLocalDayStart(df), b = toLocalDayStart(dt);
    if (a > b) {
      const tmp = df;
      df = dt;
      dt = tmp;
    }
    return {
      df,
      dt,
      fromISO: new Date(df + 'T00:00:00').toISOString(),
      toISO: new Date(dt + 'T23:59:59.999').toISOString()
    };
  }

  async function showRange() {
    const r = normalizeDateRangeInputs();
    if (!r) return;

    historyMode = true;
    const itemsSrv = await fetchRange(r.fromISO, r.toISO);
    const fromT = toLocalDayStart(r.df);
    const toT = toLocalDayEnd(r.dt);

    const items = (itemsSrv || []).filter(d => {
      const t = new Date(d.ts).getTime();
      return t >= fromT && t <= toT;
    });

    const tem = seriesByRange(items, 'MOTHER.TEM');
    const labelsT = tem.map(d => d.label);
    const valsT = tem.map(d => d.y);

    const hum = seriesByRange(items, 'MOTHER.HUM');
    const labelsH = hum.map(d => d.label);
    const valsH = hum.map(d => d.y);

    if (chartTemp) chartTemp.destroy();
    if (chartHum) chartHum.destroy();

    chartTemp = buildLineChart($('chartTemp'), labelsT, valsT, '#ff4d4f');
    chartHum = buildLineChart($('chartHum'), labelsH, valsH, '#4da3ff');

    setText('titleTemp', `Temperatura ${r.df} ‚Üí ${r.dt}`);
    setText('titleHum', `Humedad ${r.df} ‚Üí ${r.dt}`);
  }

  function seriesByRange(items, key) {
    const arr = [];
    for (const d of items || []) {
      if (String(d.sensor_key || '').toUpperCase() !== key) continue;
      const v = d.value == null || Number.isNaN(+d.value) ? null : Number(d.value);
      if (v == null) continue;
      const t = new Date(d.ts);
      const lab = `${t.getFullYear()}-${String(t.getMonth() + 1).padStart(2, '0')}-${String(t.getDate()).padStart(2, '0')} ${String(t.getHours()).padStart(2, '0')}:${String(t.getMinutes()).padStart(2, '0')}`;
      arr.push({ label: lab, x: t.getTime(), y: v });
    }
    arr.sort((a, b) => a.x - b.x);
    return arr;
  }

  function toCSV(items, df = null, dt = null) {
    const fromT = df ? toLocalDayStart(df) : -Infinity;
    const toT = dt ? toLocalDayEnd(dt) : Infinity;
    const base = (items || []).filter(d => {
      const t = new Date(d.ts).getTime();
      return t >= fromT && t <= toT;
    });
    const rows = [['timestamp_iso', 'fecha_local', 'hora_local', 'dispositivo', 'sensor', 'valor']];
    for (const d of base) {
      if (!/^MOTHER\.(TEM|HUM)$/i.test(String(d.sensor_key || ''))) continue;
      const ts = new Date(d.ts);
      const fecha = ts.toLocaleDateString('es-AR');
      const hora = ts.toLocaleTimeString('es-AR', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      rows.push([
        ts.toISOString(),
        fecha,
        hora,
        d.device_id || '',
        d.sensor_key || '',
        d.value == null ? '' : String(d.value)
      ]);
    }
    return rows.map(r => r.map(cell =>
      /[,;\n"]/.test(cell)
        ? `"${String(cell).replace(/"/g, '""')}"`
        : cell
    ).join(',')).join('\n');
  }

  async function downloadCSV() {
    const df = $('dateFrom').value;
    const dt = $('dateTo').value;
    const csv = toCSV(lastItemsCache, df || null, dt || null);
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = (df && dt) ? `miellifera_${df}_a_${dt}.csv` : 'miellifera_hoy.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  /* =========================================================
   *  WORKER: DATOS DE TRABAJO (C2R, NHR, etc.)
   * =======================================================*/
  async function workFetchRange(fromISO, toISO, deviceId) {
    try {
      const q = `/datapoints?from=${encodeURIComponent(fromISO)}&to=${encodeURIComponent(toISO)}&limit=5000`;
      const { items } = await callWorker(q);
      const keys = ['C2R', 'NHR', 'NXR', 'ALR', 'SMR', 'MS', 'OPN'];
      return (items || []).filter(d =>
        String(d.device_id) === String(deviceId) &&
        keys.includes(String(d.sensor_key || '').toUpperCase().trim())
      );
    } catch (e) {
      return lastItemsCache || [];
    }
  }
    /* =========================================================
   *   PRODUCCI√ìN: APIARIO + COLMENA + REINAS
   * =======================================================*/

  // --- API Worker producci√≥n ---
  async function prodInsert(device_id, fecha, kilos) {
    if (!(Number(kilos) > 0)) throw new Error('kilos debe ser > 0');
    return callWorker('/production', {
      method: 'POST',
      body: { device_id, fecha, kilos }
    });
  }

  async function prodList(params) {
    const url = new URL(BASE + '/production');
    if (params?.device_id) url.searchParams.set('device_id', params.device_id);
    if (params?.fromISO) url.searchParams.set('from', params.fromISO);
    if (params?.toISO) url.searchParams.set('to', params.toISO);

    const u = auth.currentUser;
    if (!u) throw new Error('No auth');
    const t = await u.getIdToken();
    const res = await fetch(url.toString(), {
      headers: { 'Authorization': `Bearer ${t}` }
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();   // { items: [...] }
  }

  // --- Estado en memoria de producci√≥n ---

  let prodApiaryYearChart = null;
  let prodApiaryMonthlyChart = null;
  let prodHiveMonthlyChart = null;
  let prodHiveQueenChart = null;

  // Helpers de charts
  function destroyProdCharts() {
    if (prodApiaryYearChart) { prodApiaryYearChart.destroy(); prodApiaryYearChart = null; }
    if (prodApiaryMonthlyChart) { prodApiaryMonthlyChart.destroy(); prodApiaryMonthlyChart = null; }
    if (prodHiveMonthlyChart) { prodHiveMonthlyChart.destroy(); prodHiveMonthlyChart = null; }
    if (prodHiveQueenChart) { prodHiveQueenChart.destroy(); prodHiveQueenChart = null; }
  }

  // Tabla vac√≠a por defecto
  function setProdNoData(show, msg) {
    const box = $('prodNoDataMsg');
    if (!box) return;
    box.style.display = show ? 'block' : 'none';
    if (msg != null) box.textContent = String(msg);
  }

  // Tabla vac√≠a por defecto
  function resetProdTable(msg) {
    const tb = $('prodGlobalTbody');
    if (tb) {
      tb.innerHTML = '<tr><td class="muted" colspan="3">Sin datos encontrados</td></tr>';
    }
    setText('prodGlobalTotal', '0.00');
    setProdNoData(true, msg || 'Sin datos encontrados');
  }

  // Rellenar selects de colmenas (filtro + nueva producci√≥n)
  function fillProdDeviceSelects() {
    const devices = getKnownDevices();   // ya lo ten√©s definido
    const filterSel = $('prodDevice');
    const newSel = $('prodNewDevice');

    const options = devices.map(id => `<option value="${id}">${id}</option>`).join('');

    if (filterSel) {
      filterSel.innerHTML = '<option value="">Todas</option>' + options;
    }
    if (newSel) {
      newSel.innerHTML = '<option value="">Seleccionar‚Ä¶</option>' + options;
    }
  }

  // Abrir / cerrar overlay
  function openProdOverlay() {
    const ov = $('prodOverlay');
    if (!ov) return;

    ov.style.display = 'block';
    ov.setAttribute('aria-hidden', 'false');

    // Filtros: al abrir, SIN rango de fechas y SIN colmena ‚Üí apiario completo
    const fromInput = $('prodFrom');
    const toInput = $('prodTo');
    const devSel = $('prodDevice');
    const viewSel = $('prodView'); // si existe

    if (fromInput) fromInput.value = '';
    if (toInput) toInput.value = '';
    if (devSel) devSel.value = '';

    // Vista por defecto: APIARIO ANUAL
    if (viewSel) viewSel.value = 'anio';

    // Selects de colmenas (filtro + carga nueva prod)
    fillProdDeviceSelects();

    // Limpiar estado previo
    prodLastItems = [];
    destroyProdCharts();
    setProdNoData(false);
    const tb = $('prodGlobalTbody');
    if (tb) tb.innerHTML = '<tr><td class="muted" colspan="3">Cargando‚Ä¶</td></tr>';
    setText('prodGlobalTotal', '‚Äî');

    const csvBtn = $('btnProdCSV');
    if (csvBtn) csvBtn.style.display = 'none';

    const summary = $('prodSummary');
    if (summary) {
      summary.textContent = 'Cargando producci√≥n del apiario...';
    }

    // Disparar la b√∫squeda con filtros vac√≠os (apiario completo)
    const showBtn = $('btnProdShow');
    if (showBtn) {
      showBtn.click();
    }
  }

  function closeProdOverlay() {
    const ov = $('prodOverlay');
    if (!ov) return;
    ov.style.display = 'none';
    ov.setAttribute('aria-hidden', 'true');
  }

  // Botones abrir/cerrar overlay principal
  $('btnProdMain').onclick = () => openProdOverlay();
  $('btnProdBack').onclick = () => closeProdOverlay();

  // Resumen num√©rico
  function summarizeProduction(items) {
    let total = 0;
    const byHive = {};
    for (const r of (items || [])) {
      const id = String(r.device_id || '').trim() || '‚Äî';
      const k = Number(r.kilos || 0);
      total += k;
      byHive[id] = (byHive[id] || 0) + k;
    }
    let bestId = null, bestVal = 0;
    for (const [id, val] of Object.entries(byHive)) {
      if (val > bestVal) { bestVal = val; bestId = id; }
    }
    return { total, byHive, bestId, bestVal, hives: Object.keys(byHive).length };
  }

  function updateProdSummary(items, devFilter) {
    const { total, byHive, bestId, bestVal, hives } = summarizeProduction(items);
    let txt = `Total en el per√≠odo: ${total.toFixed(2)} kg. `;
    if (devFilter) {
      txt += `Colmena seleccionada: ${devFilter}.`;
    } else {
      if (hives > 0) txt += `Colmenas con producci√≥n: ${hives}. `;
      if (bestId) txt += `Colmena destacada: ${bestId} (${bestVal.toFixed(2)} kg).`;
    }
    const el = $('prodSummary');
    if (el) el.textContent = txt;
  }

  // Agrupar por a√±o (acepta r.fecha o r.date)
  function groupProdByYear(items) {
    const map = {};
    for (const r of (items || [])) {
      const f = String(r.fecha || r.date || '');
      if (!f) continue;
      const y = Number(f.slice(0, 4));
      if (!y) continue;
      const k = Number(r.kilos || 0);
      map[y] = (map[y] || 0) + k;
    }
    const years = Object.keys(map).map(Number).sort((a, b) => a - b);
    return { years, data: years.map(y => map[y]) };
  }

  // Agrupar por mes y a√±o ‚Üí series por a√±o (labels = meses 1..12)
  // Soporta r.fecha o r.date
  function groupProdByMonthPerYear(items) {
    const map = {};  // year -> [12]
    for (const r of (items || [])) {
      const f = String(r.fecha || r.date || '');
      if (!f) continue;
      const parts = f.split('-');
      const y = Number(parts[0] || 0);
      const m = Number(parts[1] || 0);
      if (!y || !m) continue;
      if (!map[y]) map[y] = new Array(12).fill(0);
      map[y][m - 1] += Number(r.kilos || 0);
    }
    const years = Object.keys(map).map(Number).sort((a, b) => a - b);
    const monthLabels = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    const series = years.map(y => map[y] || new Array(12).fill(0));
    return { years, monthLabels, series };
  }

  // Gr√°ficos APIARIO (sin filtro de colmena)
  function renderApiaryCharts(items) {
    const { years, data } = groupProdByYear(items);
    const { years: yearsM, monthLabels, series } = groupProdByMonthPerYear(items);
    const palette = ['#ffb74d', '#4da3ff', '#49d17d', '#ff6b6b', '#7fb3ff', '#ce93d8', '#fff176', '#80cbc4'];

    const ctxYear = $('prodApiaryYearChart')?.getContext('2d');
    if (ctxYear && years.length) {
      prodApiaryYearChart = new Chart(ctxYear, {
        type: 'bar',
        data: {
          labels: years,
          datasets: [{
            data,
            backgroundColor: years.map((_, i) => palette[i % palette.length])
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { title: { display: true, text: 'A√±o' } },
            y: { title: { display: true, text: 'Kilos' }, beginAtZero: true }
          }
        }
      });
    }

    const ctxMonth = $('prodApiaryMonthlyChart')?.getContext('2d');
    if (ctxMonth && yearsM.length) {
      const datasets = yearsM.map((y, idx) => ({
        label: String(y),
        data: series[idx],
        borderColor: palette[idx % palette.length],
        backgroundColor: 'transparent',
        borderWidth: 2,
        tension: .25,
        pointRadius: 0,
        spanGaps: true
      }));
      prodApiaryMonthlyChart = new Chart(ctxMonth, {
        type: 'line',
        data: { labels: monthLabels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: true } },
          interaction: { mode: 'index', intersect: false },
          scales: {
            x: { title: { display: true, text: 'Mes' } },
            y: { title: { display: true, text: 'Kilos' }, beginAtZero: true }
          }
        }
      });
    }
  }

  // Gr√°ficos COLMENA (filtro de colmena activo)
  async function renderHiveCharts(items, deviceId) {
    const ctxMonth = $('prodHiveMonthlyChart')?.getContext('2d');
    const ctxQueen = $('prodHiveQueenChart')?.getContext('2d');
    const titleMonth = $('prodHiveMonthlyTitle');
    const titleQueen = $('prodHiveQueenTitle');

    if (titleMonth) {
      titleMonth.textContent = `Producci√≥n mensual por a√±o ‚Äì Colmena ${deviceId}`;
    }
    if (titleQueen) {
      titleQueen.textContent = `Producci√≥n anual y cambios de reina ‚Äì Colmena ${deviceId}`;
    }

    // Filtramos expl√≠citamente por colmena por si el Worker devuelve todo el apiario
    const hiveItems = (items || []).filter(r =>
      String(r.device_id || '').trim() === String(deviceId).trim()
    );

    if (!hiveItems.length) {
      // Sin datos para esa colmena ‚Üí evitamos gr√°ficos "en blanco silencioso"
      if (ctxMonth && prodHiveMonthlyChart) { prodHiveMonthlyChart.destroy(); prodHiveMonthlyChart = null; }
      if (ctxQueen && prodHiveQueenChart) { prodHiveQueenChart.destroy(); prodHiveQueenChart = null; }
      updateProdSummary(items, deviceId); // igual mostramos resumen
      return;
    }

    const palette = ['#ffb74d', '#4da3ff', '#49d17d', '#ff6b6b', '#7fb3ff', '#ce93d8', '#fff176', '#80cbc4'];

    // ===== 1) Mensual por a√±o para ESA colmena (l√≠neas) =====
    const { years, monthLabels, series } = groupProdByMonthPerYear(hiveItems);
    if (ctxMonth && years.length) {
      const datasets = years.map((y, idx) => ({
        label: String(y),
        data: series[idx],
        borderColor: palette[idx % palette.length],
        backgroundColor: 'transparent',
        borderWidth: 2,
        tension: .25,
        pointRadius: 0,
        spanGaps: true
      }));
      prodHiveMonthlyChart = new Chart(ctxMonth, {
        type: 'line',
        data: { labels: monthLabels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: true } },
          interaction: { mode: 'index', intersect: false },
          scales: {
            x: { title: { display: true, text: 'Mes' } },
            y: { title: { display: true, text: 'Kilos' }, beginAtZero: true }
          }
        }
      });
    }

    // ===== 2) Anual + cambios de reina (barras por reina) =====
    if (!ctxQueen) {
      updateProdSummary(hiveItems, deviceId);
      return;
    }

    const { years: yearsY, data: dataY } = groupProdByYear(hiveItems);
    if (!yearsY.length) {
      updateProdSummary(hiveItems, deviceId);
      return;
    }

    // Traemos cambios de reina de /queens
    let queens = [];
    try {
      const { items: qItems = [] } = await queenList({ device_id: deviceId });
      queens = (qItems || []).slice().sort((a, b) => Number(a.year) - Number(b.year));
    } catch (e) {
      queens = [];
    }

    // Helper: qu√© reina aplica en un a√±o dado (√∫ltima <= a√±o)
    function queenYearFor(y) {
      let current = null;
      for (const q of queens) {
        const qy = Number(q.year);
        if (!qy) continue;
        if (qy <= y) current = qy;
      }
      return current; // a√±o de la reina vigente ese a√±o
    }

    // Mapear cada reina (por a√±o) a un color fijo
    const queenColorMap = {};
    let colorIdx = 0;
    function colorForQueenYear(qYear) {
      if (!qYear) return '#9aa3ad';
      if (!queenColorMap[qYear]) {
        queenColorMap[qYear] = palette[colorIdx % palette.length];
        colorIdx++;
      }
      return queenColorMap[qYear];
    }

    // Reina aplicada por a√±o (seg√∫n a√±o de producci√≥n)
    const queenForEachYear = yearsY.map(y => queenYearFor(y));
    const barColors = yearsY.map((y, idx) => colorForQueenYear(queenForEachYear[idx]));

    // Marcadores de cambio de reina:
    const changeYears = new Set(queens.map(q => Number(q.year) || 0));
    const markerData = [];
    const markerColors = [];

    yearsY.forEach((y, idx) => {
      if (changeYears.has(y)) {
        markerData.push(dataY[idx]); // punto arriba de la barra
      } else {
        markerData.push(null);
      }
      markerColors.push(colorForQueenYear(queenForEachYear[idx]));
    });

    prodHiveQueenChart = new Chart(ctxQueen, {
      type: 'bar',
      data: {
        labels: yearsY,
        datasets: [
          {
            label: 'Producci√≥n anual',
            data: dataY,
            backgroundColor: barColors,
            borderWidth: 1
          },
          {
            type: 'line',
            label: 'Cambios de reina',
            data: markerData,
            showLine: false,
            pointRadius: 6,
            pointHoverRadius: 7,
            pointBackgroundColor: markerColors,
            pointBorderColor: '#ffffff',
            borderWidth: 0
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true }
        },
        interaction: { mode: 'index', intersect: false },
        scales: {
          x: { title: { display: true, text: 'A√±o' } },
          y: { title: { display: true, text: 'Kilos' }, beginAtZero: true }
        }
      }
    });

    updateProdSummary(hiveItems, deviceId);
  }

  // Decide qu√© gr√°ficos mostrar seg√∫n filtro de colmena
  function renderProdCharts() {
    destroyProdCharts();
    const items = prodLastItems || [];
    const apiaryWrap = $('prodApiaryCharts');
    const hiveWrap = $('prodHiveCharts');
    const dev = $('prodDevice')?.value || '';

    if (!items.length) {
      if (apiaryWrap) apiaryWrap.style.display = 'none';
      if (hiveWrap) hiveWrap.style.display = 'none';
      const s = $('prodSummary');
      if (s) s.textContent = 'Sin datos en el rango seleccionado.';
      return;
    }

    if (dev) {
      if (apiaryWrap) apiaryWrap.style.display = 'none';
      if (hiveWrap) hiveWrap.style.display = 'grid';
      renderHiveCharts(items, dev);
    } else {
      if (apiaryWrap) apiaryWrap.style.display = 'grid';
      if (hiveWrap) hiveWrap.style.display = 'none';
      renderApiaryCharts(items);
      updateProdSummary(items, '');
    }
  }

  // Mostrar resultados seg√∫n filtros
  $('btnProdShow').onclick = async () => {
    const df = $('prodFrom').value;
    const dt = $('prodTo').value;
    const dev = $('prodDevice').value || '';

    const fromISO = df ? new Date(df + 'T00:00:00').toISOString() : undefined;
    const toISO = dt ? new Date(dt + 'T23:59:59.999').toISOString() : undefined;

    try {
      const { items } = await prodList({
        device_id: dev || undefined,
        fromISO,
        toISO
      });
      prodLastItems = items || [];

      const tb = $('prodGlobalTbody');
      if (!items?.length) {
        resetProdTable('Sin datos encontrados para ese filtro.');
        const csvBtn = $('btnProdCSV');
        if (csvBtn) csvBtn.style.display = 'none';
        renderProdCharts();
        return;
      }

      setProdNoData(false);

      tb.innerHTML = items.map(r => `
        <tr>
          <td>${escapeHtml(String(r.fecha || r.date || ''))}</td>
          <td>${escapeHtml(r.device_id)}</td>
          <td class="num">${Number(r.kilos).toFixed(2)}</td>
        </tr>`).join('');

      const total = items.reduce((a, b) => a + Number(b.kilos || 0), 0);
      setText('prodGlobalTotal', total.toFixed(2));

      const csvBtn = $('btnProdCSV');
      if (csvBtn) csvBtn.style.display = 'inline-flex';

      renderProdCharts();
    } catch (e) {
      alert('Error consultando: ' + (e.message || e));
    }
  };

  // Reset filtros y gr√°ficos
  function prodResetFilters() {
    // Volver al estado inicial (sin filtros): apiario completo
    if ($('prodFrom')) $('prodFrom').value = '';
    if ($('prodTo')) $('prodTo').value = '';
    if ($('prodDevice')) $('prodDevice').value = '';

    const viewSel = $('prodView');
    if (viewSel) viewSel.value = 'anio';

    prodLastItems = [];
    destroyProdCharts();
    setProdNoData(false);

    const tb = $('prodGlobalTbody');
    if (tb) tb.innerHTML = '<tr><td class="muted" colspan="3">Cargando‚Ä¶</td></tr>';
    setText('prodGlobalTotal', '‚Äî');

    const csvBtn = $('btnProdCSV');
    if (csvBtn) csvBtn.style.display = 'none';

    const s = $('prodSummary');
    if (s) s.textContent = 'Cargando producci√≥n del apiario.';

    // disparar consulta sin filtros
    const showBtn = $('btnProdShow');
    if (showBtn) showBtn.click();
  }

  $('btnProdReset').onclick = () => prodResetFilters();

  // CSV de producci√≥n (historial)
  function prodDownloadCSV() {
    const items = prodLastItems || [];
    if (!items.length) {
      alert('Sin datos para exportar');
      return;
    }
    const rows = [['fecha', 'colmena', 'kilos']];
    for (const r of items) {
      rows.push([
        String(r.fecha || r.date || ''),
        String(r.device_id || ''),
        String(Number(r.kilos || 0).toFixed(2))
      ]);
    }
    const csv = rows.map(r => r.join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'produccion.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  $('btnProdCSV').onclick = () => prodDownloadCSV();

  // Formulario ‚ÄúNueva producci√≥n‚Äù
  const prodNewForm = $('prodNewForm');
  if (prodNewForm) {
    prodNewForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const dev = $('prodNewDevice')?.value || '';
      const fecha = $('prodNewDate')?.value || '';
      const kilos = Number($('prodNewKilos')?.value || 0);

      if (!dev || !fecha || !(kilos > 0)) {
        alert('Complete colmena, fecha y kilos > 0');
        return;
      }
      try {
        await prodInsert(dev, fecha, kilos);
        $('prodNewKilos').value = '';

        // Si ya hay un rango cargado, refrescamos la vista actual
        if ($('prodFrom').value && $('prodTo').value) {
          $('btnProdShow').click();
        }
      } catch (e) {
        alert('Error guardando producci√≥n: ' + (e.message || e));
      }
    });
  }

  // Inicializar fechas por defecto al cargar (madre + producci√≥n)
  function initProdDefaults() {
    const t = ymd(new Date());
    const ovd = $('ovProdDate'); // overlay por colmena
    if (ovd) ovd.value = t;
    const pf = $('prodFrom'), pt = $('prodTo');
    if (pf) pf.value = t;
    if (pt) pt.value = t;
  }

  /* =========================================================
   *  WORKER META: SANIDAD / CALENDARIO / NOTAS
   * =======================================================*/
  // SANIDAD
  async function healthInsert(payload) {
    // payload: { device_id, fecha, producto, dosis, unidad, dias_retiro, fecha_retiro, efectivo, notas }
    return callWorker('/health', { method: 'POST', body: payload });
  }

  async function healthList(params) {
    const url = new URL(BASE + '/health');
    if (params?.device_id) url.searchParams.set('device_id', params.device_id);
    if (params?.fromISO) url.searchParams.set('from', params.fromISO);
    if (params?.toISO) url.searchParams.set('to', params.toISO);
    const u = auth.currentUser;
    if (!u) throw new Error('No auth');
    const t = await u.getIdToken();
    const res = await fetch(url.toString(), { headers: { 'Authorization': `Bearer ${t}` } });
    if (!res.ok) throw new Error(await res.text());
    return res.json(); // { items: [...] }
  }
    // === Update de manejo sanitario (PATCH /health/:id) ===
  async function healthUpdate(id, payload) {
    if (!id) throw new Error('Falta id de tratamiento');
    return callWorker(`/health/${encodeURIComponent(id)}`, {
      method: 'PATCH',
      body: payload
    });
  }

  // === Worker Barroa ===
  async function varroaInsert(payload) {
    // payload: { device_id, fecha, porcentaje }
    return callWorker('/varroa', {
      method: 'POST',
      body: payload
    });
  }

  async function varroaList(params) {
    const url = new URL(BASE + '/varroa');
    if (params?.device_id) url.searchParams.set('device_id', params.device_id);
    if (params?.fromISO) url.searchParams.set('from', params.fromISO);
    if (params?.toISO) url.searchParams.set('to', params.toISO);
    const u = auth.currentUser;
    if (!u) throw new Error('No auth');
    const t = await u.getIdToken();
    const res = await fetch(url.toString(), {
      headers: { 'Authorization': `Bearer ${t}` }
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json(); // { items: [...] }
  }
  // CALENDARIO
  async function eventsInsert(payload) {
    // payload: { device_id, fecha, titulo, tipo, notas }
    return callWorker('/events', { method: 'POST', body: payload });
  }

  async function eventsList(params) {
    const url = new URL(BASE + '/events');
    if (params?.device_id) url.searchParams.set('device_id', params.device_id);
    if (params?.fromISO) url.searchParams.set('from', params.fromISO);
    if (params?.toISO) url.searchParams.set('to', params.toISO);
    const u = auth.currentUser;
    if (!u) throw new Error('No auth');
    const t = await u.getIdToken();
    const res = await fetch(url.toString(), { headers: { 'Authorization': `Bearer ${t}` } });
    if (!res.ok) throw new Error(await res.text());
    return res.json(); // { items: [...] }
  }

  // NOTAS
  async function notesInsert(payload) {
    // payload: { device_id, texto }
    return callWorker('/notes', { method: 'POST', body: payload });
  }

  async function notesList(params) {
    const url = new URL(BASE + '/notes');
    if (params?.device_id) url.searchParams.set('device_id', params.device_id);
    const u = auth.currentUser;
    if (!u) throw new Error('No auth');
    const t = await u.getIdToken();
    const res = await fetch(url.toString(), { headers: { 'Authorization': `Bearer ${t}` } });
    if (!res.ok) throw new Error(await res.text());
    return res.json(); // { items: [...] }
  }

  // ===== Queens Worker =====
  async function queenInsert(payload){
    // payload: { device_id, year }
    return callWorker('/queens', { method:'POST', body:payload });
  }

  async function queenList(params){
    const url = new URL(BASE + '/queens');
    if(params?.device_id) url.searchParams.set('device_id', params.device_id);
    const u = auth.currentUser; if(!u) throw new Error('No auth');
    const t = await u.getIdToken();
    const res = await fetch(url.toString(), {
      headers:{ 'Authorization': `Bearer ${t}` }
    });
    if(!res.ok) throw new Error(await res.text());
    return res.json(); // { items:[...] }
  }

  /* =========================================================
   *  PRODUCCI√ìN: MINI DASHBOARD EN OVERLAY COLMENA
   * =======================================================*/
  $('ovBtnSaveProd').onclick = async () => {
    if (!currentOverlayDevice) return;
    const fecha = $('ovProdDate').value;
    const kilos = Number($('ovProdKilos').value);
    if (!fecha || !(kilos > 0)) {
      alert('Complet√° fecha y kilos > 0');
      return;
    }
    try {
      await prodInsert(currentOverlayDevice, fecha, kilos);
      $('ovProdKilos').value = '';
      if ($('ovProdHistWrap').style.display !== 'none') {
        await loadOvProdHistory();
      }
    } catch (e) {
      alert('Error guardando: ' + (e.message || e));
    }
  };

  $('ovBtnToggleHist').onclick = async () => {
    const wrap = $('ovProdHistWrap');
    const show = wrap.style.display === 'none';
    wrap.style.display = show ? 'block' : 'none';
    $('ovBtnToggleHist').textContent = show ? 'Ocultar historial' : 'Ver historial';
    if (show) await loadOvProdHistory();
  };

  async function loadOvProdHistory() {
    if (!currentOverlayDevice) return;
    const { items } = await prodList({ device_id: currentOverlayDevice });
    const tb = $('ovProdTbody');
    if (!items?.length) {
      tb.innerHTML = '<tr><td class="muted" colspan="2">Sin datos</td></tr>';
      return;
    }
    tb.innerHTML = items.map(r =>
      `<tr>
        <td>${escapeHtml(r.fecha)}</td>
        <td class="num">${Number(r.kilos).toFixed(2)}</td>
      </tr>`
    ).join('');
  }

  // ================== Reina: render y overlay ==================
  function renderQueenMainCard(deviceId, items){
    const circle = $('queenCircle');
    const yearEl = $('queenYear');
    const legend = $('queenLegend');
    const subtitle = $('queenSubtitle');

    if(!circle || !yearEl || !legend || !subtitle){
      return;
    }

    if(!items || !items.length){
      // Sin datos
      circle.style.background = 'radial-gradient(circle at 30% 30%, #888, #444)';
      circle.style.borderColor = 'var(--border)';
      yearEl.textContent = '‚Äî';
      legend.textContent = 'Sin datos de reina para esta colmena.';
      subtitle.textContent = '√öltima reina registrada';
      return;
    }

    // Tomamos la m√°s reciente
    const latest = items[0]; // ya vienen ordenadas DESC por created_at
    const year = Number(latest.year);
    const { color, name } = queenColorForYear(year);

    circle.style.background = color;
    circle.style.borderColor = '#ffffff';
    yearEl.textContent = String(year);
    legend.textContent = `Color ${name} para a√±o terminado en ${Math.abs(year)%10}.`;
    subtitle.textContent = `√öltima reina registrada para Colmena ${deviceId}`;
  }

  function renderQueenHistory(items){
    const wrap = $('queenHistoryWrap');
    if(!wrap) return;

    if(!items || !items.length){
      wrap.innerHTML = '<p class="muted">Sin registros para esta colmena.</p>';
      return;
    }

    const ul = document.createElement('ul');
    ul.className = 'queen-history-list';

    items.forEach(r=>{
      const li = document.createElement('li');
      li.className = 'queen-history-item';

      const main = document.createElement('div');
      main.className = 'queen-history-item-main';

      const y = document.createElement('div');
      y.className = 'queen-history-year';
      y.textContent = `Reina ${r.year}`;

      const meta = document.createElement('div');
      meta.className = 'queen-history-meta';
      const d = r.created_at ? new Date(r.created_at) : null;
      const fecha = d ? d.toLocaleString('es-AR') : '(sin fecha)';
      meta.textContent = `Registrada el ${fecha}`;

      main.appendChild(y);
      main.appendChild(meta);

      li.appendChild(main);
      ul.appendChild(li);
    });

    wrap.innerHTML = '';
    wrap.appendChild(ul);
  }

  async function loadQueenData(deviceId){
    try{
      const { items=[] } = await queenList({ device_id: deviceId });
      renderQueenMainCard(deviceId, items);
      renderQueenHistory(items);
    }catch(e){
      console.error(e);
      const wrap = $('queenHistoryWrap');
      if(wrap){
        wrap.innerHTML = '<p class="muted">Error cargando historial de reinas.</p>';
      }
    }
  }

  function openQueenOverlay(deviceId){
    queenDeviceContext = String(deviceId||'');
    const ov = $('queenOverlay');
    const title = $('queenTitle');
    const input = $('queenYearInput');

    if(title) title.textContent = `Reina ¬∑ Colmena ${queenDeviceContext || '‚Äî'}`;
    if(ov){
      ov.style.display = 'block';
      ov.setAttribute('aria-hidden','false');
    }
    if(input){
      const year = new Date().getFullYear();
      input.value = year;
      input.focus();
    }

    // Cargar datos
    if(queenDeviceContext){
      loadQueenData(queenDeviceContext);
    }else{
      renderQueenMainCard(null, []);
      renderQueenHistory([]);
    }
  }

  function closeQueenOverlay(){
    const ov = $('queenOverlay');
    if(ov){
      ov.style.display = 'none';
      ov.setAttribute('aria-hidden','true');
    }
    queenDeviceContext = null;
  }

  (function initAnalysisModes() {
      return; // DESACTIVADO: ahora lo maneja setModeSelection() (inline + toggle)
    const buttons = document.querySelectorAll('.mode-toggle button');
    const cardsByMode = {
      work: document.getElementById('workCard'),
      air: document.getElementById('airCard'),
      motion: document.getElementById('motionCard'),
      prod: document.getElementById('prodCardHive'),
    };

    if (!buttons.length) return;

    function activateMode(mode) {
      // activar bot√≥n
      buttons.forEach(btn => {
        const isActive = btn.dataset.mode === mode;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      });

      // mostrar/ocultar cartas
      Object.entries(cardsByMode).forEach(([m, card]) => {
        if (!card) return;
        card.style.display = (m === mode) ? 'block' : 'none';
      });
    }

    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        const mode = btn.dataset.mode;
        if (mode) activateMode(mode);
      });
    });

    // Modo por defecto: Trabajo
    activateMode('work');
  })();

  /* =========================================================
   *  META OVERLAY: TABS (Sanidad / Calendario / Notas)
   * =======================================================*/
    function setMetaTabs(mode) {
    metaCurrentMode = mode;
    const tabs = [
      { id: 'tabSanidad', mode: 'sanidad', section: 'metaSanidad', title: 'Manejo sanitario' },
      { id: 'tabCalendario', mode: 'calendario', section: 'metaCalendario', title: 'Calendario' },
      { id: 'tabNotas', mode: 'notas', section: 'metaNotas', title: 'Anotaciones' }
    ];
    tabs.forEach(t => {
      const btn = $(t.id);
      const sec = $(t.section);
      if (!btn || !sec) return;
      const active = (t.mode === mode);
      btn.classList.toggle('active', active);
      sec.classList.toggle('active', active);
      if (active) setText('metaTitle', t.title);
    });

    if (mode === 'sanidad') {
      refreshSanidad();
      refreshVarroa();
    }
    if (mode === 'calendario') refreshCalendario();
    if (mode === 'notas') refreshNotas();
  }
    function openMetaOverlay(mode, deviceId) {
    metaDeviceContext = deviceId || null;
    const ov = $('metaOverlay');
    if (!ov) return;
    ov.style.display = 'block';
    ov.setAttribute('aria-hidden', 'false');

    const devices = getKnownDevices();

    const sanDevSel = $('sanidadDevice');
    const sanFilter = $('sanidadFilterDevice');
    const calDevSel = $('calDevice');
    const calFilter = $('calDeviceFilter');
    const noteDevSel = $('noteDevice');
    const notesFilter = $('notesDeviceFilter');
    const varDevSel = $('varroaDevice');
    const varFilter = $('varroaDeviceFilter');

    const optionsHtml = devices
      .map(id => `<option value="${id}">Colmena ${id}</option>`)
      .join('');

    if (sanDevSel) sanDevSel.innerHTML = '<option value="">Seleccionar colmena‚Ä¶</option>' + optionsHtml;
    if (sanFilter) sanFilter.innerHTML = '<option value="">Todas las colmenas</option>' + optionsHtml;
    if (calDevSel) calDevSel.innerHTML = '<option value="">General / apiario</option>' + optionsHtml;
    if (calFilter) calFilter.innerHTML = '<option value="">Todas las colmenas</option>' + optionsHtml;
    if (noteDevSel) noteDevSel.innerHTML = '<option value="">Seleccionar colmena‚Ä¶</option>' + optionsHtml;
    if (notesFilter) notesFilter.innerHTML = '<option value="">Todas las colmenas</option>' + optionsHtml;
    if (varDevSel) varDevSel.innerHTML = '<option value="">Seleccionar colmena‚Ä¶</option>' + optionsHtml;
    if (varFilter) varFilter.innerHTML = '<option value="">Todas las colmenas</option>' + optionsHtml;

    if (deviceId) {
      if (sanDevSel) sanDevSel.value = deviceId;
      if (sanFilter) sanFilter.value = deviceId;
      if (calDevSel) calDevSel.value = deviceId;
      if (calFilter) calFilter.value = deviceId;
      if (noteDevSel) noteDevSel.value = deviceId;
      if (notesFilter) notesFilter.value = deviceId;
      if (varDevSel) varDevSel.value = deviceId;
      if (varFilter) varFilter.value = deviceId;
    }

    const hoy = ymd(new Date());
    if ($('sanidadFrom') && !$('sanidadFrom').value) $('sanidadFrom').value = hoy;
    if ($('sanidadTo') && !$('sanidadTo').value) $('sanidadTo').value = hoy;
    if ($('sanidadDate') && !$('sanidadDate').value) $('sanidadDate').value = hoy;

    if ($('calMonth') && !$('calMonth').value) {
      const d = new Date();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      $('calMonth').value = `${d.getFullYear()}-${m}`;
    }
    if ($('calDate') && !$('calDate').value) $('calDate').value = hoy;

    if ($('varroaFrom') && !$('varroaFrom').value) $('varroaFrom').value = hoy;
    if ($('varroaTo') && !$('varroaTo').value) $('varroaTo').value = hoy;
    if ($('varroaDate') && !$('varroaDate').value) $('varroaDate').value = hoy;

    setMetaTabs(mode || 'sanidad');
  }
  function closeMetaOverlay() {
    const ov = $('metaOverlay');
    if (!ov) return;
    ov.style.display = 'none';
    ov.setAttribute('aria-hidden', 'true');
    metaCurrentMode = null;
    metaDeviceContext = null;
  }
    /* =========================================================
   *  SANIDAD + BARROA: LISTADO + ALTA
   * =======================================================*/

  // Sugerencias de producto (datalist) seg√∫n historial
  function buildSanidadProductSuggestions(items) {
    const dl = $('sanidadProductList');
    if (!dl) return;
    const set = new Set();
    for (const r of (items || [])) {
      const prod = r.producto || r.product || '';
      if (prod) set.add(prod);
    }
    const opts = Array.from(set).sort().map(p =>
      `<option value="${escapeHtml(p)}"></option>`
    ).join('');
    dl.innerHTML = opts;
  }

  // Tarjetas de tratamientos pendientes (‚Äúlista de espera‚Äù)
  function buildSanidadPendingCards(items) {
    const wrap = $('sanidadPendingCards');
    if (!wrap) return;

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const pending = (items || []).filter(r => {
      const estim = String(r.fecha_retiro || r.fecha_estimada || '').slice(0, 10);
      const eff = r.efectivo === true || r.effective === true;
      return estim && !eff;
    });

    if (!pending.length) {
      wrap.innerHTML = '<p class="muted">No hay tratamientos pendientes.</p>';
      return;
    }

    wrap.innerHTML = pending.map(r => {
      const id = r.id || r._id || `${r.device_id}-${r.fecha}-${r.producto}`;
      const col = escapeHtml(r.device_id || '');
      const prod = escapeHtml(r.producto || r.product || '');
      const inicio = String(r.fecha || r.fecha_aplicacion || '').slice(0, 10);
      const estim = String(r.fecha_retiro || r.fecha_estimada || '').slice(0, 10);

      let colorClass = 'san-card-ok';
      let statusText = 'En curso';
      if (estim) {
        const dEst = new Date(estim + 'T00:00:00');
        if (dEst < today) {
          colorClass = 'san-card-late';
          statusText = 'Vencido';
        }
      }

      return `
        <article class="san-card ${colorClass}" data-id="${escapeHtml(id)}">
          <header class="san-card-header">
            <h4>Colmena ${col || '‚Äî'}</h4>
            <span class="san-card-status">${statusText}</span>
          </header>
          <div class="san-card-body">
            <div class="san-card-product">${prod || '(sin producto)'}</div>
            <div class="san-card-dates">
              <div><span class="label">Inicio:</span> ${inicio || '‚Äî'}</div>
              <div><span class="label">Retiro estimado:</span> ${estim || '‚Äî'}</div>
            </div>
          </div>
          <footer class="san-card-footer">
            <label class="field-inline">
              <span>Fecha efectiva de retiro</span>
              <input type="date" class="san-card-ret-date">
            </label>
            <label class="field-inline check">
              <input type="checkbox" class="san-card-effective">
              <span>Tratamiento efectivo</span>
            </label>
            <button type="button" class="btn btn-small san-card-save">Guardar retiro</button>
          </footer>
        </article>`;
    }).join('');

    // Wiring de botones ‚ÄúGuardar retiro‚Äù
    wrap.querySelectorAll('.san-card-save').forEach(btn => {
      btn.addEventListener('click', async () => {
        const card = btn.closest('.san-card');
        if (!card) return;
        const id = card.dataset.id;
        const dateInput = card.querySelector('.san-card-ret-date');
        const cb = card.querySelector('.san-card-effective');
        const fechaReal = dateInput?.value || '';
        const eff = cb?.checked || false;

        if (!fechaReal || !eff) {
          alert('Seleccion√° la fecha efectiva y marc√° ‚ÄúTratamiento efectivo‚Äù.');
          return;
        }

        try {
          await healthUpdate(id, {
            fecha_retiro_efectiva: fechaReal,
            efectivo: true
          });
          await refreshSanidad();
        } catch (e) {
          alert('Error actualizando tratamiento: ' + (e.message || e));
        }
      });
    });
  }

  // Historial de tratamientos en tabla
  function renderSanidadHistorial(items) {
    const tb = $('sanidadTbody');
    if (!tb) return;

    if (!items || !items.length) {
      tb.innerHTML = '<tr><td colspan="6" class="muted">Sin registros</td></tr>';
      return;
    }

    tb.innerHTML = items.map(r => {
      const inicio = String(r.fecha || r.fecha_aplicacion || '').slice(0, 10);
      const col = escapeHtml(r.device_id || '');
      const prod = escapeHtml(r.producto || r.product || '');
      const est = String(r.fecha_retiro || r.fecha_estimada || '').slice(0, 10);
      const effDate = String(r.fecha_retiro_efectiva || r.fecha_efectiva || '').slice(0, 10);
      const eff = r.efectivo === true || r.effective === true ? 'S√≠' : 'No';

      return `<tr>
        <td>${inicio || '‚Äî'}</td>
        <td>${col || '‚Äî'}</td>
        <td>${prod || '‚Äî'}</td>
        <td>${est || '‚Äî'}</td>
        <td>${effDate || '‚Äî'}</td>
        <td>${eff}</td>
      </tr>`;
    }).join('');
  }

  // Refresco completo de pesta√±a Sanidad
  async function refreshSanidad() {
    try {
      const dev = $('sanidadFilterDevice')?.value || '';
      const df = $('sanidadFrom')?.value || '';
      const dt = $('sanidadTo')?.value || '';

      let fromISO, toISO;
      if (df) fromISO = new Date(df + 'T00:00:00').toISOString();
      if (dt) toISO = new Date(dt + 'T23:59:59.999').toISOString();

      const { items = [] } = await healthList({
        device_id: dev || undefined,
        fromISO,
        toISO
      });

      buildSanidadProductSuggestions(items);
      buildSanidadPendingCards(items);
      renderSanidadHistorial(items);
    } catch (e) {
      console.error(e);
    }
  }

  // Alta de tratamiento
  async function saveSanidad() {
    const dev = $('sanidadDevice')?.value || '';
    const fechaInicio = $('sanidadDate')?.value || '';
    const prod = $('sanidadProduct')?.value || '';
    const fechaEstim = $('sanidadEstimated')?.value || '';

    if (!dev || !fechaInicio || !prod || !fechaEstim) {
      alert('Complet√° colmena, fecha de inicio, producto y fecha estimada de retiro.');
      return;
    }

    try {
      await healthInsert({
        device_id: dev,
        fecha: fechaInicio,
        producto: prod,
        fecha_retiro: fechaEstim,
        efectivo: false
      });

      $('sanidadProduct').value = '';
      $('sanidadEstimated').value = '';
      await refreshSanidad();
    } catch (e) {
      alert('Error guardando tratamiento: ' + (e.message || e));
    }
  }

  // ================= BARROA =================

  function varroaColorClass(pct) {
    const v = Number(pct);
    if (!(v >= 0)) return 'varroa-green';
    if (v <= 1) return 'varroa-green';
    if (v <= 2) return 'varroa-yellow';
    if (v <= 3) return 'varroa-orange';
    if (v <= 5) return 'varroa-red';
    return 'varroa-red-strong';
  }

  function varroaNeedsWarning(pct) {
    const v = Number(pct);
    return v > 2; // naranja / rojo / rojo fuerte
  }

  function renderVarroaTable(items) {
    const tb = $('varroaTbody');
    if (!tb) return;

    if (!items || !items.length) {
      tb.innerHTML = '<tr><td colspan="3" class="muted">Sin conteos registrados.</td></tr>';
      return;
    }

    tb.innerHTML = items.map(r => {
      const fecha = String(r.fecha || '').slice(0, 10);
      const col = escapeHtml(r.device_id || '');
      const p = Number(r.porcentaje || r.porcentaje_barroa || 0);
      const cls = varroaColorClass(p);
      const warn = varroaNeedsWarning(p);

      return `<tr>
        <td>${fecha || '‚Äî'}</td>
        <td>${col || '‚Äî'}</td>
        <td>
          <span class="varroa-pill ${cls}">${p.toFixed(1)}%</span>
          ${warn ? '<span class="varroa-warning" title="Requieren tratamiento">‚ö†Ô∏è</span>' : ''}
        </td>
      </tr>`;
    }).join('');
  }

  async function refreshVarroa() {
    try {
      const dev = $('varroaDeviceFilter')?.value || '';
      const df = $('varroaFrom')?.value || '';
      const dt = $('varroaTo')?.value || '';

      let fromISO, toISO;
      if (df) fromISO = new Date(df + 'T00:00:00').toISOString();
      if (dt) toISO = new Date(dt + 'T23:59:59.999').toISOString();

      const { items = [] } = await varroaList({
        device_id: dev || undefined,
        fromISO,
        toISO
      });

      renderVarroaTable(items);
    } catch (e) {
      console.error(e);
    }
  }

  async function saveVarroa() {
    const dev = $('varroaDevice')?.value || '';
    const fecha = $('varroaDate')?.value || '';
    const pct = Number($('varroaPct')?.value || 0);

    if (!dev || !fecha || !(pct >= 0)) {
      alert('Complet√° colmena, fecha y porcentaje de barroa.');
      return;
    }

    try {
      await varroaInsert({
        device_id: dev,
        fecha,
        porcentaje: pct
      });
      $('varroaPct').value = '';
      await refreshVarroa();
    } catch (e) {
      alert('Error guardando conteo de barroa: ' + (e.message || e));
    }
  }
  /* =========================================================
   *  CALENDARIO: LISTADO + ALTA
   * =======================================================*/
  function groupEventsByDay(items) {
    const map = {};
    for (const r of items || []) {
      const f = String(r.fecha || '').slice(0, 10);
      if (!f) continue;
      if (!map[f]) map[f] = [];
      map[f].push(r);
    }
    const days = Object.keys(map).sort();
    return days.map(d => ({ date: d, events: map[d] }));
  }

  async function refreshCalendario() {
    try {
      const dev = $('calDeviceFilter')?.value || '';
      const month = $('calMonth')?.value || '';
      let fromISO, toISO;

      if (month) {
        const [y, m] = month.split('-').map(n => Number(n));
        if (y && m) {
          const from = new Date(y, m - 1, 1, 0, 0, 0, 0);
          const to = new Date(y, m, 0, 23, 59, 59, 999);
          fromISO = from.toISOString();
          toISO = to.toISOString();
        }
      }

      const { items = [] } = await eventsList({
        device_id: dev || undefined,
        fromISO,
        toISO
      });

      const grouped = groupEventsByDay(items);
      const wrap = $('calList');
      if (!wrap) return;

      if (!grouped.length) {
        wrap.innerHTML = '<div class="muted">Sin eventos en el per√≠odo seleccionado.</div>';
        return;
      }

      wrap.innerHTML = grouped.map(day => {
        const eventosHtml = day.events.map(ev => {
          const colId = String(ev.device_id || '');
          const color = getDeviceColor(colId);
          const title = escapeHtml(ev.titulo || ev.title || '');
          const tipo = escapeHtml(ev.tipo || ev.type || '');
          const notes = escapeHtml(ev.notas || ev.notes || '');
          return `
            <div class="calendar-event">
              <div class="calendar-event-main">
                <div class="calendar-event-title" style="color:${color}">
                  ${title || '(sin t√≠tulo)'}
                </div>
                <div class="calendar-event-meta">
                  ${colId ? `Colmena ${colId} ¬∑ ` : ''}${tipo || 'Evento'}
                </div>
                ${notes ? `<div class="calendar-event-meta">${notes}</div>` : ''}
              </div>
            </div>`;
        }).join('');
        return `
          <div class="calendar-list-day">
            <h4>${escapeHtml(day.date)}</h4>
            ${eventosHtml}
          </div>`;
      }).join('');
    } catch (e) {
      console.error(e);
    }
  
    // Vista grande
    try{
      // autoEvents (sanidad) + userEvents (manual)
      const autoEvents = await buildAutoSanidadEvents();
      const userEvents = await eventsList();
      window.__calMergedEvents = mergeCalendarioEvents(autoEvents, userEvents);
      renderBigCalendar();
    }catch(e){
      // no rompe
      console.warn('Calendario grande:', e);
      window.__calMergedEvents = [];
      renderBigCalendar();
    }
  }


  async function saveCalendario() {
    const dev = $('calDevice')?.value || '';
    const fecha = $('calDate')?.value || '';
    const titulo = $('calTitle')?.value || '';
    const tipo = $('calType')?.value || '';
    const notas = $('calNotes')?.value || '';

    if (!fecha || !titulo) {
      alert('Complet√° al menos fecha y t√≠tulo del evento.');
      return;
    }

    try {
      await eventsInsert({
        device_id: dev || null,
        fecha,
        titulo,
        tipo,
        notas
      });
      $('calNotes').value = '';
      refreshCalendario();
    } catch (e) {
      alert('Error guardando evento: ' + (e.message || e));
    }
  }

  
  /* =========================================================
   *  CALENDARIO - Vista grande mensual (sin romper lo existente)
   * =======================================================*/
  let calSelectedDate = null;
  let calEditingId = null;

  function isoDate(d){
    const x = new Date(d);
    const y = x.getFullYear();
    const m = String(x.getMonth()+1).padStart(2,'0');
    const day = String(x.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
  function monthKeyFromInput(){
    const v = $('calMonth')?.value;
    if (v) return v;
    const now = new Date();
    return `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  }
  function setMonthInput(ym){
    if ($('calMonth')) $('calMonth').value = ym;
  }
  function addMonths(ym, delta){
    const [y,m]=ym.split('-').map(n=>parseInt(n,10));
    const d=new Date(y, m-1, 1);
    d.setMonth(d.getMonth()+delta);
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  }

  function calColorForEvent(ev){
    return getDeviceColor(ev.device_id || '');
  }

  function calPickDate(d){
    calSelectedDate = d;
    if ($('calSideDate')) $('calSideDate').textContent = new Date(d+'T00:00:00').toLocaleDateString('es-AR', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
    renderCalDayList();
  }

  function renderCalDayList(){
    const wrap = $('calDayList');
    if (!wrap) return;
    const day = calSelectedDate || isoDate(new Date());
    const devFilter = $('calDeviceFilter')?.value || '';
    const all = (window.__calMergedEvents || []).filter(ev => ev.fecha === day && (!devFilter || String(ev.device_id||'')===String(devFilter)));
    if (!all.length){
      wrap.innerHTML = '<div class="muted">Sin eventos para este d√≠a.</div>';
      return;
    }
    wrap.innerHTML = all
      .sort((a,b)=>String(a.titulo||'').localeCompare(String(b.titulo||'')))
      .map(ev=>{
        const c = calColorForEvent(ev);
        const t = escapeHtml(ev.titulo||'(sin t√≠tulo)');
        const tipo = escapeHtml(ev.tipo||'Evento');
        const col = ev.device_id ? `Colmena ${escapeHtml(String(ev.device_id))}` : 'Sin colmena';
        return `
          <div class="day-item" data-eid="${escapeHtml(String(ev.id||''))}">
            <div class="day-dot" style="background:${c}"></div>
            <div style="min-width:0">
              <div class="t">${t}</div>
              <div class="m">${col} ¬∑ ${tipo}</div>
            </div>
          </div>`;
      }).join('');
    wrap.querySelectorAll('.day-item').forEach(el=>{
      el.addEventListener('click', ()=>{
        const id = el.getAttribute('data-eid');
        const ev = (window.__calMergedEvents || []).find(x=>String(x.id||'')===String(id));
        if (ev) openCalEditor(ev);
      });
    });
  }

  function openCalEditor(ev){
    calEditingId = ev?.id || null;
    if ($('calDevice')) $('calDevice').value = ev?.device_id ? String(ev.device_id) : '';
    if ($('calDate')) $('calDate').value = ev?.fecha || (calSelectedDate || isoDate(new Date()));
    if ($('calTitle')) $('calTitle').value = ev?.titulo || '';
    if ($('calType')) $('calType').value = ev?.tipo || 'otro';
    if ($('calNotes')) $('calNotes').value = ev?.notas || '';
    if ($('btnCalDelete')) $('btnCalDelete').style.display = ev?.user_created ? 'inline-flex' : 'none';
    if ($('calEditor')) $('calEditor').scrollIntoView({ behavior:'smooth', block:'start' });
  }

  function clearCalEditor(){
    calEditingId = null;
    if ($('calDevice')) $('calDevice').value = '';
    if ($('calDate')) $('calDate').value = calSelectedDate || isoDate(new Date());
    if ($('calTitle')) $('calTitle').value = '';
    if ($('calType')) $('calType').value = 'sanidad';
    if ($('calNotes')) $('calNotes').value = '';
    if ($('btnCalDelete')) $('btnCalDelete').style.display = 'none';
  }

  function mergeCalendarioEvents(autoEvents, userEvents){
    // autoEvents: from sanitary, read-only; userEvents: editable
    const res = [];
    for (const e of (autoEvents||[])){
      res.push({ ...e, user_created:false });
    }
    for (const e of (userEvents||[])){
      res.push({ ...e, user_created:true });
    }
    // normalize id
    res.forEach((e,i)=>{
      if (!e.id) e.id = (e.user_created?'U':'A') + '_' + i + '_' + (e.fecha||'');
    });
    return res;
  }

  async function buildAutoSanidadEvents(){
    // Construye eventos autom√°ticos basados en registros sanitarios (retiro estimado) y controles.
    // Si la API no devuelve nada, simplemente devuelve [].
    const res = [];
    try{
      const list = await healthList(); // tu endpoint actual de sanidad
      for (const r of (list||[])){
        const fecha = (r.fecha_estimada_retiro || r.estimated_withdrawal || r.retiro || r.fecha || '').slice(0,10);
        if (!fecha) continue;
        const dev = r.device_id || r.colmena_id || r.colmena || null;
        const prod = r.producto || r.product || r.product_name || 'Manejo sanitario';
        const titulo = `Retiro estimado: ${prod}`;
        res.push({
          id: 'AUTO_RETIRO_' + (r.id||Math.random().toString(36).slice(2)),
          device_id: dev,
          fecha,
          titulo,
          tipo: 'sanidad',
          notas: r.notas || r.notes || ''
        });
      }
    }catch(e){
      // ignore
    }
    try{
      const vlist = await varroaList();
      for (const r of (vlist||[])){
        const fecha = (r.fecha || r.date || '').slice(0,10);
        if (!fecha) continue;
        const dev = r.device_id || null;
        const p = Number(r.porcentaje || r.porcentaje_barroa || 0);
        const titulo = `Control varroa: ${p.toFixed(1)}%`;
        res.push({
          id: 'AUTO_VARROA_' + (r.id||Math.random().toString(36).slice(2)),
          device_id: dev,
          fecha,
          titulo,
          tipo: 'revisi√≥n',
          notas: ''
        });
      }
    }catch(e){
      // ignore
    }
    return res;
  }


  function buildCalendarMonthGrid(ym){
    const [Y,M]=ym.split('-').map(n=>parseInt(n,10));
    const first = new Date(Y, M-1, 1);
    // JS: 0=Dom ... 6=S√°b. Queremos lun=0
    const dow = (first.getDay()+6)%7;
    const start = new Date(first);
    start.setDate(first.getDate() - dow);
    const cells = [];
    for (let i=0;i<42;i++){
      const d = new Date(start);
      d.setDate(start.getDate()+i);
      cells.push(d);
    }
    return cells;
  }

  function renderBigCalendar(){
    const grid = $('calBig');
    if (!grid) return;

    const ym = monthKeyFromInput();
    const cells = buildCalendarMonthGrid(ym);
    const [Y,M]=ym.split('-').map(n=>parseInt(n,10));

    const events = window.__calMergedEvents || [];
    const map = {};
    for (const ev of events){
      if (!ev.fecha) continue;
      if (!map[ev.fecha]) map[ev.fecha]=[];
      map[ev.fecha].push(ev);
    }

    grid.innerHTML = cells.map(d=>{
      const dayIso = isoDate(d);
      const inMonth = (d.getFullYear()===Y && (d.getMonth()+1)===M);
      const evs = (map[dayIso]||[]).slice(0,3);
      const badges = evs.map(ev=>{
        const c = calColorForEvent(ev);
        const t = escapeHtml(ev.titulo||'');
        return `<div class="cal-badge" style="border-color:${c};color:${c}">${t||'(evento)'}</div>`;
      }).join('');
      const more = (map[dayIso]||[]).length - evs.length;
      const moreBadge = more>0 ? `<div class="cal-badge muted">+${more} m√°s</div>` : '';
      return `
        <div class="cal-day ${inMonth?'':'muted'}" data-day="${dayIso}">
          <div class="cal-day-head">
            <span>${d.getDate()}</span>
            <span style="width:10px;height:10px;border-radius:50%;background:${(map[dayIso]||[]).length?getDeviceColor((map[dayIso]||[])[0]?.device_id||''):'transparent'}"></span>
          </div>
          <div class="cal-badges">${badges}${moreBadge}</div>
        </div>`;
    }).join('');

    grid.querySelectorAll('.cal-day').forEach(el=>{
      el.addEventListener('click', ()=>{
        const day = el.getAttribute('data-day');
        calPickDate(day);
        clearCalEditor();
        if ($('calDate')) $('calDate').value = day;
      });
    });

    // default selection
    const today = isoDate(new Date());
    const defaultDay = (today.startsWith(ym) ? today : `${ym}-01`);
    if (!calSelectedDate || !String(calSelectedDate).startsWith(ym)) {
      calPickDate(defaultDay);
      if ($('calDate')) $('calDate').value = defaultDay;
    } else {
      renderCalDayList();
    }
  }

  // UI NAV
  function hookCalendarUI(){
    if ($('btnCalPrev')) $('btnCalPrev').addEventListener('click', ()=>{
      const ym = addMonths(monthKeyFromInput(), -1);
      setMonthInput(ym);
      refreshCalendario();
    });
    if ($('btnCalNext')) $('btnCalNext').addEventListener('click', ()=>{
      const ym = addMonths(monthKeyFromInput(), 1);
      setMonthInput(ym);
      refreshCalendario();
    });
    if ($('btnCalNew')) $('btnCalNew').addEventListener('click', ()=>{
      clearCalEditor();
      if ($('calDate')) $('calDate').value = calSelectedDate || isoDate(new Date());
      if ($('calTitle')) $('calTitle').focus();
    });
    if ($('btnCalCancel')) $('btnCalCancel').addEventListener('click', ()=>{
      clearCalEditor();
    });
    if ($('btnCalDelete')) $('btnCalDelete').addEventListener('click', async ()=>{
      if (!calEditingId) return;
      if (!confirm('Eliminar este evento?')) return;
      try{
        await eventsDelete(calEditingId);
        clearCalEditor();
        refreshCalendario();
      }catch(e){
        alert('Error eliminando: ' + (e.message||e));
      }
    });
    // Google Calendar stub
    if ($('btnGCalConnect')) $('btnGCalConnect').addEventListener('click', ()=>{
      $('gcalStatus').textContent = 'Conexi√≥n pendiente (requiere backend OAuth2).';
      alert('Para Google Calendar hace falta un backend OAuth2. Esta UI ya queda lista para conectarlo.');
    });
    if ($('btnGCalSync')) $('btnGCalSync').addEventListener('click', ()=>{
      $('gcalStatus').textContent = 'Sync pendiente (requiere backend).';
      alert('Sync con Google Calendar: pendiente de backend.');
    });
  }

/* =========================================================
   *  NOTAS: LISTADO + ALTA
   * =======================================================*/
  async function refreshNotas() {
    try {
      const dev = $('notesDeviceFilter')?.value || '';
      const { items = [] } = await notesList({ device_id: dev || undefined });
      const wrap = $('notesList');
      if (!wrap) return;

      if (!items.length) {
        wrap.innerHTML = '<div class="muted">Sin anotaciones.</div>';
        return;
      }

      wrap.innerHTML = items
        .sort((a, b) =>
          new Date(b.created_at || b.fecha || 0) -
          new Date(a.created_at || a.fecha || 0)
        )
        .map(n => {
          const col = escapeHtml(n.device_id || '');
          const text = escapeHtml(n.texto || n.text || '');
          const ts = n.created_at || n.fecha || '';
          const d = ts ? new Date(ts) : null;
          const fecha = d ? d.toLocaleString('es-AR') : '';
          return `
            <div class="note-item">
              <div class="note-item-head">
                <div class="note-item-meta">
                  ${col ? `Colmena ${col}` : 'General'}
                </div>
                <div class="note-item-meta">${escapeHtml(fecha)}</div>
              </div>
              <div>${text}</div>
            </div>`;
        }).join('');
    } catch (e) {
      console.error(e);
    }
  }

  async function saveNota() {
    const dev = $('noteDevice')?.value || '';
    const text = $('noteText')?.value || '';
    if (!dev || !text.trim()) {
      alert('Seleccion√° una colmena y escrib√≠ la anotaci√≥n.');
      return;
    }
    try {
      await notesInsert({ device_id: dev, texto: text });
      $('noteText').value = '';
      refreshNotas();
    } catch (e) {
      alert('Error guardando anotaci√≥n: ' + (e.message || e));
    }
  }

  /* =========================================================
   *  TOGGLE TABLA LECTURAS CRUDAS
   * =======================================================*/
  $('toggleTbl').onclick = () => {
    const w = $('tableWrap');
    w.style.display = w.style.display === 'none' ? 'block' : 'none';
  };

  /* =========================================================
   *  POLLING PRINCIPAL: CADA 15s
   * =======================================================*/
  let polling = false;

  async function loadDatapoints() {
    if (polling) return;
    polling = true;
    try {
      const { items } = await callWorker('/datapoints?limit=200');
      lastItemsCache = items;
      renderTable(items);
      updateLastReading(items);
      updateMotherKPIs(items);
      renderDeviceCards(items);
      if (chartsVisible && !historyMode) renderChartsDaily(items);

      if (currentOverlayDevice) {
        updateOverlayKPIs(lastItemsCache, currentOverlayDevice);
        if (ovChartsVisible) {
          renderOverlayChartsDaily(lastItemsCache, currentOverlayDevice);
        }
        renderWorkSection(lastItemsCache, currentOverlayDevice);
      }
    } finally {
      polling = false;
    }
  }

  setInterval(() => {
    if (auth.currentUser) {
      loadDatapoints().catch(() => { });
    }
  }, 15000);

    /* =========================================================
   *  BLOQUE: ‚ÄúTRABAJO‚Äù (modo avanzado por colmena) ‚Äî v2
   *  - MS: suma (hoy / semana / mes)
   *  - C2R/NHR/NXR/ALR/SMR: promedios (d√≠a/semana/mes/rango)
   *  - Gr√°fico siempre visible, default: MES
   * =======================================================*/
  let workChart = null;

  const WORK_VAR_KEYS = ['C2R', 'NHR', 'NXR', 'ALR', 'SMR'];
  const WORK_ALL_KEYS = [...WORK_VAR_KEYS, 'MS', 'OPN'];

  const WORK_PALETTE = {
    C2R: '#ffb74d',
    NHR: '#4da3ff',
    NXR: '#ff6b6b',
    ALR: '#7fb3ff',
    SMR: '#49d17d'
  };

  function normalizeWorkKey(raw) {
    const K = String(raw || '').toUpperCase().trim();
    for (const base of WORK_ALL_KEYS) {
      if (K === base) return base;
      const re = new RegExp(`(^|[.\\-_:])${base}($|[.\\-_:])`);
      if (re.test(K)) return base;
    }
    return null;
  }

  function workIsVisible() {
    const c = $('workCard');
    return c && getComputedStyle(c).display !== 'none';
  }

  function fmtWork(v, dec = 1) {
    if (v == null || Number.isNaN(+v)) return '‚Äî';
    return Number(v).toFixed(dec);
  }

  function formatHM_fromMs(ms) {
    const totalMin = Math.round((Number(ms) || 0) / 60000);
    const h = Math.floor(totalMin / 60);
    const m = totalMin % 60;
    return h > 0 ? `${h}h ${m}m` : `${m}m`;
  }

  // Cache simple por rango (evita martillar el Worker si el usuario deja el panel abierto)
  const workRangeCache = new Map(); // key => { fetchedAt, items }
  function workTTL(period) {
    if (period === 'dia') return 15000;
    if (period === 'semana') return 30000;
    return 60000; // mes / rango
  }

  const WORK_FETCH_LIMIT = 12000;
  const WORK_SPLIT_DEPTH_MAX = 8;

  function mergeWorkItems(a, b) {
    const seen = new Set();
    const out = [];
    for (const d of [...(a || []), ...(b || [])]) {
      const key = `${d.ts}|${d.device_id}|${d.sensor_key}|${d.value}`;
      if (seen.has(key)) continue;
      seen.add(key);
      out.push(d);
    }
    return out;
  }

  async function workFetchChunk(fromT, toT, deviceId, period, depth) {
    const fromISO = new Date(fromT).toISOString();
    const toISO = new Date(toT).toISOString();

    const keysParam = WORK_ALL_KEYS.join(',');
    const q = `/datapoints?from=${encodeURIComponent(fromISO)}&to=${encodeURIComponent(toISO)}&limit=${WORK_FETCH_LIMIT}&device_id=${encodeURIComponent(deviceId)}&keys=${encodeURIComponent(keysParam)}`;
    const { items } = await callWorker(q);

    const filtered = (items || []).filter(d => {
      if (String(d.device_id) !== String(deviceId)) return false;
      return !!normalizeWorkKey(d.sensor_key);
    });

    // Si el backend devuelve "limit" clavado, puede estar recortando por volumen.
    // Solo hacemos split si parece que viene ‚Äúruido‚Äù (muchos √≠tems pero pocos del device/keys que nos interesan).
    const hitLimit = (items || []).length >= WORK_FETCH_LIMIT;
    const noiseRatio = hitLimit ? (filtered.length / Math.max(1, (items || []).length)) : 1;
    if (hitLimit && noiseRatio < 0.10 && depth < WORK_SPLIT_DEPTH_MAX && (toT - fromT) > 15 * 60 * 1000) {
      const mid = Math.floor((fromT + toT) / 2);
      const left = await workFetchChunk(fromT, mid, deviceId, period, depth + 1);
      const right = await workFetchChunk(mid + 1, toT, deviceId, period, depth + 1);
      return mergeWorkItems(left, right);
    }

    return filtered;
  }

  async function workFetchRange(fromISO, toISO, deviceId, period = 'mes') {
    const key = `${deviceId}|${fromISO}|${toISO}`;
    const now = Date.now();
    const cached = workRangeCache.get(key);
    const ttl = workTTL(period);

    if (cached && (now - cached.fetchedAt) < ttl) return cached.items;

    try {
      const fromT = Date.parse(fromISO);
      const toT = Date.parse(toISO);
      const filtered = await workFetchChunk(fromT, toT, deviceId, period, 0);
      workRangeCache.set(key, { fetchedAt: now, items: filtered });
      return filtered;
    } catch (e) {
      const filtered = (lastItemsCache || []).filter(d => {
        if (String(d.device_id) !== String(deviceId)) return false;
        return !!normalizeWorkKey(d.sensor_key);
      });
      workRangeCache.set(key, { fetchedAt: now, items: filtered });
      return filtered;
    }
  }

  async function getWorkDataFor(period, deviceId) {
    const { fromISO, toISO } = periodBounds(period);
    return await workFetchRange(fromISO, toISO, deviceId, period);
  }

  function sumMs(items) {
    let acc = 0;
    for (const d of (items || [])) {
      if (normalizeWorkKey(d.sensor_key) !== 'MS') continue;
      acc += (Number(d.value) || 0);
    }
    return acc;
  }

  function dayKeyLocal(ts) {
    const d = new Date(ts);
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const da = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${da}`;
  }

  function buildWorkSeries(items, deviceId, fromT, toT, period = 'mes') {
    const bucket = new Map();
    const labelsSet = new Set();
    const isDia = (period === 'dia');

    for (const d of (items || [])) {
      if (String(d.device_id) !== String(deviceId)) continue;

      const base = normalizeWorkKey(d.sensor_key);
      if (!WORK_VAR_KEYS.includes(base)) continue;

      const t = new Date(d.ts).getTime();
      if (t < fromT || t > toT) continue;

      const bKey = isDia
        ? Math.floor(t / 60000) * 60000
        : dayKeyLocal(t);

      labelsSet.add(bKey);

      if (!bucket.has(bKey)) {
        bucket.set(bKey, Object.fromEntries(WORK_VAR_KEYS.map(k => [k, { sum: 0, cnt: 0 }])));
      }
      const cell = bucket.get(bKey)[base];
      cell.sum += (Number(d.value) || 0);
      cell.cnt += 1;
    }

    const labelsSorted = Array.from(labelsSet).sort((a, b) => (a > b ? 1 : -1));

    const labels = labelsSorted.map(x => {
      if (isDia) {
        return new Date(Number(x)).toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
      }
      const dt = new Date(String(x) + 'T00:00:00');
      return dt.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit' });
    });

    const datasets = WORK_VAR_KEYS.map(k => ({
      label: k,
      data: labelsSorted.map(bKey => {
        const row = bucket.get(bKey);
        if (!row) return null;
        const { sum, cnt } = row[k];
        return cnt ? (sum / cnt) : null;
      }),
      borderColor: WORK_PALETTE[k] || '#ccc',
      backgroundColor: 'transparent',
      borderWidth: 2,
      tension: .25,
      pointRadius: 0,
      spanGaps: true
    }));

    const avg = Object.fromEntries(WORK_VAR_KEYS.map(k => [k, { sum: 0, cnt: 0 }]));
    for (const d of (items || [])) {
      if (String(d.device_id) !== String(deviceId)) continue;
      const base = normalizeWorkKey(d.sensor_key);
      if (!WORK_VAR_KEYS.includes(base)) continue;
      const t = new Date(d.ts).getTime();
      if (t < fromT || t > toT) continue;
      avg[base].sum += (Number(d.value) || 0);
      avg[base].cnt += 1;
    }
    const avgOut = {};
    for (const k of WORK_VAR_KEYS) {
      avgOut[k] = avg[k].cnt ? (avg[k].sum / avg[k].cnt) : null;
    }

    return { labels, datasets, avgOut };
  }

  function setWorkAvgPanel(avgOut) {
    setText('workAvgC2R', fmtWork(avgOut?.C2R));
    setText('workAvgNHR', fmtWork(avgOut?.NHR));
    setText('workAvgNXR', fmtWork(avgOut?.NXR));
    setText('workAvgALR', fmtWork(avgOut?.ALR));
    setText('workAvgSMR', fmtWork(avgOut?.SMR));
  }

  function setWorkChartTitle(period, extra = '') {
    const t = (period === 'dia') ? 'Trabajo del d√≠a'
      : (period === 'semana') ? 'Trabajo semanal'
        : (period === 'mes') ? 'Trabajo mensual'
          : 'Trabajo';
    setText('workChartTitle', `${t} ‚Äî Variables (ppm)${extra ? ' ‚Äî ' + extra : ''}`);
  }

  function renderWorkCharts(items, deviceId, fromT, toT, period = 'mes', titleExtra = '') {
    if (!items || !deviceId) return;

    const { labels, datasets, avgOut } = buildWorkSeries(items, deviceId, fromT, toT, period);
    setWorkAvgPanel(avgOut);
    setWorkChartTitle(period, titleExtra);

    if (workChart) workChart.destroy();
    const ctx = $('workChart').getContext('2d');
    workChart = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: true } },
        interaction: { mode: 'nearest', intersect: false },
        scales: {
          x: { title: { display: true, text: (period === 'dia') ? 'Hora' : 'D√≠a' } },
          y: { beginAtZero: true, title: { display: true, text: 'ppm' } }
        }
      }
    });
  }

  const workTotalsCache = new Map();

  async function refreshWorkTotals(deviceId, force = false) {
    const now = Date.now();
    const cached = workTotalsCache.get(String(deviceId));
    if (!force && cached && (now - cached.fetchedAt) < 30000) {
      setText('workToday', `Trabajo de hoy: ${formatHM_fromMs(cached.todayMs)}`);
      setText('workWeek', `Trabajo de la semana: ${formatHM_fromMs(cached.weekMs)}`);
      setText('workMonth', `Trabajo del mes: ${formatHM_fromMs(cached.monthMs)}`);
      return cached;
    }

    const dayItems = await getWorkDataFor('dia', deviceId);
    const weekItems = await getWorkDataFor('semana', deviceId);
    const monthItems = await getWorkDataFor('mes', deviceId);

    const res = {
      fetchedAt: now,
      todayMs: sumMs(dayItems),
      weekMs: sumMs(weekItems),
      monthMs: sumMs(monthItems),
    };

    workTotalsCache.set(String(deviceId), res);
    setText('workToday', `Trabajo de hoy: ${formatHM_fromMs(res.todayMs)}`);
    setText('workWeek', `Trabajo de la semana: ${formatHM_fromMs(res.weekMs)}`);
    setText('workMonth', `Trabajo del mes: ${formatHM_fromMs(res.monthMs)}`);
    return res;
  }

  async function renderWorkSection(items, deviceId) {
    if (!deviceId || !workIsVisible()) return;
    await refreshWorkUI(deviceId, { force: false }).catch(() => { });
  }

  async function refreshWorkUI(deviceId, opts = {}) {
    const period = opts.period || ($('workRange')?.value || 'mes');
    const { fromT, toT, fromISO, toISO } = periodBounds(period);

    await refreshWorkTotals(deviceId, !!opts.force);

    const data = await workFetchRange(fromISO, toISO, deviceId, period);
    renderWorkCharts(data, deviceId, fromT, toT, period);
  }

  async function downloadWorkCSVFor(deviceId, fromISO, toISO, filenameSuffix) {
    const data = await workFetchRange(fromISO, toISO, deviceId, 'rango');
    const rows = [['timestamp_iso', 'fecha_local', 'hora_local', 'device_id', 'sensor', 'sensor_base', 'valor']];

    for (const d of (data || [])) {
      const base = normalizeWorkKey(d.sensor_key) || '';
      const ts = new Date(d.ts);
      rows.push([
        ts.toISOString(),
        ts.toLocaleDateString('es-AR'),
        ts.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit', second: '2-digit' }),
        d.device_id,
        d.sensor_key,
        base,
        d.value == null ? '' : String(d.value),
      ]);
    }

    if (rows.length <= 1) {
      alert('Sin datos de trabajo');
      return;
    }

    const csv = rows.map(r => r.map(cell =>
      /[,;\n"]/.test(String(cell))
        ? `"${String(cell).replace(/"/g, '""')}"`
        : String(cell)
    ).join(',')).join('\n');

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filenameSuffix ? `trabajo_${deviceId}_${filenameSuffix}.csv` : `trabajo_${deviceId}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }

  $('workRange').onchange = async () => {
    if (!currentOverlayDevice) return;
    await refreshWorkUI(currentOverlayDevice, { force: true }).catch(() => { });
  };

  $('btnWorkCSV').onclick = async () => {
    if (!currentOverlayDevice) return;
    const period = $('workRange')?.value || 'mes';
    const b = periodBounds(period);
    const suffix = `${period}_${ymd(new Date(b.fromT))}_a_${ymd(new Date(b.toT))}`;
    await downloadWorkCSVFor(currentOverlayDevice, b.fromISO, b.toISO, suffix);
  };

  $('btnWorkHistToggle').onclick = () => {
    const c = $('workHistControls');
    const show = c.style.display === 'none';
    c.style.display = show ? 'flex' : 'none';
    $('btnWorkHistToggle').textContent = show ? 'Ocultar historial' : 'Historial';
    if (show) {
      const t = ymd(new Date());
      $('workDateFrom').value = t;
      $('workDateTo').value = t;
    }
  };

  $('btnWorkHistShow').onclick = async () => {
    const df = $('workDateFrom').value;
    const dt = $('workDateTo').value;
    if (!df || !dt || !currentOverlayDevice) return;

    const fromISO = new Date(df + 'T00:00:00').toISOString();
    const toISO = new Date(dt + 'T23:59:59.999').toISOString();
    const fromT = new Date(df + 'T00:00:00').getTime();
    const toT = new Date(dt + 'T23:59:59.999').getTime();

    const items = await workFetchRange(fromISO, toISO, currentOverlayDevice, 'rango');
    renderWorkCharts(items, currentOverlayDevice, fromT, toT, 'rango', `${df} a ${dt}`);
  };

  $('btnWorkHistCSV').onclick = async () => {
    const df = $('workDateFrom').value;
    const dt = $('workDateTo').value;
    if (!df || !dt || !currentOverlayDevice) return;
    const fromISO = new Date(df + 'T00:00:00').toISOString();
    const toISO = new Date(dt + 'T23:59:59.999').toISOString();
    await downloadWorkCSVFor(currentOverlayDevice, fromISO, toISO, `${df}_a_${dt}`);
  };

  
  

  /* =========================================================
   *  CLIMA: ESTADO + BOTONES
   * =======================================================*/
  const wxMap = {
    0: 'Despejado',
    1: 'Mayormente despejado',
    2: 'Parcialmente nublado',
    3: 'Nublado',
    45: 'Niebla',
    48: 'Niebla escarchada',
    51: 'Llovizna',
    61: 'Lluvia',
    71: 'Nieve',
    80: 'Chubascos'
  };

  function wxEmoji(code) {
    if ([0].includes(code)) return '‚òÄÔ∏è';
    if ([1, 2].includes(code)) return 'üå§Ô∏è';
    if ([3].includes(code)) return '‚òÅÔ∏è';
    if ([45, 48].includes(code)) return 'üå´Ô∏è';
    if ([51, 53, 55].includes(code)) return 'üå¶Ô∏è';
    if ([61, 63, 65, 80, 81, 82].includes(code)) return 'üåßÔ∏è';
    if ([71, 73, 75].includes(code)) return '‚ùÑÔ∏è';
    return '‚õÖ';
  }

  // Estado interno del m√≥dulo de clima
  let wxWeekChart = null;
  let wxDailyCache = null;   // { daily, current, label, lat, lon }
  let wxSelectedIdx = 0;

  function wxHideResults() {
    const box = $('wxResults');
    if (box) { box.style.display = 'none'; box.innerHTML = ''; }
  }

  function wxShowResults(results) {
    const box = $('wxResults');
    if (!box) return;
    if (!results || !results.length) { wxHideResults(); return; }
    box.innerHTML = results.map((g, i) => {
      const parts = [g.name, g.admin1, g.country].filter(Boolean);
      const label = parts.join(', ');
      const sub = [g.admin2, g.admin3].filter(Boolean).join(' ¬∑ ');
      return `<button type="button" data-i="${i}">
        <div style="font-weight:800">${label}</div>
        <div class="muted" style="font-size:.88rem">${sub || `Lat ${g.latitude.toFixed(2)}, Lon ${g.longitude.toFixed(2)}`}</div>
      </button>`;
    }).join('');
    box.style.display = 'block';
    box.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('click', async () => {
        const i = Number(btn.dataset.i || 0);
        const g = results[i];
        const parts = [g.name, g.admin1, g.country].filter(Boolean);
        const label = parts.join(', ');
        wxHideResults();
        await renderWeather(g.latitude, g.longitude, label);
        saveWxPlace({ lat: g.latitude, lon: g.longitude, label });
        setWxButtonsState('fixed');
      });
    });
  }

  function wxFmtDayLabel(isoDate) {
    const dt = new Date(String(isoDate) + 'T00:00:00');
    return dt.toLocaleDateString('es-AR', { weekday: 'short', day: '2-digit' });
  }

  function wxPickDay(idx) {
    if (!wxDailyCache?.daily?.time?.length) return;
    const n = wxDailyCache.daily.time.length;
    const i = Math.max(0, Math.min(n - 1, Number(idx || 0)));
    wxSelectedIdx = i;

    // Tile UI
    document.querySelectorAll('#wxTiles .wx-tile').forEach((el) => {
      el.classList.toggle('selected', Number(el.dataset.idx) === i);
    });

    const d = wxDailyCache.daily;
    const code = d.weather_code?.[i];
    const tmax = d.temperature_2m_max?.[i];
    const tmin = d.temperature_2m_min?.[i];
    const hmax = d.relative_humidity_2m_max?.[i];
    const hmin = d.relative_humidity_2m_min?.[i];
    const pr = d.precipitation_sum?.[i] ?? 0;
    const pp = d.precipitation_probability_max?.[i];


    const dayLabel = wxFmtDayLabel(d.time[i]);
    const title = `${dayLabel} ¬∑ ${wxEmoji(code)} ${wxMap[code] || '‚Äî'}`;

    // Arriba: "actual" por defecto; si elige otro d√≠a, mostramos resumen
    if (i === 0 && wxDailyCache.current) {
      const c = wxDailyCache.current;
      setText('wxNow', (c.temperature_2m != null ? Math.round(c.temperature_2m) + ' ¬∞C' : '‚Äî'));
      setText('wxNowMeta', `${wxMap[c.weather_code] || '‚Äî'} ¬∑ HR ${c.relative_humidity_2m ?? '‚Äî'}%`);
    } else {
      const mm = `M√°x ${Math.round(tmax ?? NaN)}¬∞ ¬∑ M√≠n ${Math.round(tmin ?? NaN)}¬∞`;
      setText('wxNow', isFinite(tmax) && isFinite(tmin) ? mm : '‚Äî');
      setText('wxNowMeta', `HR ${Math.round(hmin ?? NaN)}%‚Äì${Math.round(hmax ?? NaN)}% ¬∑ üíß ${Math.round(pr || 0)}mm`);
    }

    // Hoy MM (siempre el del d√≠a seleccionado)
    const max0 = Math.round(tmax ?? NaN);
    const min0 = Math.round(tmin ?? NaN);
    setText('wxTodayMM', `M√°x ${isNaN(max0) ? '‚Äî' : max0}¬∞ ¬∑ M√≠n ${isNaN(min0) ? '‚Äî' : min0}¬∞ ¬∑ üåßÔ∏è ${pp == null ? '‚Äî' : Math.round(pp)}% ¬∑ üíß ${Math.round(pr || 0)}mm`);

    // Detalle
    const detail = $('wxDayDetail');
    if (detail) {
      detail.style.display = 'block';
      detail.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap">
          <div style="font-weight:900">${title}</div>
          <div class="muted">${wxDailyCache.label || ''}</div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(4,minmax(120px,1fr));gap:8px;margin-top:10px">
          <div class="loc-chip" style="justify-content:center"><b>M√°x</b>&nbsp;${isFinite(tmax) ? Math.round(tmax) + '¬∞C' : '‚Äî'}</div>
          <div class="loc-chip" style="justify-content:center"><b>M√≠n</b>&nbsp;${isFinite(tmin) ? Math.round(tmin) + '¬∞C' : '‚Äî'}</div>
          <div class="loc-chip" style="justify-content:center"><b>HR</b>&nbsp;${isFinite(hmin) && isFinite(hmax) ? `${Math.round(hmin)}‚Äì${Math.round(hmax)}%` : '‚Äî'}</div>
          <div class="loc-chip" style="justify-content:center"><b>Lluvia</b>&nbsp;${pp == null ? '‚Äî' : Math.round(pp)+'%'} ¬∑ ${Math.round(pr || 0)}mm</div>
        </div>
      `;
    }

    // Chart: resaltar d√≠a seleccionado
    if (wxWeekChart) {
      const ds = wxWeekChart.data?.datasets || [];
      ds.forEach(dset => {
        const base = 2;
        const hi = 5;
        dset.pointRadius = Array.from({ length: n }, (_, k) => (k === i ? hi : base));
      });
      wxWeekChart.update();
    }
  }


  function setWxButtonsState(state) {
    // state: 'ready' | 'input' | 'fixed'
    const open = $('btnWxOpen');
    const reset = $('btnWxReset');
    const row = $('wxInputRow');
    const content = $('wxContent');

    if (state === 'ready') {
      open.style.display = 'inline-flex';
      reset.style.display = 'none';
      row.style.display = 'none';
      content.classList.add('wx-blur');
      setText('wxWhere', 'Ubicaci√≥n no establecida');
      setText('wxNow', '‚Äî ¬∞C');
      setText('wxNowMeta', '‚Äî');
      setText('wxTodayMM', 'M√°x ‚Äî¬∞ ¬∑ M√≠n ‚Äî¬∞ ¬∑ üíß ‚Äîmm');
      $('wxTiles').innerHTML = '';
    }
    if (state === 'input') {
      open.style.display = 'none';
      reset.style.display = 'none';
      row.style.display = 'flex';
      content.classList.add('wx-blur');
      setText('wxWhere', 'Ingres√° una ubicaci√≥n');
      wxHideResults();
    }
    if (state === 'fixed') {
      open.style.display = 'none';
      reset.style.display = 'inline-flex';
      row.style.display = 'none';
      content.classList.remove('wx-blur');
    }
  }

  $('btnWxOpen').onclick = () => {
    setWxButtonsState('input');
    $('wxQuery').focus();
  };

  $('btnWxReset').onclick = () => {
    clearWxPlace();
    $('wxQuery').value = '';
    wxHideResults();
    setWxButtonsState('input');
    $('wxQuery').focus();
  };

  $('btnWxFind').onclick = () => doWxSearch();
  if ($('btnWxGeo')) $('btnWxGeo').onclick = () => doWxGeo();
  $('wxQuery').addEventListener('keydown', e => {
    if (e.key === 'Enter') doWxSearch();
    if (e.key === 'Escape') wxHideResults();
  });

  // Sugerencias mientras escribe (debounce)
  let _wxDeb = null;
  $('wxQuery').addEventListener('input', () => {
    clearTimeout(_wxDeb);
    const q = String(($('wxQuery').value || '').trim());
    if (q.length < 3) { wxHideResults(); return; }
    _wxDeb = setTimeout(() => doWxSearch({ suggest: true }), 220);
  });


  async function doWxSearch(opts = {}) {
    const q = String(($('wxQuery').value || '').trim());
    if (!q) return;

    // Caso "lat,lon" directo
    const m = q.match(/^\s*(-?\d+(?:\.\d+)?)\s*,\s*(-?\d+(?:\.\d+)?)\s*$/);
    if (m) {
      const lat = parseFloat(m[1]);
      const lon = parseFloat(m[2]);
      const label = `Lat ${lat.toFixed(2)}, Lon ${lon.toFixed(2)}`;
      wxHideResults();
      await renderWeather(lat, lon, label);
      saveWxPlace({ lat, lon, label });
      setWxButtonsState('fixed');
      return;
    }

    try {
      const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=8&language=es&format=json`;
      const r = await fetch(url, { cache: 'no-store' });
      const j = await r.json();

      const results = (j?.results || []).filter(x => Number.isFinite(x.latitude) && Number.isFinite(x.longitude));
      if (!results.length) {
        if (!opts.suggest) alert('No se encontr√≥ la ubicaci√≥n. Prob√° con ciudad, provincia, pa√≠s o ‚Äúlat,lon‚Äù.');
        wxHideResults();
        return;
      }

      // En modo sugerencia, mostramos lista; en b√∫squeda expl√≠cita, si hay 1 elegimos.
      if (opts.suggest || results.length > 1) {
        wxShowResults(results);
        if (!opts.suggest && results.length === 1) wxHideResults();
        if (!opts.suggest && results.length === 1) {
          const g = results[0];
          const parts = [g.name, g.admin1, g.country].filter(Boolean);
          const label = parts.join(', ');
          await renderWeather(g.latitude, g.longitude, label);
          saveWxPlace({ lat: g.latitude, lon: g.longitude, label });
          setWxButtonsState('fixed');
        }
        return;
      }

      const g = results[0];
      const parts = [g.name, g.admin1, g.country].filter(Boolean);
      const label = parts.join(', ');
      wxHideResults();
      await renderWeather(g.latitude, g.longitude, label);
      saveWxPlace({ lat: g.latitude, lon: g.longitude, label });
      setWxButtonsState('fixed');
    } catch (e) {
      if (!opts.suggest) alert('Error buscando ubicaci√≥n');
    }
  }

  async function doWxGeo() {
    if (!navigator.geolocation) {
      alert('Este navegador no permite geolocalizaci√≥n.');
      return;
    }
    try {
      wxHideResults();
      const loc = await new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(
          (p) => resolve(p),
          (e) => reject(e),
          { enableHighAccuracy: true, timeout: 8000, maximumAge: 600000 }
        );
      });
      const lat = loc.coords.latitude;
      const lon = loc.coords.longitude;
      const label = 'Mi ubicaci√≥n';
      await renderWeather(lat, lon, label);
      saveWxPlace({ lat, lon, label });
      setWxButtonsState('fixed');
    } catch (e) {
      alert('No se pudo obtener la ubicaci√≥n del dispositivo.');
    }
  }


  /* =========================================================
   *  MODO: Trabajo / Aire / Movimiento (botonera)
   * =======================================================*/
  function setModeSelection(mode) {
    const buttons = document.querySelectorAll('.mode-toggle button');
    const wrap = $('analysisInline');

    const cardsByMode = {
      work: $('workCard'),
      air: $('airCard'),
      motion: $('motionCard'),
      prod: $('prodCardHive'),
    };

    // Mover panels adentro de "Herramientas de an√°lisis" una sola vez
    if (wrap && !wrap.dataset.moved) {
      Object.values(cardsByMode).forEach(card => {
        if (card) wrap.appendChild(card);
      });
      wrap.dataset.moved = '1';
    }

    // Botones (estilo seleccionado)
    buttons.forEach(b => {
      const isThis = (b.dataset.mode === mode);
      b.classList.toggle('selected', isThis);
      b.setAttribute('aria-pressed', isThis ? 'true' : 'false');
    });

    // Wrapper visible solo si hay un modo activo
    if (wrap) wrap.style.display = mode ? 'block' : 'none';

    // Mostrar 1 panel a la vez
    Object.entries(cardsByMode).forEach(([m, card]) => {
      if (!card) return;
      card.style.display = (mode && m === mode) ? 'block' : 'none';
    });
  }


  /* =========================================================
   *  DOMContentLoaded: WIRING DE BOTONES
   * =======================================================*/
  document.addEventListener('DOMContentLoaded', () => {
    // Botones modo Trabajo / Aire / Movimiento
    const modeButtons = document.querySelectorAll('.mode-toggle button');
    modeButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const mode = btn.dataset.mode || null;
        const wasSelected = btn.classList.contains('selected');
        if (wasSelected) {
          setModeSelection(null);
        } else {
          setModeSelection(mode);
          if (mode === 'work' && currentOverlayDevice) {
            refreshWorkUI(currentOverlayDevice, { force: true }).catch(() => { });
          }
        }
      });
    });


    // Cartas meta del dashboard
    const cardSan = $('cardSanidad');
    const cardCal = $('cardCalendario');
    const cardNot = $('cardNotas');

    if (cardSan) {
      cardSan.addEventListener('click', (e) => {
        e.preventDefault();
        openMetaOverlay('sanidad', null);
      });
    }
    if (cardCal) {
      cardCal.addEventListener('click', (e) => {
        e.preventDefault();
        openMetaOverlay('calendario', null);
      });
    }
    if (cardNot) {
      cardNot.addEventListener('click', (e) => {
        e.preventDefault();
        openMetaOverlay('notas', null);
      });
    }

    // Tabs meta
    ['tabSanidad', 'tabCalendario', 'tabNotas'].forEach(id => {
      const btn = $(id);
      if (!btn) return;
      btn.addEventListener('click', () => {
        const mode = btn.dataset.mode || 'sanidad';
        setMetaTabs(mode);
      });
    });

    const btnMetaBack = $('btnMetaBack');
    if (btnMetaBack) {
      btnMetaBack.onclick = () => closeMetaOverlay();
    }
        // SANIDAD
    if ($('btnSanidadReload')) {
      $('btnSanidadReload').onclick = () => refreshSanidad();
    }
    if ($('btnSanidadSave')) {
      $('btnSanidadSave').onclick = () => saveSanidad();
    }

    // BARROA
    if ($('btnVarroaReload')) {
      $('btnVarroaReload').onclick = () => refreshVarroa();
    }
    if ($('btnVarroaSave')) {
      $('btnVarroaSave').onclick = () => saveVarroa();
    }
    // CALENDARIO
    if ($('btnCalReload')) {
      $('btnCalReload').onclick = () => refreshCalendario();
    }
    if ($('btnCalSave')) {
      $('btnCalSave').onclick = () => saveCalendario();
    }
    
    // Navegaci√≥n y editor calendario grande
    hookCalendarUI();
// Bot√≥n REINA en overlay de colmena
    if($('btnOverlayQueen')){
      $('btnOverlayQueen').onclick = ()=>{
        if(currentOverlayDevice){
          openQueenOverlay(currentOverlayDevice);
        }else{
          // Si por alg√∫n motivo no hay colmena activa, igual abrimos vac√≠o
          openQueenOverlay(null);
        }
      };
    }

    // Bot√≥n Volver del overlay de Reina
    if($('btnQueenBack')){
      $('btnQueenBack').onclick = ()=> closeQueenOverlay();
    }

    // Guardar nueva reina
    if($('queenSaveBtn')){
      $('queenSaveBtn').onclick = async ()=>{
        if(!queenDeviceContext){
          alert('No hay colmena seleccionada.');
          return;
        }
        const yearInput = $('queenYearInput');
        const year = Number(yearInput?.value || 0);
        if(!Number.isInteger(year) || year<1900 || year>2100){
          alert('Ingrese un a√±o v√°lido (ej. 2025).');
          return;
        }
        try{
          await queenInsert({ device_id: queenDeviceContext, year });
          // Refrescamos datos
          await loadQueenData(queenDeviceContext);
        }catch(e){
          alert('Error guardando reina: ' + (e.message||e));
        }
      };
    }

    // Actualizar historial/estado
    if($('queenReloadBtn')){
      $('queenReloadBtn').onclick = ()=>{
        if(queenDeviceContext){
          loadQueenData(queenDeviceContext);
        }
      };
    }

    // NOTAS
    if ($('btnNotesReload')) {
      $('btnNotesReload').onclick = () => refreshNotas();
    }
    if ($('btnNoteSave')) {
      $('btnNoteSave').onclick = () => saveNota();
    }

    // Bot√≥n ANOTACIONES dentro del overlay de colmena
    if ($('btnOverlayNotes')) {
      $('btnOverlayNotes').onclick = () => {
        if (currentOverlayDevice) {
          openMetaOverlay('notas', currentOverlayDevice);
        } else {
          openMetaOverlay('notas', null);
        }
      };
    }
  });

  /* =========================================================
   *  RENDER CLIMA: OPEN-METEO
   * =======================================================*/
  async function renderWeather(lat, lon, label) {
    // 7 d√≠as + humedad diaria
    const url = `https://api.open-meteo.com/v1/forecast` +
      `?latitude=${lat}&longitude=${lon}` +
      `&current=temperature_2m,relative_humidity_2m,weather_code` +
      `&daily=weather_code,temperature_2m_max,temperature_2m_min,relative_humidity_2m_max,relative_humidity_2m_min,precipitation_probability_max,precipitation_sum` +
      `&hourly=temperature_2m,relative_humidity_2m` +
      `&forecast_days=7&timezone=auto`;
    const r = await fetch(url, { cache: 'no-store' });
    const j = await r.json();
    const current = j.current || {};
    const daily = j.daily || {};

    wxDailyCache = { current, daily, label, lat, lon };

    document.getElementById('wxContent').classList.remove('wx-blur');
    setText('wxWhere', label || `Lat ${lat.toFixed(2)}, Lon ${lon.toFixed(2)}`);

    // Tiles 7 d√≠as (tocables)
    const tiles = (daily.time || []).slice(0, 7).map((d, i) => {
      const code = daily.weather_code?.[i];
      const tmax = daily.temperature_2m_max?.[i];
      const tmin = daily.temperature_2m_min?.[i];
      const hmax = daily.relative_humidity_2m_max?.[i];
      const pr = daily.precipitation_sum?.[i];
      const pp = daily.precipitation_probability_max?.[i];
      const lab = wxFmtDayLabel(d);
      return `<div class="wx-tile" data-idx="${i}" role="button" tabindex="0" aria-label="Ver ${lab}">
        <div class="wx-small">${lab}</div>
        <div style="font-size:1.25rem">${wxEmoji(code)}</div>
        <div class="wx-small">${Math.round(tmax ?? NaN)}¬∞ / ${Math.round(tmin ?? NaN)}¬∞</div>
        <div class="wx-small">HR ${Math.round(hmax ?? NaN)}%</div>
        <div class="wx-small">üåßÔ∏è ${pp == null ? "‚Äî" : Math.round(pp)}% ¬∑ üíß ${Math.round(pr || 0)}mm</div>
      </div>`;
    }).join('');
    $('wxTiles').innerHTML = tiles;

    // Click/enter para seleccionar d√≠a
    document.querySelectorAll('#wxTiles .wx-tile').forEach(el => {
      el.addEventListener('click', () => wxPickDay(el.dataset.idx));
      el.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); wxPickDay(el.dataset.idx); }
      });
    });

    // Chart semanal (Temp M√°x/M√≠n + HR M√°x/M√≠n)
    const wrap = $('wxWeekWrap');
    const canvas = $('wxWeekChart');

    if (wrap && canvas && (daily.time || []).length) {
      const labels = (daily.time || []).slice(0, 7).map(d => wxFmtDayLabel(d));
      const tMax = (daily.temperature_2m_max || []).slice(0, 7).map(v => (v == null ? null : Math.round(v)));
      const tMin = (daily.temperature_2m_min || []).slice(0, 7).map(v => (v == null ? null : Math.round(v)));
      const hMax = (daily.relative_humidity_2m_max || []).slice(0, 7).map(v => (v == null ? null : Math.round(v)));
      const hMin = (daily.relative_humidity_2m_min || []).slice(0, 7).map(v => (v == null ? null : Math.round(v)));

      if (wxWeekChart) { wxWeekChart.destroy(); wxWeekChart = null; }
      wxWeekChart = new Chart(canvas.getContext('2d'), {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'Temp M√°x (¬∞C)', data: tMax, yAxisID: 'yT', tension: .25, pointRadius: 2 },
            { label: 'Temp M√≠n (¬∞C)', data: tMin, yAxisID: 'yT', tension: .25, pointRadius: 2 },
            { label: 'HR M√°x (%)', data: hMax, yAxisID: 'yH', tension: .25, pointRadius: 2, borderDash: [5,4] },
            { label: 'HR M√≠n (%)', data: hMin, yAxisID: 'yH', tension: .25, pointRadius: 2, borderDash: [5,4] }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'nearest', intersect: false },
          plugins: {
            legend: { display: true },
            tooltip: { callbacks: { title: (it) => it[0]?.label || '' } }
          },
          scales: {
            yT: { position: 'left', title: { display: true, text: '¬∞C' } },
            yH: { position: 'right', title: { display: true, text: '%' }, grid: { drawOnChartArea: false } },
            x: { title: { display: false } }
          }
        }
      });

      wrap.style.display = 'block';
    } else {
      if (wrap) wrap.style.display = 'none';
    }

    // Por defecto: d√≠a actual
    wxPickDay(0);
    setWxButtonsState('fixed');
  }

  // ===== Fin Clima =====
</script>

</body>
</html>
