<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Panel — MIELLIFERA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="assets/logo.svg" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#0e0f12;--bg-soft:#13151a;--card:#171a21;--card-2:#1b1f27;
      --text:#eef0f3;--muted:#b8bec7;--border:#262b35;--zebra:#141820;
      --accent:#ffd54f;--accent-600:#f0c12c;--focus:#7fb3ff;
      --blue-ln:rgba(77,163,255,.45);--blue-pt:#4da3ff;
      --amber-ln:rgba(255,183,77,.55);--amber-pt:#ff7043;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Arial;font-size:16.5px;line-height:1.6}
    .site{padding:24px;max-width:1200px;margin:0 auto}
    .header{position:sticky;top:0;background:rgba(14,15,18,.9);backdrop-filter:blur(6px);z-index:10;border-bottom:1px solid var(--border)}
    .nav-grid{display:grid;grid-template-columns:1fr auto auto;gap:16px;align-items:center;padding:12px 16px}
    .brand{color:var(--accent);text-decoration:none;font-weight:800}
    .nav-center a{color:#d6dae0;text-decoration:none;margin:0 10px}
    .cta{background:var(--accent);color:#111;border:0;padding:9px 14px;border-radius:10px;cursor:pointer;font-weight:700}

    .section{margin:28px auto}
    .section.alt{background:var(--bg-soft);border:1px solid var(--border);border-radius:14px;padding:16px}
    .section-head{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
    .split{display:grid;grid-template-columns:420px 1fr;gap:18px}
    @media(max-width:860px){.split{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
    .side-cards{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media(max-width:860px){.side-cards{grid-template-columns:1fr}}

    .pill{background:var(--accent);color:#111;border:2px solid var(--accent);border-radius:999px;font-weight:800;padding:8px 14px;white-space:nowrap}
    .btn{background:var(--card-2);color:var(--text);border:1px solid var(--border);padding:10px 16px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn.yellow{background:var(--accent);border-color:var(--accent);color:#111}
    .btn.small{padding:6px 10px;font-size:.9rem}
    .center{display:flex;justify-content:center;align-items:center}

    .cards-head{display:flex;justify-content:flex-end;align-items:center;margin:12px 0 6px}
    .cards-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
    @media(max-width:860px){.cards-grid{grid-template-columns:1fr}}

    table{border-collapse:separate;border-spacing:0;width:100%;background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    thead th{position:sticky;top:0;background:var(--accent);color:#111;font-weight:800;padding:10px;border-bottom:2px solid #caa332}
    tbody td{padding:10px;border-bottom:1px solid var(--border)}
    tbody tr:nth-child(odd){background:var(--zebra)}
    #tableWrap{box-shadow:0 1px 0 rgba(0,0,0,.2) inset}

    .reveal-wrap{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .eye-btn{background:#1d212a;border:1px solid var(--border);color:#cfd6df;border-radius:8px;cursor:pointer;padding:4px 8px;display:inline-flex;align-items:center;gap:6px}
    .eye-btn svg{width:18px;height:18px}

    #deviceOverlay{position:fixed;inset:0;display:none;z-index:1000;background:rgba(8,10,14,.95);backdrop-filter:blur(4px)}
    #devicePanel{position:absolute;inset:0;display:grid;grid-template-rows:auto 1fr;max-width:1200px;margin:0 auto}
    .overlay-header{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid var(--border);background:#0f1218}
    .overlay-content{padding:16px;overflow:auto}
    .overlay-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:12px}
    @media(max-width:860px){.overlay-grid{grid-template-columns:1fr}}

    .editing .device-card{cursor:grab;animation:shake .9s ease-in-out infinite}
    @keyframes shake{0%{transform:translate(0,0)}25%{transform:translate(1px,-1px)}50%{transform:translate(-1px,1px)}75%{transform:translate(1px,0)}100%{transform:translate(0,0)}}

    .metric{display:flex;align-items:baseline;gap:10px;margin-top:6px}
    .metric .val{font-size:2.4rem;font-weight:800;letter-spacing:.3px}
    .metric .unit{font-size:1.05rem;font-weight:800;color:#111;background:var(--accent);border-radius:8px;padding:2px 8px;line-height:1.6;display:inline-block;border:2px solid var(--accent)}

    #chartsWrap{display:none;margin-top:14px}
    .chart-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
    .charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media(max-width:860px){.charts-grid{grid-template-columns:1fr}}
    .chart-box{position:relative;height:240px}
    .chart-box canvas{position:absolute;inset:0;width:100% !important;height:100% !important}
    .hist-controls{display:none;gap:8px;align-items:end;margin-top:10px;flex-wrap:wrap}
    .hist-controls input{background:#10141a;border:1px solid var(--border);color:#fff;padding:8px;border-radius:8px}
    .hist-actions{display:flex;gap:8px}

    /* Overlay charts */
    #ovChartsWrap{display:none;margin-top:12px}
  </style>
</head>
<body>
  <header class="header">
    <div class="nav-grid">
      <a class="brand" href="index.html">MIELLIFERA</a>
      <nav class="nav-center" aria-label="Principal"></nav>
      <button id="btnLogout" class="cta" type="button">Salir</button>
    </div>
  </header>

  <main class="site">
    <section class="section alt">
      <div class="section-head">
        <div>
          <h2>Tu panel</h2>
          <p class="muted">Código de vinculación, dispositivos y lecturas.</p>
        </div>
        <button id="lastReading" class="pill" type="button">Última medición: —</button>
      </div>

      <div class="split">
        <!-- Cuenta -->
        <div class="card" style="max-width:420px">
          <h3>Cuenta</h3>
          <p class="reveal-wrap">
            <span>Email: <b id="uEmail">—</b></span>
            <button id="toggleEmail" class="eye-btn" type="button" aria-pressed="false" title="Mostrar/ocultar email">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 3l18 18" stroke-width="2"/><path d="M21 12s-3.5-7-9-7" stroke-width="2"/></svg>
              <span>Ocultar</span>
            </button>
          </p>
          <p class="reveal-wrap">
            <span>Código de 4 dígitos: <b id="uCode">—</b></span>
            <button id="toggleCode" class="eye-btn" type="button" aria-pressed="false" title="Mostrar/ocultar código">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 3l18 18" stroke-width="2"/><path d="M21 12s-3.5-7-9-7" stroke-width="2"/></svg>
              <span>Ocultar</span>
            </button>
          </p>
          <div class="reveal-wrap" style="margin-top:6px">
            <button id="btnTutorials" class="btn small" type="button">Tutoriales</button>
          </div>
          <div id="msg" class="muted" style="margin-top:8px"></div>
          <hr style="border:0;border-top:1px solid var(--border)">
        </div>

        <!-- KPIs madre + gráficos -->
        <div>
          <div class="side-cards">
            <div class="card">
              <h3>Temperatura Exterior</h3>
              <div class="metric"><span id="temVal" class="val">—</span><span class="unit">°C</span></div>
              <div id="temWhen" class="muted">—</div>
            </div>
            <div class="card">
              <h3>Humedad Exterior</h3>
              <div class="metric"><span id="humVal" class="val">—</span><span class="unit">%</span></div>
              <div id="humWhen" class="muted">—</div>
            </div>
          </div>

          <div class="center" style="margin-top:14px">
            <button id="btnChart" class="btn yellow" type="button">Mostrar gráfica</button>
          </div>

          <!-- Gráficos + historial -->
          <div id="chartsWrap">
            <div class="charts-grid">
              <div class="chart-card">
                <h3 id="titleTemp" style="margin:0 0 8px">Temperatura de hoy</h3>
                <div class="chart-box"><canvas id="chartTemp"></canvas></div>
              </div>
              <div class="chart-card">
                <h3 id="titleHum" style="margin:0 0 8px">Humedad de hoy</h3>
                <div class="chart-box"><canvas id="chartHum"></canvas></div>
              </div>
            </div>

            <div class="center" style="margin-top:10px">
              <button id="btnHistory" class="btn small" type="button">Historial</button>
            </div>

            <div id="histControls" class="hist-controls">
              <div>
                <label for="dateFrom" class="muted">Desde</label><br>
                <input type="date" id="dateFrom">
              </div>
              <div>
                <label for="dateTo" class="muted">Hasta</label><br>
                <input type="date" id="dateTo">
              </div>
              <div class="hist-actions">
                <button id="btnShowRange" class="btn small" type="button">Mostrar</button>
                <button id="btnDownloadCSV" class="btn small" type="button">Descargar CSV</button>
                <button id="btnExitHistory" class="btn small" type="button" title="Volver a hoy">Volver a hoy</button>
              </div>
            </div>
          </div>

          <div class="cards-head">
            <button id="btnEdit" class="btn small" type="button" aria-pressed="false">Editar orden</button>
          </div>
          <div id="autoCards" class="cards-grid" aria-live="polite"></div>
        </div>
      </div>
    </section>

    <!-- Historial tabla -->
    <section class="section" id="lecturas">
      <div class="section-head">
        <h3>Historial de mediciones</h3>
        <button id="toggleTbl" class="btn" type="button">Mostrar / Ocultar historial de mediciones</button>
      </div>
      <div id="tableWrap" style="overflow:auto;max-height:60vh;display:none;border-radius:12px">
        <table id="tbl">
          <thead><tr><th>Fecha</th><th>Dispositivo</th><th>Sensor</th><th>Valor / Info</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer style="padding:16px;color:#c3c9d1;border-top:1px solid var(--border);display:flex;justify-content:center">
    <span>© <span id="year"></span> MIELLIFERA</span>
  </footer>

  <!-- Overlay Colmena -->
  <div id="deviceOverlay" aria-hidden="true">
    <div id="devicePanel">
      <div class="overlay-header">
        <button id="btnOverlayBack" class="btn small" type="button" title="Atrás">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" style="margin-right:6px"><path d="M15 18l-6-6 6-6" stroke-width="2"/></svg>
          Atrás
        </button>
        <h3 id="overlayTitle" style="margin:0">Colmena —</h3>
      </div>
      <div class="overlay-content">
        <!-- KPIs por colmena -->
        <div class="overlay-grid">
          <div class="card">
            <h3>Temperatura Colmena</h3>
            <div class="metric"><span id="ovTemVal" class="val">—</span><span class="unit">°C</span></div>
            <div id="ovTemWhen" class="muted">—</div>
          </div>
          <div class="card">
            <h3>Humedad Colmena</h3>
            <div class="metric"><span id="ovHumVal" class="val">—</span><span class="unit">%</span></div>
            <div id="ovHumWhen" class="muted">—</div>
          </div>
        </div>

        <div class="center" style="margin-top:8px">
          <button id="overlayBtnChart" class="btn yellow" type="button">Mostrar gráfica</button>
        </div>

        <!-- Gráficas por colmena -->
        <div id="ovChartsWrap">
          <div class="charts-grid">
            <div class="chart-card">
              <h3 id="ovTitleTemp" style="margin:0 0 8px">Temperatura de hoy</h3>
              <div class="chart-box"><canvas id="ovChartTemp"></canvas></div>
            </div>
            <div class="chart-card">
              <h3 id="ovTitleHum" style="margin:0 0 8px">Humedad de hoy</h3>
              <div class="chart-box"><canvas id="ovChartHum"></canvas></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
  // Año
  document.getElementById('year').textContent = new Date().getFullYear();

  // Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBH93vOKldh-IufVCZB1qyI6cRPoOr7iqw",
    authDomain: "mellifera-technology.firebaseapp.com",
    projectId: "mellifera-technology",
    storageBucket: "mellifera-technology.firebasestorage.app",
    messagingSenderId: "68043353319",
    appId: "1:68043353319:web:20a1aafde7b37d3457c642",
    measurementId: "G-FCW1E604DG"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();

  // Worker
  const WORKER_BASE = "https://mellifera-worker.mellifera-tech.workers.dev";
  const BASE = WORKER_BASE.replace(/\/+$/, '');
  const $ = id => document.getElementById(id);
  const setText = (id,t)=>{ const el=$(id); if(el) el.textContent=t; };

  // Estado
  let currentUID=null, editing=false;
  let chartTemp=null, chartHum=null, chartsVisible=false, lastItemsCache=null;
  let historyMode=false;
  // Overlay state
  let currentOverlayDevice=null, ovChartsVisible=false, ovChartTemp=null, ovChartHum=null;

  // Auth
  auth.onAuthStateChanged(async (u)=>{
    if(!u){ location.href = 'login.html'; return; }
    currentUID = u.uid;
    setText('uEmail', u.email || '(sin email)');
    try{
      const { code } = await callWorker('/ensure_user', { method:'POST' });
      setText('uCode', code || '—');
      await loadDatapoints();
    }catch(e){ const m=$('msg'); if(m) m.textContent="Error cargando datos: "+(e.message||e); }
  });
  $('btnLogout').onclick = ()=> auth.signOut().then(()=>location.href='login.html');
  $('btnTutorials').onclick = ()=> location.href='tutoriales.html';

  // Worker call
  async function callWorker(path, opts={}){
    const u = auth.currentUser; if(!u) throw new Error('No auth');
    const t = await u.getIdToken();
    const p = path.startsWith('/') ? path : `/${path}`;
    const res = await fetch(`${BASE}${p}`, {
      method: opts.method || 'GET',
      headers: { 'Authorization': `Bearer ${t}`, 'Content-Type': 'application/json' },
      body: opts.body ? JSON.stringify(opts.body) : undefined
    });
    if(!res.ok) throw new Error(await res.text());
    return res.json();
  }

  // Utils
  const fmt = v => (v==null||Number.isNaN(+v)) ? null : Number(v).toFixed(2);
  const dtAR = ts => new Date(ts).toLocaleString('es-AR');
  const isNumericId = id => /^\d+$/.test(id);
  function escapeHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}

  // ==== Fechas locales ====
  function toLocalDayStart(dateInput){ return new Date(dateInput+"T00:00:00").getTime(); }
  function toLocalDayEnd(dateInput){ return new Date(dateInput+"T23:59:59.999").getTime(); }
  function filterByLocalRange(items, df, dt){
    if(!df || !dt) return items||[];
    const fromT = toLocalDayStart(df), toT = toLocalDayEnd(dt);
    return (items||[]).filter(d=>{ const t=new Date(d.ts).getTime(); return t>=fromT && t<=toT; });
  }

  // === KPIs madre ===
  function updateLastReading(items){
    const el=$('lastReading');
    if(!items?.length){ el.textContent='Última medición: —'; return; }
    const latest = items.reduce((a,b)=> new Date(a.ts)>new Date(b.ts)?a:b);
    el.textContent = 'Última medición: '+ dtAR(latest.ts);
  }
  function latestBySensor(items, key){
    let best=null, bt=0, KEY=String(key).toUpperCase();
    for(const d of items||[]){
      if(String(d.sensor_key||'').toUpperCase()!==KEY) continue;
      const t=new Date(d.ts).getTime();
      if(t>bt){ best=d; bt=t; }
    }
    return best;
  }
  function updateMotherKPIs(items){
    const tem=latestBySensor(items,'MOTHER.TEM');
    setText('temVal', tem?.value!=null? fmt(tem.value):'—');
    setText('temWhen', tem? dtAR(tem.ts):'—');
    const hum=latestBySensor(items,'MOTHER.HUM');
    setText('humVal', hum?.value!=null? fmt(hum.value):'—');
    setText('humWhen', hum? dtAR(hum.ts):'—');
  }

  // === Tabla ===
  function renderTable(items){
    const tbody=document.querySelector('#tbl tbody');
    tbody.innerHTML=(items||[]).map(d=>{
      const val = String(d.sensor_key||'').startsWith('EVENT.')
        ? (d.meta?.info||d.meta?.type||JSON.stringify(d.meta||{}))
        : (d.value==null?'':fmt(d.value));
      return `<tr><td>${dtAR(d.ts)}</td><td>${escapeHtml(d.device_id||'')}</td><td>${escapeHtml(d.sensor_key||'')}</td><td>${escapeHtml(val)}</td></tr>`;
    }).join('');
  }

  // === Tarjetas de colmena ===
  function renderDeviceCards(items){
    const wrap=$('autoCards'); if(!wrap) return;
    const byId=new Map();
    for(const d of items||[]){
      const raw=String(d.device_id||'').trim();
      if(!raw || /mother/i.test(raw) || !isNumericId(raw)) continue;
      const t=new Date(d.ts).getTime();
      const prev=byId.get(raw)||0;
      if(t>prev) byId.set(raw,t);
    }
    const devices=[...byId.entries()].sort((a,b)=>b[1]-a[1]).map(([id])=>id);
    if(!devices.length){ wrap.innerHTML='<div class="muted">Sin colmenas detectadas.</div>'; return; }
    wrap.innerHTML=devices.map(id=>`
      <div class="card device-card" data-device="${id}" tabindex="0" role="button" aria-label="Abrir Colmena ${id}">
        <h3 style="margin:0">Colmena ${id}</h3>
        <p class="muted" style="margin:.25rem 0 0">Tocar para ver detalles</p>
      </div>`).join('');
    if(editing) enableDnD();
  }

  // DnD
  $('btnEdit').onclick=()=>{
    editing=!editing;
    $('btnEdit').textContent=editing?'Terminar edición':'Editar orden';
    $('autoCards').classList.toggle('editing',editing);
    if(editing) enableDnD(); else disableDnD();
  };
  function enableDnD(){
    document.querySelectorAll('.device-card').forEach(c=>{
      c.draggable=true;
      c.addEventListener('dragstart',onDragStart);
      c.addEventListener('dragover',onDragOver);
      c.addEventListener('drop',onDrop);
      c.addEventListener('dragend',onDragEnd);
    });
  }
  function disableDnD(){
    document.querySelectorAll('.device-card').forEach(c=>{
      c.draggable=false;
      c.removeEventListener('dragstart',onDragStart);
      c.removeEventListener('dragover',onDragOver);
      c.removeEventListener('drop',onDrop);
      c.removeEventListener('dragend',onDragEnd);
    });
  }
  let dragId=null;
  function onDragStart(e){ dragId=this.dataset.device; e.dataTransfer.effectAllowed='move'; this.classList.add('dragging'); }
  function onDragOver(e){ e.preventDefault(); e.dataTransfer.dropEffect='move'; }
  function onDrop(e){
    e.preventDefault();
    const target=this.dataset.device;
    if(!dragId || dragId===target) return;
    const wrap=$('autoCards');
    const a=wrap.querySelector(`.device-card[data-device="${CSS.escape(dragId)}"]`);
    const b=wrap.querySelector(`.device-card[data-device="${CSS.escape(target)}"]`);
    const aNext=a.nextSibling, bNext=b.nextSibling;
    if(aNext===b) wrap.insertBefore(b,a);
    else if(bNext===a) wrap.insertBefore(a,b);
    else { wrap.insertBefore(a,bNext); wrap.insertBefore(b,aNext); }
  }
  function onDragEnd(){ this.classList.remove('dragging'); }

  // ===== Overlay por colmena =====
  document.addEventListener('click',(e)=>{
    const card=e.target.closest('.device-card');
    if(card && !editing){ openOverlay(card.dataset.device); }
  });
  $('btnOverlayBack').onclick=closeOverlay;

  function openOverlay(id){
    currentOverlayDevice = String(id);
    setText('overlayTitle','Colmena '+id);
    const ov=$('deviceOverlay'); ov.style.display='block'; ov.setAttribute('aria-hidden','false');
    $('devicePanel').scrollTo({top:0,behavior:'instant'});
    // KPIs iniciales usando cache actual
    updateOverlayKPIs(lastItemsCache, currentOverlayDevice);
    // Ocultar charts hasta pedirlos
    ovChartsVisible=false; $('ovChartsWrap').style.display='none';
    if(ovChartTemp){ ovChartTemp.destroy(); ovChartTemp=null; }
    if(ovChartHum){ ovChartHum.destroy(); ovChartHum=null; }
  }
  function closeOverlay(){
    const ov=$('deviceOverlay'); ov.style.display='none'; ov.setAttribute('aria-hidden','true');
    currentOverlayDevice=null;
  }

  $('overlayBtnChart').onclick=async ()=>{
    if(!currentOverlayDevice) return;
    ovChartsVisible = !ovChartsVisible;
    $('overlayBtnChart').textContent = ovChartsVisible ? 'Ocultar gráfica' : 'Mostrar gráfica';
    $('ovChartsWrap').style.display = ovChartsVisible ? 'block' : 'none';
    if(ovChartsVisible){
      renderOverlayChartsDaily(lastItemsCache, currentOverlayDevice);
    }
  };

  // === Helpers para colmena: detecta TEM/HUM sin casarte con prefijos ===
  function keyIsTemp(k){
    const K=String(k||'').toUpperCase();
    if(K.startsWith('MOTHER.')) return false;
    return K.endsWith('.TEM') || K==='TEM' || K.includes('TEMP');
  }
  function keyIsHum(k){
    const K=String(k||'').toUpperCase();
    if(K.startsWith('MOTHER.')) return false;
    return K.endsWith('.HUM') || K==='HUM' || K.includes('HUM');
  }

  function latestByDevice(items, deviceId, kind){ // kind: 'TEM'|'HUM'
    let best=null, bt=0;
    for(const d of items||[]){
      if(String(d.device_id||'')!==String(deviceId)) continue;
      const ok = kind==='TEM' ? keyIsTemp(d.sensor_key) : keyIsHum(d.sensor_key);
      if(!ok) continue;
      const t=new Date(d.ts).getTime();
      if(t>bt){ best=d; bt=t; }
    }
    return best;
  }

  function updateOverlayKPIs(items, deviceId){
    const t = latestByDevice(items, deviceId, 'TEM');
    const h = latestByDevice(items, deviceId, 'HUM');
    setText('ovTemVal', t?.value!=null ? fmt(t.value) : '—');
    setText('ovTemWhen', t ? dtAR(t.ts) : '—');
    setText('ovHumVal', h?.value!=null ? fmt(h.value) : '—');
    setText('ovHumWhen', h ? dtAR(h.ts) : '—');
  }

  function buildLineChart(canvas, labels, values, lineColor, pointColor){
    const ctx=canvas.getContext('2d');
    return new Chart(ctx,{
      type:'line',
      data:{ labels, datasets:[{
        data: values,
        borderColor: lineColor,
        backgroundColor: pointColor,
        tension: .25,
        pointRadius: 3.5,
        pointHoverRadius: 5,
        pointBackgroundColor: pointColor,
        pointBorderColor: pointColor
      }]},
      options:{
        responsive:true,
        maintainAspectRatio:false,
        interaction:{mode:'nearest',intersect:false},
        plugins:{legend:{display:false},tooltip:{callbacks:{ title:(it)=>it[0]?.label||'', label:(it)=>` ${it.raw} `}}},
        scales:{x:{title:{display:true,text:'Hora'}},y:{title:{display:false},ticks:{precision:0}}}
      }
    });
  }

  function sameLocalDay(tsA, tsB){
    const a=new Date(tsA), b=new Date(tsB);
    return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
  }

  function seriesOfDayForDevice(items, deviceId, pickKind){
    const now=new Date(); const arr=[];
    for(const d of items||[]){
      if(String(d.device_id||'')!==String(deviceId)) continue;
      const ok = pickKind==='TEM' ? keyIsTemp(d.sensor_key) : keyIsHum(d.sensor_key);
      if(!ok) continue;
      if(!sameLocalDay(d.ts, now)) continue;
      const v = d.value==null || Number.isNaN(+d.value) ? null : Number(d.value);
      if(v==null) continue;
      const t=new Date(d.ts); const hh=String(t.getHours()).padStart(2,'0'); const mm=String(t.getMinutes()).padStart(2,'0');
      arr.push({label:`${hh}:${mm}`, x:t.getTime(), y:v});
    }
    arr.sort((a,b)=>a.x-b.x);
    return arr;
  }

  function renderOverlayChartsDaily(items, deviceId){
    const tem=seriesOfDayForDevice(items, deviceId, 'TEM'); const labelsT=tem.map(d=>d.label); const valsT=tem.map(d=>d.y);
    const hum=seriesOfDayForDevice(items, deviceId, 'HUM'); const labelsH=hum.map(d=>d.label); const valsH=hum.map(d=>d.y);
    if(ovChartTemp) ovChartTemp.destroy(); if(ovChartHum) ovChartHum.destroy();
    ovChartTemp=buildLineChart($('ovChartTemp'), labelsT, valsT, 'var(--amber-ln)', 'var(--amber-pt)');
    ovChartHum =buildLineChart($('ovChartHum'), labelsH, valsH, 'var(--blue-ln)', 'var(--blue-pt)');
    setText('ovTitleTemp','Temperatura de hoy');
    setText('ovTitleHum','Humedad de hoy');
  }

  // ====== Gráficos madre ======
  $('btnChart').onclick=()=>{
    chartsVisible=!chartsVisible;
    $('chartsWrap').style.display=chartsVisible?'block':'none';
    $('btnChart').textContent=chartsVisible?'Ocultar gráfica':'Mostrar gráfica';
    if(chartsVisible){
      if(historyMode){ /* no tocar */ }
      else if(lastItemsCache) renderChartsDaily(lastItemsCache);
    }
  };

  function renderChartsDaily(items){
    const tem=seriesOfDay(items,'MOTHER.TEM'); const labelsT=tem.map(d=>d.label); const valsT=tem.map(d=>d.y);
    const hum=seriesOfDay(items,'MOTHER.HUM'); const labelsH=hum.map(d=>d.label); const valsH=hum.map(d=>d.y);
    if(chartTemp) chartTemp.destroy(); if(chartHum) chartHum.destroy();
    chartTemp=buildLineChart($('chartTemp'), labelsT, valsT, 'var(--amber-ln)', 'var(--amber-pt)');
    chartHum =buildLineChart($('chartHum'), labelsH, valsH, 'var(--blue-ln)', 'var(--blue-pt)');
    setText('titleTemp','Temperatura de hoy'); setText('titleHum','Humedad de hoy');
  }
  function seriesOfDay(items, key){
    const now=new Date(); const arr=[];
    for(const d of items||[]){
      if(String(d.sensor_key||'').toUpperCase()!==key) continue;
      if(!sameLocalDay(d.ts, now)) continue;
      const v = d.value==null || Number.isNaN(+d.value) ? null : Number(d.value);
      if(v==null) continue;
      const t=new Date(d.ts); const hh=String(t.getHours()).padStart(2,'0'); const mm=String(t.getMinutes()).padStart(2,'0');
      arr.push({label:`${hh}:${mm}`, x:t.getTime(), y:v});
    }
    arr.sort((a,b)=>a.x-b.x);
    return arr;
  }

  // Historial madre
  $('btnHistory').onclick=()=>{ const c=$('histControls'); c.style.display = c.style.display==='none' || c.style.display==='' ? 'flex' : 'none'; };
  $('btnShowRange').onclick=()=>showRange();
  $('btnDownloadCSV').onclick=()=>downloadCSV();
  $('btnExitHistory').onclick=exitHistory;

  (function initDateDefaults(){
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth()+1).padStart(2,'0');
    const dd = String(today.getDate()).padStart(2,'0');
    const val = `${yyyy}-${mm}-${dd}`;
    $('dateFrom').value = val;
    $('dateTo').value   = val;
  })();

  async function fetchRange(fromISO, toISO){
    try{
      const q = `/datapoints?from=${encodeURIComponent(fromISO)}&to=${encodeURIComponent(toISO)}&limit=5000`;
      const { items } = await callWorker(q);
      return items||[];
    }catch(e){ return lastItemsCache||[]; }
  }

  function swapIfOutOfOrder(a,b){
    const ta = toLocalDayStart(a), tb = toLocalDayStart(b);
    return ta<=tb ? [a,b] : [b,a];
  }
  function normalizeDateRangeInputs(){
    let df=$('dateFrom').value, dt=$('dateTo').value;
    if(!df || !dt) return null;
    [df,dt] = swapIfOutOfOrder(df,dt);
    return { df, dt,
      fromISO: new Date(df+'T00:00:00').toISOString(),
      toISO:   new Date(dt+'T23:59:59.999').toISOString()
    };
  }

  async function showRange(){
    const r = normalizeDateRangeInputs(); if(!r) return;
    historyMode = true;
    const itemsSrv = await fetchRange(r.fromISO, r.toISO);
    const items = filterByLocalRange(itemsSrv, r.df, r.dt);

    const tem=seriesByRange(items,'MOTHER.TEM'); const labelsT=tem.map(d=>d.label); const valsT=tem.map(d=>d.y);
    const hum=seriesByRange(items,'MOTHER.HUM'); const labelsH=hum.map(d=>d.label); const valsH=hum.map(d=>d.y);
    if(chartTemp) chartTemp.destroy(); if(chartHum) chartHum.destroy();
    chartTemp=buildLineChart($('chartTemp'), labelsT, valsT, 'var(--amber-ln)', 'var(--amber-pt)');
    chartHum =buildLineChart($('chartHum'), labelsH, valsH, 'var(--blue-ln)', 'var(--blue-pt)');
    setText('titleTemp', `Temperatura ${r.df} → ${r.dt}`);
    setText('titleHum',  `Humedad ${r.df} → ${r.dt}`);
  }
  function seriesByRange(items, key){
    const arr=[];
    for(const d of items||[]){
      if(String(d.sensor_key||'').toUpperCase()!==key) continue;
      const v = d.value==null || Number.isNaN(+d.value) ? null : Number(d.value);
      if(v==null) continue;
      const t=new Date(d.ts);
      const lab = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')} ${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}`;
      arr.push({label:lab, x:t.getTime(), y:v});
    }
    arr.sort((a,b)=>a.x-b.x);
    return arr;
  }
  function exitHistory(){
    historyMode=false;
    if(chartsVisible && lastItemsCache) renderChartsDaily(lastItemsCache);
    setText('titleTemp','Temperatura de hoy');
    setText('titleHum','Humedad de hoy');
  }

  function toCSV(items, df=null, dt=null){
    const base = (df && dt) ? filterByLocalRange(items, df, dt) : (items||[]);
    const rows = [['timestamp_iso','fecha_local','hora_local','dispositivo','sensor','valor']];
    for(const d of base){
      if(!/^MOTHER\.(TEM|HUM)$/i.test(String(d.sensor_key||''))) continue;
      const ts=new Date(d.ts);
      const fecha=ts.toLocaleDateString('es-AR'); const hora=ts.toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
      rows.push([ts.toISOString(), fecha, hora, d.device_id||'', d.sensor_key||'', d.value==null?'':String(d.value)]);
    }
    return rows.map(r=>r.map(cell=>/[,;\n"]/.test(cell)? `"${String(cell).replace(/"/g,'""')}"` : cell).join(',')).join('\n');
  }
  async function downloadCSV(){
    const r = normalizeDateRangeInputs();
    let items = lastItemsCache||[];
    if(r){
      const itemsSrv = await fetchRange(r.fromISO, r.toISO);
      items = filterByLocalRange(itemsSrv, r.df, r.dt);
    }
    const csv = toCSV(items, r?.df, r?.dt);
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = r ? `miellifera_${r.df}_a_${r.dt}.csv` : 'miellifera_hoy.csv';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  // Toggle tabla
  $('toggleTbl').onclick=()=>{ const w=$('tableWrap'); w.style.display=w.style.display==='none'?'block':'none'; };

  // Carga y polling
  let polling=false;
  async function loadDatapoints(){
    if(polling) return;
    polling=true;
    try{
      const { items } = await callWorker('/datapoints?limit=200');
      lastItemsCache = items;
      renderTable(items);
      updateLastReading(items);
      updateMotherKPIs(items);
      renderDeviceCards(items);
      if(chartsVisible && !historyMode) renderChartsDaily(items);
      // Si el overlay está abierto, refrescar KPIs y gráficas del dispositivo activo
      if(currentOverlayDevice){
        updateOverlayKPIs(lastItemsCache, currentOverlayDevice);
        if(ovChartsVisible){ renderOverlayChartsDaily(lastItemsCache, currentOverlayDevice); }
      }
    }finally{
      polling=false;
    }
  }
  setInterval(()=>{ if(auth.currentUser) loadDatapoints().catch(()=>{}); }, 15000);
</script>
</body>
</html>
