<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Panel — MIELLIFERA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="assets/logo.svg" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <style>
    :root{
      --bg:#0e0f12;--bg-soft:#13151a;--card:#171a21;--card-2:#1b1f27;
      --text:#eef0f3;--muted:#b8bec7;--border:#262b35;
      --accent:#ffd54f;--accent-600:#f0c12c;--zebra:#141820;--focus:#7fb3ff;
      --danger:#ff6b6b;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Arial;font-size:16.5px;line-height:1.6;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    .site{padding:24px}
    .header{position:sticky;top:0;background:rgba(14,15,18,.9);backdrop-filter:blur(6px);z-index:10;border-bottom:1px solid var(--border)}
    .nav-grid{display:grid;grid-template-columns:1fr auto auto;gap:16px;align-items:center;padding:12px 16px}
    .brand{color:var(--accent);text-decoration:none;font-weight:800;letter-spacing:.4px}
    .nav-center a{color:#d6dae0;text-decoration:none;margin:0 10px}
    .nav-center a:hover{color:var(--text)}
    .cta{background:var(--accent);color:#111;border:0;padding:9px 14px;border-radius:10px;cursor:pointer;font-weight:700}
    .cta:focus{outline:3px solid var(--focus);outline-offset:2px}
    .section{margin:28px auto;max-width:1200px}
    .section.alt{background:var(--bg-soft);border:1px solid var(--border);border-radius:14px;padding:16px}
    .section-head{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
    h2,h3{margin:.2rem 0 .4rem;font-weight:800;letter-spacing:.2px}
    .muted{color:var(--muted)}
    .split{display:grid;grid-template-columns:420px 1fr;gap:18px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
    .card h3{margin-top:0}
    .side-cards{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;margin-top:12px}
    .pill{background:var(--accent);color:#111;border:2px solid var(--accent);border-radius:999px;font-weight:800;padding:8px 14px;cursor:default;white-space:nowrap}
    .pill[data-stale="1"]{background:#111;color:var(--accent)}
    .metric{display:flex;align-items:baseline;gap:8px}
    .metric .val{font-size:2.2rem;font-weight:800}
    .metric .unit{font-size:1.1rem;color:#111;background:var(--accent);border-radius:6px;padding:2px 6px}
    .stamp{font-size:.95rem;color:var(--muted)}
    .btn{background:var(--card-2);color:var(--text);border:1px solid var(--border);padding:10px 16px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn:hover{background:#202631}
    .btn.yellow{background:var(--accent);border-color:var(--accent);color:#111}
    .btn.yellow:hover{background:var(--accent-600)}
    .center{display:flex;justify-content:center;align-items:center}
    /* Tabla */
    table{border-collapse:separate;border-spacing:0;width:100%;background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    thead th{position:sticky;top:0;background:var(--accent);color:#111;font-weight:800;text-transform:uppercase;letter-spacing:.3px;font-size:.95rem;border-bottom:2px solid #caa332;z-index:1;padding:10px}
    tbody td{padding:10px;border-bottom:1px solid var(--border)}
    tbody tr:nth-child(odd){background:var(--zebra)}
    tbody tr.row-alert{background:linear-gradient(0deg, rgba(255,213,79,.10), rgba(255,213,79,.10))}
    #tableWrap{box-shadow:0 1px 0 rgba(0,0,0,.2) inset}
    /* Eye toggle */
    .reveal-wrap{display:flex;align-items:center;gap:8px}
    .eye-btn{background:#1d212a;border:1px solid var(--border);color:#cfd6df;border-radius:8px;cursor:pointer;padding:4px 8px;display:inline-flex;align-items:center;gap:6px}
    .eye-btn:hover{background:#232936}
    .eye-btn svg{width:18px;height:18px}
    /* Overlay full-screen */
    #deviceOverlay{position:fixed;inset:0;display:none;z-index:1000;background:rgba(8,10,14,.85)}
    #devicePanel{position:absolute;inset:0;display:grid;grid-template-rows:auto 1fr;max-width:1200px;margin:0 auto}
    .overlay-header{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid var(--border);background:#0f1218}
    .overlay-header h3{margin:0}
    .overlay-back{display:inline-flex;align-items:center;gap:8px}
    .overlay-content{padding:16px;overflow:auto}
    .overlay-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:12px}
    @media(max-width:1000px){.split{grid-template-columns:1fr}.overlay-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div id="bg-orb" aria-hidden="true"></div>

  <header id="site-header" class="header" role="banner">
    <div class="nav-grid">
      <a class="brand" href="index.html" aria-label="Inicio">MIELLIFERA</a>
      <nav class="nav-center" aria-label="Principal">
        <a href="index.html#solucion">Solución</a>
        <a href="index.html#como-funciona">Cómo funciona</a>
        <a href="index.html#hardware">Hardware</a>
        <a href="index.html#seguridad">Seguridad</a>
        <a href="index.html#faqs">FAQs</a>
        <a href="index.html#contacto">Contacto</a>
      </nav>
      <button id="btnLogout" class="cta" type="button">Salir</button>
    </div>
  </header>

  <main class="site">
    <section class="section alt">
      <div class="section-head">
        <div>
          <h2>Tu panel</h2>
          <p class="muted">Código de vinculación, dispositivos y lecturas.</p>
        </div>
        <button id="lastReading" class="pill" type="button" title="Fecha y hora de la última medición">Última medición: —</button>
      </div>

      <div class="split">
        <!-- Izquierda: Cuenta -->
        <div class="card" style="max-width:420px">
          <h3>Cuenta</h3>
          <p class="reveal-wrap">
            <span>Email: <b id="uEmail">—</b></span>
            <button id="toggleEmail" class="eye-btn" type="button" aria-pressed="false" title="Mostrar/ocultar email">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 3l18 18" stroke-width="2"/><path d="M10.58 10.58A2 2 0 0012 14a2 2 0 001.42-3.42" stroke-width="2"/><path d="M21 12s-3.5-7-9-7c-1.64 0-3.1.5-4.38 1.29M3 12s3.5 7 9 7c1.64 0 3.1-.5 4.38-1.29" stroke-width="2"/></svg>
              <span>Ocultar</span>
            </button>
          </p>
          <p class="reveal-wrap">
            <span>Código de 4 dígitos: <b id="uCode">—</b></span>
            <button id="toggleCode" class="eye-btn" type="button" aria-pressed="false" title="Mostrar/ocultar código">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 3l18 18" stroke-width="2"/><path d="M10.58 10.58A2 2 0 0012 14a2 2 0 001.42-3.42" stroke-width="2"/><path d="M21 12s-3.5-7-9-7c-1.64 0-3.1.5-4.38 1.29M3 12s3.5 7 9 7c1.64 0 3.1-.5 4.38-1.29" stroke-width="2"/></svg>
              <span>Ocultar</span>
            </button>
          </p>
          <div id="msg" class="muted" style="margin-top:8px"></div>
          <hr style="border:0;border-top:1px solid var(--border)">
        </div>

        <!-- Derecha: dos cartas -->
        <div>
          <div class="side-cards">
            <div class="card">
              <h3>Temperatura Exterior</h3>
              <div class="metric" aria-live="polite">
                <span id="temVal" class="val">—</span><span class="unit">°C</span>
              </div>
              <div id="temWhen" class="stamp">—</div>
            </div>
            <div class="card">
              <h3>Humedad Exterior</h3>
              <div class="metric" aria-live="polite">
                <span id="humVal" class="val">—</span><span class="unit">%</span>
              </div>
              <div id="humWhen" class="stamp">—</div>
            </div>
          </div>

          <!-- Botón Mostrar gráfica -->
          <div class="center" style="margin-top:14px">
            <button id="btnChart" class="btn yellow" type="button">Mostrar gráfica</button>
          </div>

          <!-- Cartas automáticas por colmena -->
          <div id="autoCards" class="cards-grid" aria-live="polite" style="margin-top:14px">
            <!-- se inyectan tarjetas Colmena #### -->
          </div>
        </div>
      </div>
    </section>

    <!-- Historial al final -->
    <section class="section" id="lecturas">
      <div class="section-head">
        <h3>Historial de mediciones</h3>
        <button id="toggleTbl" class="btn" type="button">Mostrar / Ocultar historial de mediciones</button>
      </div>
      <div id="tableWrap" style="overflow:auto;max-height:60vh;display:none;border-radius:12px">
        <table id="tbl" aria-describedby="histDesc">
          <caption id="histDesc" class="muted" style="caption-side:bottom;padding:8px">Últimas 200 entradas.</caption>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Dispositivo</th>
              <th>Sensor</th>
              <th>Valor / Info</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer class="footer" style="padding:16px;color:#c3c9d1;border-top:1px solid var(--border);display:flex;justify-content:center">
    <span>© <span id="year"></span> MIELLIFERA</span>
  </footer>

  <!-- Overlay de Colmena -->
  <div id="deviceOverlay" aria-hidden="true">
    <div id="devicePanel">
      <div class="overlay-header">
        <button id="btnOverlayBack" class="btn overlay-back" type="button" title="Atrás">
          <!-- Flecha atrás -->
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" style="margin-right:6px">
            <path d="M15 18l-6-6 6-6" stroke-width="2"/>
          </svg>
          Atrás
        </button>
        <h3 id="overlayTitle">Colmena —</h3>
      </div>
      <div class="overlay-content">
        <div class="overlay-grid">
          <div class="card"><h3>Resumen A</h3><p class="muted">Contenido a definir.</p></div>
          <div class="card"><h3>Resumen B</h3><p class="muted">Contenido a definir.</p></div>
        </div>
        <div class="center" style="margin-top:8px">
          <button id="overlayBtnChart" class="btn yellow" type="button">Mostrar gráfica</button>
        </div>
        <!-- Aquí luego se podrá agregar más detalle de la colmena -->
      </div>
    </div>
  </div>

<script>
  // Año footer
  document.getElementById('year').textContent = new Date().getFullYear();

  // --- Firebase ---
  const firebaseConfig = {
    apiKey: "AIzaSyBH93vOKldh-IufVCZB1qyI6cRPoOr7iqw",
    authDomain: "mellifera-technology.firebaseapp.com",
    projectId: "mellifera-technology",
    storageBucket: "mellifera-technology.firebasestorage.app",
    messagingSenderId: "68043353319",
    appId: "1:68043353319:web:20a1aafde7b37d3457c642",
    measurementId: "G-FCW1E604DG"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();

  // --- Worker base URL ---
  const WORKER_BASE = "https://mellifera-worker.mellifera-tech.workers.dev";
  const BASE = WORKER_BASE.replace(/\/+$/, '');

  const $ = id => document.getElementById(id);
  const setText = (id, t)=>{ const el=$(id); if(el) el.textContent=t; };

  // --- Login guard ---
  auth.onAuthStateChanged(async (u)=>{
    if(!u){ location.href = 'login.html'; return; }
    setText('uEmail', u.email || '(sin email)');
    try {
      const { code } = await callWorker('/ensure_user', { method:'POST' });
      setText('uCode', code || '—');
      await loadDatapoints();
    } catch(e){
      console.error(e);
      const m = $('msg'); if(m) m.textContent = "Error cargando datos: " + (e.message||e);
    }
  });

  $('btnLogout').onclick = ()=> auth.signOut().then(()=>location.href='login.html');

  // --- Llamadas al Worker ---
  async function callWorker(path, opts={}){
    const u = auth.currentUser; if(!u) throw new Error('No auth');
    const t = await u.getIdToken();
    const p = path.startsWith('/') ? path : `/${path}`;
    const res = await fetch(`${BASE}${p}`, {
      method: opts.method || 'GET',
      headers: { 'Authorization': `Bearer ${t}`, 'Content-Type': 'application/json' },
      body: opts.body ? JSON.stringify(opts.body) : undefined
    });
    if(!res.ok) throw new Error(await res.text());
    return res.json();
  }

  // --- Utilidades ---
  const fmt = v => (v==null||Number.isNaN(+v)) ? null : Number(v).toFixed(2);
  const dtAR = ts => new Date(ts).toLocaleString('es-AR');

  function updateLastReading(items){
    const el = $('lastReading');
    if(!items?.length){ if(el) el.textContent='Última medición: —'; return; }
    const latest = items.reduce((a,b)=> new Date(a.ts) > new Date(b.ts) ? a : b);
    const dt = dtAR(latest.ts);
    if(el) el.textContent = 'Última medición: ' + dt;
    const stale = (Date.now() - new Date(latest.ts).getTime()) > 10*60*1000;
    el?.setAttribute('data-stale', stale ? '1':'0');
    el?.setAttribute('title', stale ? 'Sin lecturas recientes (>10 min)' : 'Fecha y hora de la última medición');
  }

  function findLatestBySensor(items, key){
    if(!items?.length) return null;
    let best=null, bt=0;
    for(const d of items){
      if(String(d.sensor_key||'').toUpperCase()!==String(key).toUpperCase()) continue;
      const t = new Date(d.ts).getTime();
      if(!best || t>bt){ best=d; bt=t; }
    }
    return best;
  }

  function updateSensorCards(items){
    const tem = findLatestBySensor(items,'MOTHER.TEM');
    if(tem){ setText('temVal', fmt(tem.value) ?? '—'); setText('temWhen', dtAR(tem.ts)); }
    else { setText('temVal','—'); setText('temWhen','—'); }

    const hum = findLatestBySensor(items,'MOTHER.HUM');
    if(hum){ setText('humVal', fmt(hum.value) ?? '—'); setText('humWhen', dtAR(hum.ts)); }
    else { setText('humVal','—'); setText('humWhen','—'); }
  }

  // === Cards por colmena (device_id numérico; excluir cualquier MOTHER) ===
  function renderDeviceCards(items){
    const wrap = $('autoCards'); if(!wrap) return;

    // 1) IDs únicos válidos
    const byId = new Map(); // id -> max ts
    const isNumericId = id => /^\d+$/.test(id);
    for(const d of (items||[])){
      const raw = String(d.device_id||'').trim();
      if(!raw) continue;
      if(/mother/i.test(raw)) continue;     // excluir "MOTHER"
      if(!isNumericId(raw)) continue;       // solo números
      const t = new Date(d.ts).getTime();
      const prev = byId.get(raw) || 0;
      if(t>prev) byId.set(raw, t);
    }

    const devices = Array.from(byId.entries())
      .sort((a,b)=>b[1]-a[1])
      .map(([id])=>id);

    if(!devices.length){ wrap.innerHTML = '<div class="muted">Sin colmenas detectadas.</div>'; return; }

    // 2) Render
    const html = devices.map(id=>{
      const safe = escapeHtml(id);
      return `
        <div class="card device-card" data-device="${safe}" tabindex="0" role="button" aria-label="Abrir Colmena ${safe}">
          <h3 style="margin:0">Colmena ${safe}</h3>
          <p class="muted" style="margin:.25rem 0 0">Tocar para ver detalles</p>
        </div>
      `;
    }).join('');

    wrap.innerHTML = html;
  }

  // --- Cargar lecturas ---
  async function loadDatapoints(){
    const { items } = await callWorker('/datapoints?limit=200');

    // Tabla
    const tbody = document.querySelector('#tbl tbody');
    const rows = (items||[]).map(d=>{
      const dt = dtAR(d.ts);
      const isEvent = String(d.sensor_key||'').startsWith('EVENT.');
      const isAlert = String(d.device_id||'').toUpperCase()==='ALERT';
      const cls = isEvent || isAlert ? 'row-alert' : '';
      const val = isEvent
        ? (d.meta?.info || d.meta?.type || JSON.stringify(d.meta||{}))
        : (d.value==null ? '' : fmt(d.value));
      return `<tr class="${cls}">
        <td>${dt}</td>
        <td>${escapeHtml(d.device_id||'')}</td>
        <td>${escapeHtml(d.sensor_key||'')}</td>
        <td>${escapeHtml(val ?? '')}</td>
      </tr>`;
    }).join('');
    if(tbody) tbody.innerHTML = rows;

    // UI derivada
    updateLastReading(items);
    updateSensorCards(items);
    renderDeviceCards(items);
  }

  // Toggle historial
  $('toggleTbl').onclick = ()=>{
    const wrap = $('tableWrap');
    wrap.style.display = wrap.style.display==='none' ? 'block' : 'none';
  };

  // Botón "Mostrar gráfica" general
  $('btnChart').onclick = ()=>{ /* pendiente */ };

  // Overlay handlers
  document.addEventListener('click', (e)=>{
    const card = e.target.closest('.device-card');
    if(card){
      const id = card.getAttribute('data-device');
      openOverlay(id);
    }
  });
  $('btnOverlayBack').onclick = closeOverlay;

  function openOverlay(deviceId){
    setText('overlayTitle', 'Colmena ' + deviceId);
    const ov = $('deviceOverlay');
    ov.style.display = 'block';
    ov.setAttribute('aria-hidden','false');
    // scroll to top of overlay
    document.getElementById('devicePanel').scrollTo({top:0,behavior:'instant'});
  }
  function closeOverlay(){
    const ov = $('deviceOverlay');
    ov.style.display = 'none';
    ov.setAttribute('aria-hidden','true');
  }

  // Eye toggles
  let emailShown = true, codeShown = true, emailReal='', codeReal='';
  $('toggleEmail').onclick = ()=>{
    const el = $('uEmail');
    if(!emailReal) emailReal = el.textContent || '';
    emailShown = !emailShown;
    el.textContent = emailShown ? emailReal : mask(emailReal);
    toggleEyeButtonUI($('toggleEmail'), emailShown);
  };
  $('toggleCode').onclick = ()=>{
    const el = $('uCode');
    if(!codeReal) codeReal = el.textContent || '';
    codeShown = !codeShown;
    el.textContent = codeShown ? codeReal : mask(codeReal);
    toggleEyeButtonUI($('toggleCode'), codeShown);
  };
  function mask(s){
    if(!s) return '••••';
    const len = Math.min(4, s.length);
    return '•'.repeat(len);
  }
  function toggleEyeButtonUI(btn, visible){
    if(!btn) return;
    btn.setAttribute('aria-pressed', visible ? 'false':'true');
    btn.querySelector('span').textContent = visible ? 'Ocultar' : 'Mostrar';
  }

  // Refresco periódico
  setInterval(()=>{ if(auth.currentUser) loadDatapoints().catch(()=>{}); }, 15000);

  // Helpers
  function escapeHtml(s){
    return String(s)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }
</script>
</body>
</html>
